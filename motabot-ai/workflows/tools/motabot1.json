{
    "nodes": [
      {
        "parameters": {
          "text": "={{ $json.message || $json.chatInput || $json.incoming_message || $json.text }}\n\nðŸ”¢ PHONE: {{ $json.phone_number }}\n\nðŸ‘¤ CUSTOMER DATA (ALREADY FETCHED):\n{{ $('Get Customer by Phone HTTP').item.json[0] }}\n\nIMPORTANT: Use the customer data above to respond personally!",
          "options": {
            "systemMessage": "You are Luis, the friendly manager at Mota dispensary.\n\n## AVAILABLE VARIABLES (USE THESE!)\n\n**FROM INPUT:**\n- `chatInput`: The customer's message text\n- `phone_number`: Customer's phone number (E.164 format like +15104092760)\n- `incoming_message`: Same as chatInput (customer's message)\n- `message_id`: Unique message identifier\n- `timestamp`: When message was received\n\n**FROM HTTP CALLS (ALREADY FETCHED!):**\n- `customer_data`: Customer info from Get Customer by Phone HTTP\n  - `member_id`: Customer's unique ID (USE THIS!)\n  - `first_name`, `last_name`: Customer's name\n  - `email`: Customer's email\n  - `phone`: Customer's phone\n  - `vip_status`: VIP level\n  - `lifetime_value`: Total spent\n  - `total_visits`: Visit count\n  - `last_visited`: Last visit date\n- `transactions_data`: Recent transactions from Get Customer Transactions HTTP\n  - `transaction_id`: Transaction IDs\n  - `customer_id`: Links to member_id\n  - `date`: Transaction date\n  - `shop_location`: Store location\n  - `staff_name`: Budtender name\n  - `total_amount`: Transaction total\n  - `payment_type`: Payment method\n\n**FROM CONTEXT:**\n- `$now`: Current timestamp\n- `$today`: Today's date\n- `$vars`: Workflow variables\n- `$execution`: Execution context\n\n## CRITICAL INSTRUCTIONS\n\nðŸ”¢ **CUSTOMER DATA**: Customer info is ALREADY FETCHED! Use `customer_data` variable (member_id, first_name, last_name, etc.)\n\nðŸ“± **CUSTOMER MESSAGE**: Use `chatInput` variable to understand what they're asking\n\nðŸ’° **TRANSACTION DATA**: Recent transactions are ALREADY FETCHED! Use `transactions_data` variable\n\nâ° **TIMING**: Use `timestamp` to understand when they last contacted\n\nNEVER ask \"What's your phone number?\" - you have `phone_number`!\nIf customer not found, say: \"I don't see your number yet. What's your name?\"\n\n---\n\n## YOUR JOB\n1. Use `customer_data` (ALREADY FETCHED!) to get customer info\n2. Use `transactions_data` (ALREADY FETCHED!) to see purchase history\n3. Respond personally using their real name and data\n4. Keep responses under 150 characters (SMS limit)\n5. NO emojis (causes delivery failures)\n\n---\n\n## DATA CHAIN (FOLLOW THIS ORDER!)\n1. Get Customer by Phone (`phone_number`) â†’ Get member_id\n2. Get many rows in Supabase Transactions â†’ Filter by member_id â†’ Get transaction_id\n3. Get Transaction Items â†’ Filter by transaction_id â†’ Get product_name\n4. Get Products with Leafly Data â†’ Match product_name â†’ Get effects, flavors, descriptions\n\nThis gives you their full purchase history with product details!\n\n---\n\n## CUSTOMER TYPES\n\n**CHURN RISK** (last visit >45 days ago)\n- Acknowledge absence: \"Been a while!\"\n- Reference past favorites\n- Offer time-sensitive deal\n- Make it easy to return\n\n**VIP REGULAR** (2-4x/month, loyal)\n- Use their name + reference specifics\n- Reward loyalty proactively\n- Insider treatment\n- Make them feel valued\n\n**CASUAL** (infrequent, low spend)\n- Build relationship gradually\n- Educate on loyalty value\n- Suggest entry-level options\n- Lower barriers\n\n---\n\n## PERSONALIZATION\n- Match products to their past purchases\n- Use purchase patterns (flower vs vapes vs edibles)\n- Consider timing (weekend vs weekday shopper)\n- Reference specific strains they bought before\n- Highlight loyalty points balance\n\n---\n\n## RESPONSE FORMULA\nGreeting + Name + History Reference + Offer + Call-to-Action\n\nExample: \"Hey Marcus! Been 2 months - your usual strain just restocked. Want me to hold some?\"\n\n---\n\nRemember: Data-driven, personal, concise. Make every customer feel remembered."
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 2.2,
        "position": [
          512,
          752
        ],
        "id": "924b56f5-7ccc-4772-96a1-fbe197b0b825",
        "name": "MotaBot AI"
      },
      {
        "parameters": {
          "model": "google/gemini-2.5-pro",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
        "typeVersion": 1,
        "position": [
          0,
          976
        ],
        "id": "e17e13f3-0ac0-4bd4-8036-f76582f63037",
        "name": "OpenRouter Chat Model",
        "credentials": {
          "openRouterApi": {
            "id": "daclOezIY0qSdW4Z",
            "name": "OpenRouter account"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('To', ``, 'string') }}",
          "subject": "MoTA Rewards Points Earned!",
          "emailType": "text",
          "message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', `this is an update for a rewards program the customer has joined, we are Mota, the customer has purchased our products and sent in a photo of the receipt. We want to make sure this doesn't get stuck in a spam filter so no emojis etc, act as Luis head of rewards program for Mota\n\nHello (customername) ! Great news!\n\nYou've earned MoTa Rewards points from your recent purchase at (Last_dispensary)\n\nMoTa Products Purchased:- Total MoTa spent: $XX- Mota Points earned: 65 points, your balance is XX Points, \nYour budtender (budtenders name here) helped you with this purchase. \nThanks for choosing MoTa! Luis - MoTa Rewards Team`, 'string') }}",
          "options": {
            "appendAttribution": false,
            "senderName": "Luis - MoTA Rewards"
          }
        },
        "type": "n8n-nodes-base.gmailTool",
        "typeVersion": 2.1,
        "position": [
          256,
          960
        ],
        "id": "8a9b0c97-9666-4be5-9f3f-73e0905de733",
        "name": "Gmail",
        "webhookId": "883b3d0b-7efa-4fdf-abba-f8e325970503",
        "credentials": {
          "gmailOAuth2": {
            "id": "BvZyBEwmYVeo2pxs",
            "name": "Gmail account 2"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "transactions"
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          352,
          1088
        ],
        "id": "ab91bb37-2f9e-47ad-b389-deb0fa2ce290",
        "name": "Get many rows in Supabase Transactions",
        "description": "â­ STEP 2: Get ALL transactions, then filter by customer_id (member_id from Get Customer by Phone). Use the `member_id` variable from previous step. Returns: transaction_id, customer_id, date, shop_location, staff_name, total_amount, payment_type. USE transaction_id for next step.",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "transaction_items"
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          496,
          1200
        ],
        "id": "25d0bd16-f7bd-4e81-b3db-dd1dfce5270c",
        "name": "Get Transaction Items",
        "description": "â­ STEP 3: Get ALL transaction items, then filter by transaction_id from previous step. Use the `transaction_id` variable from Get Transactions. Returns: item_id, transaction_id, product_name, brand, category, quantity, price. USE product_name/brand to search Products.",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "customers"
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          656,
          1200
        ],
        "id": "3b7363b6-20f3-4aea-8c58-491753f8fc4a",
        "name": "Get many rows in Supabase Customers",
        "description": "Get ALL customer data from Supabase. After getting results, filter by phone number [CUSTOMER PHONE: +XXXXXXXXXXX] from the prompt to find the specific customer. Returns: member_id, first_name, last_name, email, phone, vip_status, lifetime_value, total_visits, last_visited.",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "products"
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          544,
          992
        ],
        "id": "93cf2697-b848-48b8-be04-4dbf4b808590",
        "name": "Get many rows in Supabase Products",
        "description": "â­ Search 11,515 products by NAME or STRAIN with Leafly data! Use ILIKE '%OG%' to find OG Kush (1,079 products), Blue Dream (969 products), etc. Filter by effects, medical uses, flavors, terpenes, ratings. ALWAYS include 'WHERE leafly_description IS NOT NULL' to get products with rich data!",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolCalculator",
        "typeVersion": 1,
        "position": [
          768,
          960
        ],
        "id": "fbe818c1-6240-4ea4-8289-5fee536ef133",
        "name": "Calculator"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "products"
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          896,
          976
        ],
        "id": "a2950071-e767-400b-9b66-82c5a3cb868a",
        "name": "Search MOTA Products",
        "description": "Get MOTA products from inventory. Use this to search for products by name, strain, brand, or category. Filter results yourself after getting them. Returns: product_name, brand, category, strain, thc_content, cbd_content, price, description, effects, flavors, helps_with (medical uses), leafly_rating.",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "customers",
          "filters": {
            "conditions": [
              {
                "keyName": "phone",
                "keyValue": "={{ $fromAI('phone_number', '', 'string') }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          1040,
          1104
        ],
        "id": "847d3bf2-4092-4312-823c-9f01db3c8e15",
        "name": "Get Customer by Phone",
        "description": "â­ STEP 1: Find customer by phone number. Use the `phone_number` variable from input (+15104092760) and pass it as parameter 'phone_number'. Returns ONE customer with member_id (UUID) - YOU NEED THIS for transactions!",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "products"
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          1152,
          960
        ],
        "id": "409d71a4-00b2-4a63-9333-5f90756ced97",
        "name": "Get Products with Leafly Data",
        "description": "â­ STEP 4: Get products with Leafly data (11,515 items). Match product_name from transaction_items. Use the `product_name` variable from Get Transaction Items. Returns: effects (Relaxed, Energetic), helps_with (Anxiety, Pain), flavors (Citrus, Pine), terpenes, leafly_description, rating. Use this to reference what they bought!",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chatTrigger",
        "typeVersion": 1.3,
        "position": [
          -432,
          736
        ],
        "id": "2b06e6b6-587b-486b-88a7-abb3b99a7514",
        "name": "When chat message received",
        "webhookId": "c4ae2e47-48ce-4d28-b164-9e9d419a11bf"
      },
      {
        "parameters": {
          "jsCode": "// Manual phone number input for testing\n// You can edit this node to set any phone number you want to test with\nconst phoneNumber = '+15104092760'; // CHANGE THIS TO TEST DIFFERENT CUSTOMERS\n\n// Get the message from the chat trigger\n// ChatTrigger provides the message in different formats depending on context\nconst testMessage = $input.item.json.message || \n                   $input.item.json.chatInput || \n                   $input.item.json.incoming_message || \n                   $input.item.json.text || \n                   'Hello, what are my points?';\n\nreturn {\n  json: {\n    message: testMessage,\n    phone_number: phoneNumber,\n    incoming_message: testMessage,\n    message_id: 'test_' + Date.now(),\n    timestamp: new Date().toISOString()\n  }\n};"
        },
        "id": "be0bdbfe-b944-4057-96fc-74519a945782",
        "name": "Manual Phone Number Input",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -208,
          720
        ]
      },
      {
        "parameters": {
          "url": "=https://kiwmwoqrguyrcpjytgte.supabase.co/rest/v1/customers?phone=eq.{{ encodeURIComponent($json.phone_number) }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "apikey",
                "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE5NzQ4NzMsImV4cCI6MjA0NzU1MDg3M30.7QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8"
              },
              {
                "name": "Authorization",
                "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE5NzQ4NzMsImV4cCI6MjA0NzU1MDg3M30.7QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8QJ8"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          48,
          736
        ],
        "id": "046e1c0d-03ee-4484-94b7-213e8f3389bf",
        "name": "Get Customer by Phone HTTP",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Normalize incoming message to chatInput so the Agent always finds it.\nconst src = $input.item?.json || {};\nconst chatInput = src.message || src.chatInput || src.incoming_message || src.text || '';\nreturn { json: { ...src, chatInput } };"
        },
        "id": "0f7f1d3d-8f5a-4c9a-9d44-3c8e5d9b0c11",
        "name": "Normalize Chat Input",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          656,
          224
        ],
        "settings": { "runOnceForAllItems": false }
      },
      {
        "parameters": {
          "jsCode": "// Current message from upstream\nconst msg = $input.item?.json || {};\n\n// Customer data from the HTTP node (robust across run modes)\nlet cust = {};\ntry {\n  const custItems = $items('Get Customer by Phone HTTP', 0, 0); // items array\n  const first = Array.isArray(custItems) ? custItems[0] : custItems;\n  cust = first?.json || {};\n} catch (e) {\n  cust = {};\n}\n\n// Derive first/last from name if needed\nconst splitName = (name) => {\n  const parts = String(name || '').trim().split(/\\s+/);\n  return { first: parts[0] || '', last: parts.slice(1).join(' ') || '' };\n};\nconst derived = splitName(cust.name);\nconst first = cust.first_name || cust.first || derived.first;\nconst last  = cust.last_name  || cust.last  || derived.last;\nconst fullName = (cust.name || [first, last].filter(Boolean).join(' ').trim()).trim();\n\n// Pull key metrics\nconst summary = {\n  loyalty_points: cust.loyalty_points ?? null,\n  total_visits: Number(cust.total_visits) || 0,\n  last_visited: cust.last_visited || null,\n  lifetime_value: Number(cust.lifetime_value) || 0,\n  churn_risk: cust.churn_risk || null,\n  state: cust.state || null,\n  zip_code: cust.zip_code || null\n};\n\n// Compact context string\nconst aiContext = [\n  fullName ? `Customer: ${fullName}` : null,\n  (msg.phone_number || cust.phone) ? `Phone: ${msg.phone_number || cust.phone}` : null,\n  `Visits: ${summary.total_visits}`,\n  summary.loyalty_points != null ? `Points: ${summary.loyalty_points}` : null,\n  summary.last_visited ? `Last visited: ${summary.last_visited}` : null,\n  summary.lifetime_value ? `Lifetime spend: $${summary.lifetime_value}` : null,\n  summary.churn_risk ? `Churn risk: ${summary.churn_risk}` : null\n].filter(Boolean).join(' | ');\n\nreturn {\n  json: {\n    message: msg.incoming_message || msg.chatInput || '',\n    phone: msg.phone_number || cust.phone || '',\n    message_id: msg.message_id,\n    timestamp: msg.timestamp,\n    conversation_messages: msg.all_messages || [],\n\n    custid: cust.member_id || cust.id || cust.customer_id || '',\n    name: fullName,\n    first, last,\n    email: cust.email || '',\n\n    loyalty_points: summary.loyalty_points,\n    total_visits: summary.total_visits,\n    last_visited: summary.last_visited,\n    lifetime_value: summary.lifetime_value,\n    churn_risk: summary.churn_risk,\n    location: { state: summary.state, zip_code: summary.zip_code },\n\n    transactions: [],\n    transactions_count: 0,\n\n    ai_context: aiContext,\n    customer_raw: cust,\n    customer_found: !!Object.keys(cust).length\n  }\n};"
        },
        "id": "7b7cdf5e-204f-4c45-b2eb-9858291ea7d0",
        "name": "Format For AI",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          256,
          736
        ],
        "notesInFlow": true,
        "alwaysOutputData": false,
        "retryOnFail": false,
        "maxTries": 1,
        "settings": {
          "runOnceForAllItems": false
        }
      },
      {
        "parameters": {
          "sessionKey": "={{ $json.phone_number }}"
        },
        "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
        "typeVersion": 1.3,
        "position": [
          128,
          992
        ],
        "id": "c5ed3933-6c98-4eac-9e52-268d46efc121",
        "name": "Simple Memory"
      }
    ],
    "connections": {
      "OpenRouter Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Gmail": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get many rows in Supabase Transactions": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get Transaction Items": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get many rows in Supabase Customers": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get many rows in Supabase Products": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Calculator": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Search MOTA Products": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get Customer by Phone": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get Products with Leafly Data": {
        "ai_tool": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "When chat message received": {
        "main": [
          [
            {
              "node": "Manual Phone Number Input",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Manual Phone Number Input": {
        "main": [
          [
            {
              "node": "Get Customer by Phone HTTP",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Customer by Phone HTTP": {
        "main": [
          [
            {
              "node": "Normalize Chat Input",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Normalize Chat Input": {
        "main": [
          [
            {
              "node": "Format For AI",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format For AI": {
        "main": [
          [
            {
              "node": "MotaBot AI",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Simple Memory": {
        "ai_memory": [
          [
            {
              "node": "MotaBot AI",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      }
    },
    "pinData": {},
    "meta": {
      "instanceId": "daf1db1234fdfcbbfb53be5e1fe26764ab505fd0554977269bee03ef4bae6464"
    }
  }