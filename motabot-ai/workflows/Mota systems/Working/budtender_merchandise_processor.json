{
    "nodes": [
      {
        "parameters": {
          "promptType": "define",
          "text": "=You are **Budtender Merchandise Processor**, an AI agent that processes budtender merchandise submissions.\n\nYou receive one JSON object per execution (it follows after this text).\n\n{{ JSON.stringify($json, null, 2) }}\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nðŸ“‹ Tasks\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n1. Parse the JSON to get budtender submission data\n2. Extract budtender information: first_name, last_name, phone, email, dispensary_name\n3. Clean and format the data for Supabase insertion\n4. Add the budtender to the Supabase budtenders table\n5. Send confirmation email to the budtender\n6. Send SMS confirmation to the budtender (if phone number provided)\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nðŸ”§ Tools you can call\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ **Add Budtender to Database** (Supabase) - Insert new budtender record\nâ€¢ **Gmail** (send confirmation email) - DISABLED FOR TESTING\nâ€¢ **Send SMS** (Supabase) - DISABLED FOR TESTING\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nðŸ§­ MANDATORY Flow\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nA. **Process Budtender Data**:\n   1. Extract and clean: first_name, last_name, phone, email, dispensary_name\n   2. Format phone number to +1XXXXXXXXXX format if needed\n   3. Clean email (lowercase, validate format)\n   4. Clean dispensary_name (standardize case, remove extra spaces)\n\nB. **Database Operations**:\n   1. Use \"Add Budtender to Database\" tool with cleaned data:\n      - first_name: cleaned first name\n      - last_name: cleaned last name  \n      - phone: formatted phone number\n      - email: cleaned email\n      - dispensary_name: cleaned store name\n      - points: 500 (new budtender starts with 500 points)\n\nC. **Communication** (DISABLED FOR TESTING):\n   1. SKIP Gmail â†’ Do NOT send welcome email during testing\n   2. SKIP Send SMS â†’ Do NOT send SMS during testing\n   3. Focus only on database insertion for now\n   4. Do not add any final text response\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâš ï¸ CRITICAL NOTES\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ ALWAYS clean and format data before database insertion\nâ€¢ Standardize dispensary names (e.g., \"Flavors\" not \"flavors\", \"Blue Fire\" not \"blue fire\")\nâ€¢ Format phone numbers consistently (+1XXXXXXXXXX)\nâ€¢ Validate email format before using\nâ€¢ Start all new budtenders with 500 points\nâ€¢ Only send SMS if phone number is provided and valid\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nðŸ“± FINAL NOTES\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ You MUST use the \"Send SMS\" tool to send messages (do NOT just respond with SMS text)\nâ€¢ Send SMS to budtender using their formatted phone number\nâ€¢ After all tools succeed, do NOT add any final text response",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          1248,
          32
        ],
        "id": "d8638ac1-2b40-4986-bc6f-b4e9eed6a753",
        "name": "Budtender Merchandise Processor"
      },
      {
        "parameters": {
          "model": "anthropic/claude-3.5-haiku",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
        "typeVersion": 1,
        "position": [
          1344,
          320
        ],
        "id": "832cd1d9-0f00-4375-9c96-b50c022cc8b0",
        "name": "OpenRouter Chat Model",
        "credentials": {
          "openRouterApi": {
            "id": "daclOezIY0qSdW4Z",
            "name": "OpenRouter account"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('To', ``, 'string') }}",
          "subject": "Welcome to MoTA Budtender Merchandise Program!",
          "emailType": "text",
          "message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', `Welcome to the MoTA Budtender Merchandise Program!\n\nHello [BudtenderName]!\n\nThank you for your interest in MoTA merchandise! We've received your submission and added you to our budtender database.\n\nYour Details:\n- Name: [FirstName] [LastName]\n- Store: [DispensaryName]\n- Email: [Email]\n- Phone: [Phone]\n\nWhat's Next:\n- You'll receive updates about new merchandise\n- Special budtender discounts and promotions\n- Early access to new products\n\nIf you have any questions, please reply to this email.\n\nThanks for being part of the MoTA team!\n\nLuis - MoTA Merchandise Team`, 'string') }}",
          "options": {
            "appendAttribution": false,
            "senderName": "Luis - MoTA Merchandise"
          }
        },
        "type": "n8n-nodes-base.gmailTool",
        "typeVersion": 2.1,
        "position": [
          1856,
          208
        ],
        "id": "26372358-a6f7-4063-aec0-8ea25eed67ac",
        "name": "Gmail",
        "webhookId": "db24d03d-5054-4c8c-84b2-465ee1907e90",
        "credentials": {
          "gmailOAuth2": {
            "id": "BvZyBEwmYVeo2pxs",
            "name": "Gmail account 2"
          }
        }
      },
      {
        "parameters": {
          "operation": "insert",
          "tableId": "budtenders",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "first_name",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "last_name",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "phone",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "email",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues3_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "dispensary_name",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues4_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "points",
                "fieldValue": "500"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          1520,
          368
        ],
        "id": "fee3fa75-8655-45d2-91de-1e15823c1ca8",
        "name": "Add Budtender to Database",
        "description": "Insert new budtender record into Supabase budtenders table.",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "pollTimes": {
            "item": [
              {
                "mode": "everyMinute"
              }
            ]
          },
          "documentId": {
            "__rl": true,
            "value": "1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE",
            "mode": "list",
            "cachedResultName": "MOTA Merchandise BT Info SHEET 2 (Responses)",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 56312248,
            "mode": "list",
            "cachedResultName": "n8nRawSubmissions",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE/edit#gid=56312248"
          },
          "event": "rowAdded",
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheetsTrigger",
        "typeVersion": 1,
        "position": [
          80,
          -16
        ],
        "id": "03f1e225-c0fd-414a-9226-b46b5fb1edad",
        "name": "Google Sheets Trigger",
        "credentials": {
          "googleSheetsTriggerOAuth2Api": {
            "id": "0Qkts3KNsqNFs46d",
            "name": "Google Sheets Trigger account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Format and clean budtender submission data\nconst data = $input.item.json;\n\n// Extract fields from Google Sheets format\nconst timestamp = data['Timestamp'] || '';\nconst firstName = (data['First Name'] || '').trim().replace(/[^a-zA-Z\\s-']/g, '');\nconst lastName = (data['Last Name'] || '').trim().replace(/[^a-zA-Z\\s-']/g, '');\nconst streetAddress = (data['Street Address'] || '').trim();\nconst addressLine2 = (data['Address Line #2 (optional)'] || '').trim();\nconst city = (data['City'] || '').trim();\nconst state = (data['State'] || '').trim();\nconst zipCode = String(data['Zip Code'] || '').trim();\nconst phoneNumber = data['Phone Number'] || '';\nconst email = (data['Email'] || '').trim().toLowerCase();\nconst affiliation = (data['Affiliation (Store Name)'] || '').trim();\nconst tshirtSize = (data['T-Shirt Size'] || '').trim();\nconst frontLogoDesign = (data['Front Logo Design'] || '').trim();\nconst backLogoDesign = (data['Back Logo Design'] || '').trim();\nconst motaProducts = (data['MOTA PRODUCTS IN WHICH IM INTERESTED'] || '').trim();\nconst notes = (data['NOTES'] || '').trim();\n\n// Format phone number properly\nlet formattedPhone = phoneNumber.replace(/\\D/g, ''); // Remove all non-numeric characters\n\n// Only add +1 if it's a 10-digit US number\nif (formattedPhone.length === 10) {\n  formattedPhone = '+1' + formattedPhone;\n} else if (formattedPhone.length === 11 && formattedPhone.startsWith('1')) {\n  formattedPhone = '+' + formattedPhone;\n} else if (formattedPhone.length > 0 && !formattedPhone.startsWith('+')) {\n  formattedPhone = '+' + formattedPhone;\n}\n\n// Keep original phone number if formatting fails\nif (!formattedPhone || formattedPhone.length < 10) {\n  formattedPhone = phoneNumber;\n}\n\n// Validate email\nlet cleanEmail = email;\nif (email && !email.includes('@')) {\n  console.log('Invalid email format:', email);\n  cleanEmail = '';\n}\n\n// Clean and standardize dispensary name\nlet cleanDispensaryName = affiliation;\nif (affiliation) {\n  // Standardize common dispensary names\n  const dispensaryMap = {\n    'flavors': 'Flavors',\n    'flavorssc': 'FlavorsSC',\n    'blue fire': 'Blue Fire',\n    'bluefire': 'Blue Fire',\n    'firehouse': 'Firehouse',\n    'phenos': 'Phenos',\n    'pcf': 'PCF',\n    'club w': 'Club W',\n    'clubw': 'Club W',\n    'catalyst': 'Catalyst',\n    'catalyst pomona': 'Catalyst Pomona',\n    'higher level': 'Higher Level',\n    'x1': 'X1',\n    'toasty': 'Toasty',\n    'dr. greenthumb': 'Dr. Greenthumb',\n    'dr greenthumb': 'Dr. Greenthumb',\n    'oakland': 'Oakland'\n  };\n  \n  const lowerAffiliation = affiliation.toLowerCase().trim();\n  if (dispensaryMap[lowerAffiliation]) {\n    cleanDispensaryName = dispensaryMap[lowerAffiliation];\n  } else {\n    // Capitalize first letter of each word\n    cleanDispensaryName = affiliation.split(' ').map(word => \n      word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()\n    ).join(' ');\n  }\n}\n\nreturn {\n  json: {\n    // Core budtender data for database\n    firstName: firstName,\n    lastName: lastName,\n    phoneNumber: formattedPhone,\n    email: cleanEmail,\n    dispensaryName: cleanDispensaryName,\n    \n    // Additional submission data\n    timestamp: timestamp,\n    streetAddress: streetAddress,\n    addressLine2: addressLine2,\n    city: city,\n    state: state,\n    zipCode: zipCode,\n    tshirtSize: tshirtSize,\n    frontLogoDesign: frontLogoDesign,\n    backLogoDesign: backLogoDesign,\n    motaProducts: motaProducts,\n    notes: notes,\n    \n    // Keep original data for reference\n    originalPhone: phoneNumber,\n    originalEmail: email,\n    originalAffiliation: affiliation,\n    \n    // Debug info\n    _debug: {\n      hasFirstName: !!firstName,\n      hasLastName: !!lastName,\n      hasPhone: !!phoneNumber,\n      hasEmail: !!email,\n      hasAffiliation: !!affiliation,\n      allKeys: Object.keys(data)\n    }\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          864,
          32
        ],
        "id": "534e6d7a-1483-4172-a77d-7dea6f59f5ef",
        "name": "Format Budtender Data"
      },
      {
        "parameters": {
          "tableId": "messages",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "phone_number",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "content",
                "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', ``, 'string') }}"
              },
              {
                "fieldId": "status",
                "fieldValue": "queued"
              },
              {
                "fieldId": "direction",
                "fieldValue": "outbound"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabaseTool",
        "typeVersion": 1,
        "position": [
          1680,
          336
        ],
        "id": "a906870b-e567-405e-bfd3-532cd60270fb",
        "name": "Send SMS",
        "description": "Queue an SMS message to be sent. Provide phone_number in +1XXXXXXXXXX format and message content (under 150 chars).",
        "credentials": {
          "supabaseApi": {
            "id": "hwJ1to3Ot0D92Bo5",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "append",
          "documentId": {
            "__rl": true,
            "value": "1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE",
            "mode": "list",
            "cachedResultName": "MOTA Merchandise BT Info SHEET 2 (Responses)",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1651391034,
            "mode": "list",
            "cachedResultName": "n8nProcessed",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE/edit#gid=1651391034"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Timestamp": "={{ $json.timestamp }}",
              "First Name": "={{ $json.firstName }}",
              "Last Name": "={{ $json.lastName }}",
              "Street Address": "={{ $json.streetAddress }}",
              "Address Line #2 (optional)": "={{ $json.addressLine2 }}",
              "City": "={{ $json.city }}",
              "State": "={{ $json.state }}",
              "Zip Code": "={{ $json.zipCode }}",
              "Phone Number": "={{ $json.phoneNumber }}",
              "Email": "={{ $json.email }}",
              "Affiliation (Store Name)": "={{ $json.dispensaryName }}",
              "T-Shirt Size": "={{ $json.tshirtSize }}",
              "Front Logo Design": "={{ $json.frontLogoDesign }}",
              "Back Logo Design": "={{ $json.backLogoDesign }}",
              "MOTA PRODUCTS IN WHICH IM INTERESTED": "={{ $json.motaProducts }}",
              "NOTES": "={{ $json.notes }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "Timestamp",
                "displayName": "Timestamp",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "First Name",
                "displayName": "First Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Last Name",
                "displayName": "Last Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Street Address",
                "displayName": "Street Address",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Address Line #2 (optional)",
                "displayName": "Address Line #2 (optional)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "City",
                "displayName": "City",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "State",
                "displayName": "State",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Zip Code",
                "displayName": "Zip Code",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Email",
                "displayName": "Email",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Affiliation (Store Name)",
                "displayName": "Affiliation (Store Name)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "T-Shirt Size",
                "displayName": "T-Shirt Size",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Front Logo Design",
                "displayName": "Front Logo Design",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Back Logo Design",
                "displayName": "Back Logo Design",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "MOTA PRODUCTS IN WHICH IM INTERESTED",
                "displayName": "MOTA PRODUCTS IN WHICH IM INTERESTED",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "NOTES",
                "displayName": "NOTES",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.6,
        "position": [
          336,
          -32
        ],
        "id": "0aec37ca-c919-4552-9080-af0cfbd982e7",
        "name": "Move to Processed",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "LSu2bHJie7HlsZRT",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "delete",
          "documentId": {
            "__rl": true,
            "value": "1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE",
            "mode": "list",
            "cachedResultName": "MOTA Merchandise BT Info SHEET 2 (Responses)",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 56312248,
            "mode": "list",
            "cachedResultName": "n8nRawSubmissions",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vVycIHgRM93b0926ciDB8vw1kmRKXTQlU2-ddueDAaE/edit#gid=56312248"
          },
          "startIndex": "={{ $json.row_number || 2 }}"
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.6,
        "position": [
          608,
          -32
        ],
        "id": "6b83d098-3bfa-4d5e-a55a-6a4bea16447d",
        "name": "Delete from Raw",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "LSu2bHJie7HlsZRT",
            "name": "Google Sheets account"
          }
        }
      }
    ],
    "connections": {
      "OpenRouter Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "Budtender Merchandise Processor",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Gmail": {
        "ai_tool": [
          []
        ]
      },
      "Add Budtender to Database": {
        "ai_tool": [
          [
            {
              "node": "Budtender Merchandise Processor",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Google Sheets Trigger": {
        "main": [
          [
            {
              "node": "Format Budtender Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format Budtender Data": {
        "main": [
          [
            {
              "node": "Budtender Merchandise Processor",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Budtender Merchandise Processor": {
        "main": [
          [
            {
              "node": "Move to Processed",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Move to Processed": {
        "main": [
          [
            {
              "node": "Delete from Raw",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send SMS": {
        "ai_tool": [
          []
        ]
      }
    },
    "pinData": {},
    "meta": {
      "instanceId": "daf1db1234fdfcbbfb53be5e1fe26764ab505fd0554977269bee03ef4bae6464"
    }
  }