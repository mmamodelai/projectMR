# MotaBot v5.300 - Complete Build Guide üî®

## ‚ö° Quick Build (15 minutes)

Follow these steps **exactly** to build the database query agent in n8n.

---

## üìã **Step 1: Create Base Workflow**

1. Open n8n
2. Click **"Add workflow"**
3. Name it: `MotaBot v5.300 - Database Query Agent`

---

## üìã **Step 2: Add Trigger & Message Fetching (Same as before)**

### **Node 1: Schedule Trigger**
- Type: **Schedule Trigger**
- Name: `Poll Every 1min`
- Interval: **Every 1 minute**

### **Node 2: Get Recent Messages**
- Type: **HTTP Request**
- Name: `Get Recent Messages`
- Method: **GET**
- URL: `https://kiwmwoqrguyrcpjytgte.supabase.co/rest/v1/messages?select=*&order=timestamp.desc&limit=50`
- **Headers:**
  - `apikey`: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0`
  - `Authorization`: `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0`
  - `Accept`: `application/json`

### **Node 3: Filter Unread Messages**
- Type: **Code**
- Name: `Filter Unread Messages`
- Code:
```javascript
// Filter for unread inbound messages only
const messages = $input.all().map(item => item.json);
const unreadInbound = messages.filter(msg => 
  msg.direction === 'inbound' && msg.status === 'unread'
);

if (unreadInbound.length === 0) { 
  return []; 
}

return unreadInbound.map(msg => ({
  json: {
    message_id: msg.id,
    phone_number: msg.phone_number,
    incoming_message: msg.content,
    timestamp: msg.timestamp
  }
}));
```

### **Node 4: Prepare for AI**
- Type: **Code**
- Name: `Prepare for AI`
- Code:
```javascript
// v5.300: Simplified - AI uses tools for data lookup
const currentMessage = $input.item.json;
const phoneNumber = currentMessage.phone_number;
const incomingMessage = currentMessage.incoming_message;
const messageId = currentMessage.message_id;

const supabaseUrl = 'https://kiwmwoqrguyrcpjytgte.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0';

// Fetch conversation history (still useful for context)
let history = [];
try {
  const url = `${supabaseUrl}/rest/v1/messages?select=*&phone_number=eq.${phoneNumber}&order=timestamp.desc&limit=20`;
  const response = await fetch(url, {
    method: 'GET',
    headers: {
      'apikey': supabaseKey,
      'Authorization': `Bearer ${supabaseKey}`,
      'Accept': 'application/json'
    }
  });
  
  if (response.ok) {
    history = await response.json();
  }
} catch (error) {
  console.log('Could not fetch history:', error);
}

// Build simple context
let conversation = 'CONVERSATION HISTORY:\n\n';
if (history.length > 0) {
  history.reverse().forEach(msg => {
    const timestamp = new Date(msg.timestamp).toLocaleString();
    const role = msg.direction === 'inbound' ? 'Customer' : 'You';
    conversation += `[${timestamp}] ${role}: ${msg.content}\n\n`;
  });
}

conversation += '\nCURRENT MESSAGE (use your tools to answer):\n';
conversation += `Customer: ${incomingMessage}\n`;
conversation += `Phone: ${phoneNumber}`;

return {
  json: {
    chatInput: conversation,
    phone_number: phoneNumber,
    message_id: messageId
  }
};
```

---

## üîß **Step 3: Create the 4 AI Tools**

### **IMPORTANT: Tool Configuration in n8n**

For each tool below:
1. Add a **Code** node
2. Set the name as specified
3. Click **"Add Tool"** mode (if available) OR just use regular Code node
4. Paste the code

The AI Agent will automatically detect these as tools if they're connected to it.

---

### **Tool 1: Get Customer Transactions**

**Node Name:** `Tool: Get Transactions`
**Type:** Code
**Code:**
```javascript
// TOOL 1: Get Customer Transactions
const phoneNumber = $input.item.json.phoneNumber || $input.item.json.phone_number;
const limit = $input.item.json.limit || 10;

const supabaseUrl = 'https://kiwmwoqrguyrcpjytgte.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0';

try {
  // Get customer by phone
  const custResp = await fetch(
    `${supabaseUrl}/rest/v1/customers?phone=eq.${encodeURIComponent(phoneNumber)}&select=member_id,name&limit=1`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`,
        'Accept': 'application/json'
      }
    }
  );
  
  const customers = await custResp.json();
  if (!customers || customers.length === 0) {
    return { json: { error: 'Customer not found', transactions: [] } };
  }
  
  const memberId = customers[0].member_id;
  
  // Get transactions
  const txnResp = await fetch(
    `${supabaseUrl}/rest/v1/transactions?customer_id=eq.${memberId}&select=*&order=date.desc&limit=${Math.min(limit, 50)}`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`,
        'Accept': 'application/json'
      }
    }
  );
  
  const transactions = await txnResp.json();
  
  return {
    json: {
      customer_name: customers[0].name,
      member_id: memberId,
      total_transactions: transactions.length,
      transactions: transactions.map(t => ({
        transaction_id: t.transaction_id,
        date: t.date,
        location: t.shop_location,
        staff: t.staff_name,
        total: t.total_amount,
        payment: t.payment_type,
        points_earned: t.loyalty_points_earned
      }))
    }
  };
} catch (error) {
  return { json: { error: error.message, transactions: [] } };
}
```

---

### **Tool 2: Get Transaction Items**

**Node Name:** `Tool: Get Items`
**Type:** Code
**Code:**
```javascript
// TOOL 2: Get Transaction Items
const transactionId = $input.item.json.transactionId || $input.item.json.transaction_id;

const supabaseUrl = 'https://kiwmwoqrguyrcpjytgte.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0';

try {
  // Get transaction items
  const itemsResp = await fetch(
    `${supabaseUrl}/rest/v1/transaction_items?transaction_id=eq.${transactionId}&select=*`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`,
        'Accept': 'application/json'
      }
    }
  );
  
  const items = await itemsResp.json();
  
  // Get product details for each item
  const productIds = [...new Set(items.map(i => i.product_id).filter(Boolean))];
  
  let products = {};
  if (productIds.length > 0) {
    const prodResp = await fetch(
      `${supabaseUrl}/rest/v1/products?id=in.(${productIds.join(',')})&select=id,name,brand,category,strain_type,thc_content,cbd_content`,
      {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Accept': 'application/json'
        }
      }
    );
    
    const prodList = await prodResp.json();
    products = Object.fromEntries(prodList.map(p => [p.id, p]));
  }
  
  return {
    json: {
      transaction_id: transactionId,
      total_items: items.length,
      items: items.map(item => {
        const product = products[item.product_id] || {};
        return {
          product_name: item.product_name || product.name || 'Unknown',
          brand: product.brand,
          category: product.category,
          strain_type: product.strain_type,
          thc: product.thc_content,
          cbd: product.cbd_content,
          quantity: item.quantity,
          price: item.price,
          total: item.total
        };
      })
    }
  };
} catch (error) {
  return { json: { error: error.message, items: [] } };
}
```

---

### **Tool 3: Search Products Purchased**

**Node Name:** `Tool: Search Products`
**Type:** Code
**Code:**
```javascript
// TOOL 3: Search Products Purchased
const phoneNumber = $input.item.json.phoneNumber || $input.item.json.phone_number;
const searchTerm = $input.item.json.searchTerm || $input.item.json.search_term || '';

const supabaseUrl = 'https://kiwmwoqrguyrcpjytgte.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0';

try {
  // Get customer
  const custResp = await fetch(
    `${supabaseUrl}/rest/v1/customers?phone=eq.${encodeURIComponent(phoneNumber)}&select=member_id&limit=1`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`
      }
    }
  );
  
  const customers = await custResp.json();
  if (!customers || customers.length === 0) {
    return { json: { error: 'Customer not found', products: [] } };
  }
  
  const memberId = customers[0].member_id;
  
  // Get transactions to get transaction IDs
  const txnResp = await fetch(
    `${supabaseUrl}/rest/v1/transactions?customer_id=eq.${memberId}&select=transaction_id`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`
      }
    }
  );
  
  const transactions = await txnResp.json();
  const txnIds = transactions.map(t => t.transaction_id);
  
  if (txnIds.length === 0) {
    return { json: { products: [] } };
  }
  
  // Get transaction items for those transactions
  const itemsResp = await fetch(
    `${supabaseUrl}/rest/v1/transaction_items?transaction_id=in.(${txnIds.join(',')})&select=product_name,quantity,price`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`
      }
    }
  );
  
  let items = await itemsResp.json();
  
  // Filter by search term if provided
  if (searchTerm) {
    const search = searchTerm.toLowerCase();
    items = items.filter(i => 
      (i.product_name || '').toLowerCase().includes(search)
    );
  }
  
  // Aggregate by product name
  const productMap = {};
  for (const item of items) {
    const name = item.product_name || 'Unknown';
    if (!productMap[name]) {
      productMap[name] = {
        product_name: name,
        times_purchased: 0,
        total_quantity: 0,
        total_spent: 0
      };
    }
    productMap[name].times_purchased += 1;
    productMap[name].total_quantity += item.quantity || 1;
    productMap[name].total_spent += parseFloat(item.price || 0);
  }
  
  const products = Object.values(productMap).sort((a, b) => b.times_purchased - a.times_purchased);
  
  return {
    json: {
      total_unique_products: products.length,
      products: products.slice(0, 20) // Top 20
    }
  };
} catch (error) {
  return { json: { error: error.message, products: [] } };
}
```

---

### **Tool 4: Calculate Spending**

**Node Name:** `Tool: Calculate Spending`
**Type:** Code
**Code:**
```javascript
// TOOL 4: Calculate Customer Spending
const phoneNumber = $input.item.json.phoneNumber || $input.item.json.phone_number;
const startDate = $input.item.json.startDate || $input.item.json.start_date || '2000-01-01';
const endDate = $input.item.json.endDate || $input.item.json.end_date || '2099-12-31';

const supabaseUrl = 'https://kiwmwoqrguyrcpjytgte.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0';

try {
  // Get customer
  const custResp = await fetch(
    `${supabaseUrl}/rest/v1/customers?phone=eq.${encodeURIComponent(phoneNumber)}&select=member_id,name,lifetime_value,total_visits&limit=1`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`
      }
    }
  );
  
  const customers = await custResp.json();
  if (!customers || customers.length === 0) {
    return { json: { error: 'Customer not found' } };
  }
  
  const customer = customers[0];
  
  // Get transactions in date range
  const txnResp = await fetch(
    `${supabaseUrl}/rest/v1/transactions?customer_id=eq.${customer.member_id}&date=gte.${startDate}&date=lte.${endDate}&select=total_amount,date,shop_location`,
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`
      }
    }
  );
  
  const transactions = await txnResp.json();
  
  const totalSpent = transactions.reduce((sum, t) => sum + parseFloat(t.total_amount || 0), 0);
  const avgTransaction = transactions.length > 0 ? totalSpent / transactions.length : 0;
  
  // Group by location
  const byLocation = {};
  for (const txn of transactions) {
    const loc = txn.shop_location || 'Unknown';
    if (!byLocation[loc]) {
      byLocation[loc] = { location: loc, visits: 0, spent: 0 };
    }
    byLocation[loc].visits += 1;
    byLocation[loc].spent += parseFloat(txn.total_amount || 0);
  }
  
  return {
    json: {
      customer_name: customer.name,
      date_range: { start: startDate, end: endDate },
      transactions_in_period: transactions.length,
      total_spent_in_period: Math.round(totalSpent * 100) / 100,
      average_transaction: Math.round(avgTransaction * 100) / 100,
      lifetime_total: customer.lifetime_value,
      lifetime_visits: customer.total_visits,
      spending_by_location: Object.values(byLocation)
    }
  };
} catch (error) {
  return { json: { error: error.message } };
}
```

---

## ü§ñ **Step 4: Add AI Agent**

Unfortunately, **I cannot create a complete AI Agent JSON** because n8n's AI Agent requires internal configuration that varies by version.

**Instead, you need to:**

1. **Add AI Agent node** in n8n
2. **Connect all 4 tool nodes** to the AI Agent (they should appear as available tools)
3. **Set the system message** (copy below)
4. **Connect OpenRouter Chat Model**

### **System Message for AI Agent:**
```
You are MotaBot v5.300 - Mota Rewards AI assistant with FULL DATABASE ACCESS.

You can answer questions about customer purchase history, transactions, spending, and products using your database query tools.

**AVAILABLE TOOLS:**

1. **Tool: Get Transactions** - Look up transaction history by phone number
2. **Tool: Get Items** - See what items were purchased in a specific transaction  
3. **Tool: Search Products** - Find what products a customer has bought
4. **Tool: Calculate Spending** - Calculate total spending with date filters

**WHEN TO USE TOOLS:**

Customer asks: "What did I buy last time?"
‚Üí Use "Tool: Get Transactions" to find recent transactions
‚Üí Then use "Tool: Get Items" to see what items were in that transaction

Customer asks: "How much have I spent this year?"
‚Üí Use "Tool: Calculate Spending" with date range 2025-01-01 to 2025-12-31

Customer asks: "Have I bought [product] before?"
‚Üí Use "Tool: Search Products" with the product name

Customer asks: "Show me my last 5 purchases"
‚Üí Use "Tool: Get Transactions" with limit=5

**YOUR PERSONALITY:**

- Friendly and helpful
- Use customer's first name
- Keep responses under 150 characters for SMS
- Be conversational and natural
- DO NOT use emojis (they cause SMS failures)

**WHAT YOU CAN SHARE:**

‚úÖ Customer's own data:
- Their name, visit count, lifetime value
- Their transaction history and dates
- Products they've purchased
- Spending totals and averages
- Staff members who helped them
- Locations they've visited

‚ùå DO NOT share:
- Other customers' information
- Real-time inventory counts
- Staff schedules
- Unverified product pricing

**EXAMPLE CONVERSATIONS:**

Customer: "What did I buy last time?"
You: "On Oct 9th you got Blue Dream 3.5g, LA Kush Cake vape, and a pre-roll. Total was $53. Want to get the same again?"

Customer: "How much have I spent this year?"
You: "You've spent $140.76 across 3 visits this year! Your average is $46.92 per visit."

Customer: "Have I tried Gorilla Glue before?"
You: "Yes! You bought Gorilla Glue #4 twice - once in March and again in July. You seem to like it!"

Customer: "Show me my history"
You: "Your last 10 visits: Oct 9 ($53), Sept 22 ($87), Aug 15 ($42)... Want me to email your full history?"

**BE SMART:**

- If customer asks about "last time" or "recent", query transactions
- If they ask "have I bought", search products
- If they want totals or spending, use calculate tool
- Always use the phone number from the incoming message context

**IMPORTANT:**

You have REAL database tools now! Use them to give ACCURATE answers with REAL data!

When you use a tool, explain what you found in a natural way. Don't say "I queried the database" - just give them the info like you already knew it.

Example:
‚ùå "I searched the database and found..."
‚úÖ "You bought Blue Dream on Oct 9th for $53!"
```

---

## üìã **Step 5: Add Response Handling (Same as before)**

### **Node: Prepare SMS Response**
- Type: **Code**
- Name: `Prepare SMS Response`
- Code:
```javascript
// Prepare SMS response from AI
const aiOutput = $input.item.json;
const phoneNumber = $('Prepare for AI').item.json.phone_number;
const messageId = $('Prepare for AI').item.json.message_id;

let message = '';

// Extract text from AI response
if (typeof aiOutput.output === 'string') {
  message = aiOutput.output;
} else if (aiOutput.text) {
  message = aiOutput.text;
} else if (aiOutput.response) {
  message = aiOutput.response;
} else {
  message = JSON.stringify(aiOutput);
}

// Sanitize for SMS
message = message
  .replace(/[\r\n]+/g, ' ')
  .replace(/[""]/g, '"')
  .replace(/['']/g, "'")
  .replace(/[‚Äì‚Äî]/g, '-')
  .replace(/‚Ä¶/g, '...')
  .replace(/[^\x20-\x7E]/g, '')
  .replace(/\s+/g, ' ')
  .trim();

return {
  json: {
    phone_number: phoneNumber,
    message: message,
    message_id: messageId
  }
};
```

### **Node: Split Into Chunks**
- Type: **Code**
- Name: `Split Into Chunks`
- Code:
```javascript
// Split into SMS chunks (<=150 chars)
const prepare = $input.item.json;
let text = prepare.message || '';
const limit = 150;
const chunks = [];

while (text.length > 0) {
  if (text.length <= limit) { 
    chunks.push(text); 
    break; 
  }
  let i = text.lastIndexOf(' ', limit);
  if (i === -1) i = limit;
  chunks.push(text.slice(0, i).trim());
  text = text.slice(i).trim();
}

return chunks.map((chunk, index) => ({ 
  json: { 
    phone_number: prepare.phone_number, 
    content: chunk,
    chunk_index: index,
    total_chunks: chunks.length,
    delay_ms: index * 750,
    message_id: prepare.message_id
  } 
}));
```

### **Node: Delay By Index**
- Type: **Code**
- Name: `Delay By Index`
- Code:
```javascript
// Progressive delay for multi-chunk messages
const delayMs = $input.item.json.delay_ms || 0;
if (delayMs > 0) {
  await new Promise(r => setTimeout(r, delayMs));
}
return $input.item;
```

### **Node: Send SMS**
- Type: **HTTP Request**
- Name: `Send SMS`
- Method: **POST**
- URL: `http://localhost:5000/send`
- Body:
  - `phone`: `={{ $json.phone_number }}`
  - `message`: `={{ $json.content }}`

### **Node: Mark Message as Read**
- Type: **HTTP Request**
- Name: `Mark Message as Read`
- Method: **PATCH**
- URL: `=https://kiwmwoqrguyrcpjytgte.supabase.co/rest/v1/messages?id=eq.{{ $('Prepare for AI').item.json.message_id }}`
- **Headers:**
  - `apikey`: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0`
  - `Authorization`: `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0`
  - `Content-Type`: `application/json`
  - `Prefer`: `return=minimal`
- Body:
  - `status`: `read`

---

## ‚úÖ **Step 6: Connect Everything**

```
[Poll] ‚Üí [Get Messages] ‚Üí [Filter] ‚Üí [Prepare] ‚Üí [AI Agent] ‚Üí [Prepare Response] ‚Üí [Split] ‚Üí [Delay] ‚Üí [Send] ‚Üí [Mark Read]
                                           ‚Üë
                                    [Tool 1] [Tool 2] [Tool 3] [Tool 4]
                                           ‚Üë
                                   [OpenRouter Model]
```

---

## üéâ **Done!**

Now test with:
- "What did I buy last time?"
- "How much have I spent?"
- "Have I bought Blue Dream before?"

The AI will use the tools to fetch real data! üîç

