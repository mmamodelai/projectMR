<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MoTa Admin Intelligence</title>
    <meta name="theme-color" content="#0f172a" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%231c2541'/><stop offset='100%' stop-color='%230b1220'/></linearGradient></defs><rect width='100' height='100' rx='18' ry='18' fill='url(%23g)'/><text x='50' y='68' font-size='64' text-anchor='middle'>ðŸ“Š</text></svg>"
    />
      <style>
        :root {
         --bg: #1a1410;
         --panel: #2a1f1a;
         --panel-light: #3d2e26;
         --border: #4a3830;
         --muted: #a89584;
         --text: #f5ede4;
         --text-dim: #d4c4b0;
         --accent: #c87533;
         --accent-hover: #d88a4a;
         --accent-light: #f4e4d7;
         --success: #5d8a3a;
         --danger: #c44536;
         --warn: #e8a547;
        }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        height: 100%;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Helvetica Neue", Arial, "Noto Sans";
        overflow-y: auto;
        overflow-x: hidden;
      }
      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Header with Logo */
        header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 20px;
          background: linear-gradient(135deg, #2a1f1a 0%, #1a1410 100%);
          border-bottom: 2px solid var(--accent);
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        header h1 {
          margin: 0;
          font-size: 18px;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 12px;
          color: var(--accent-light);
        }
        .logo {
          height: 36px;
          width: 36px;
          border-radius: 8px;
          object-fit: cover;
          border: 2px solid var(--accent);
          background: #fff;
          box-shadow: 0 2px 6px rgba(200,117,51,0.3);
        }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
        .btn {
          background: var(--panel-light);
          color: var(--text);
          border: 1px solid var(--border);
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 600;
          font-size: 13px;
          transition: all 0.2s;
        }
        .btn:hover {
          background: var(--accent);
          color: var(--bg);
          border-color: var(--accent-hover);
        }
        .btn.primary {
          background: var(--accent);
          border-color: var(--accent);
          color: var(--bg);
        }
        .btn.primary:hover {
          background: var(--accent-hover);
        }
        .btn.accent {
          background: var(--accent);
          border-color: var(--accent);
          color: var(--bg);
        }
        .btn.accent:hover {
          background: var(--accent-hover);
        }
        .chip {
          background: var(--panel);
          border: 1px solid var(--border);
          border-radius: 999px;
          padding: 4px 12px;
          color: var(--muted);
          font-size: 12px;
          font-weight: 500;
        }

        /* Tabs */
        .tabs {
          display: flex;
          gap: 6px;
          padding: 10px 16px;
          border-bottom: 2px solid var(--border);
          background: var(--panel);
        }
        .tab {
          padding: 10px 18px;
          border-radius: 6px;
          cursor: pointer;
          color: var(--muted);
          user-select: none;
          font-weight: 600;
          font-size: 14px;
          transition: all 0.2s;
        }
        .tab:hover {
          color: var(--accent-light);
        }
        .tab.active {
          background: var(--accent);
          color: var(--bg);
          box-shadow: 0 2px 4px rgba(200,117,51,0.3);
        }
        
        /* Pulse animation for new messages indicator */
        @keyframes pulse-glow {
          0% {
            box-shadow: 0 0 0 0 rgba(232, 165, 71, 0.7);
          }
          50% {
            box-shadow: 0 0 12px 4px rgba(232, 165, 71, 0.5);
          }
          100% {
            box-shadow: 0 0 0 0 rgba(232, 165, 71, 0.7);
          }
        }
        .tab.has-new-messages {
          animation: pulse-glow 1.5s ease-in-out infinite;
          position: relative;
        }
        .tab.has-new-messages::after {
          content: "";
          position: absolute;
          top: 6px;
          right: 6px;
          width: 8px;
          height: 8px;
          background: var(--danger);
          border-radius: 50%;
          animation: pulse-dot 1s ease-in-out infinite;
        }
        @keyframes pulse-dot {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.3); opacity: 0.7; }
        }

      /* Main container */
      main {
        display: flex;
        gap: 0;
        padding: 0;
        height: calc(100vh - 80px);
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
      }

      /* Default 3-panel layout for budtenders and overview */
      #budtendersMainView,
      #overviewMainView {
        display: flex;
        width: 100%;
      }

        .panel {
          background: var(--panel);
          border-right: 1px solid var(--border);
          padding: 18px;
          overflow: visible;
        }
      .left {
        width: 480px;
        min-width: 320px;
        max-width: 800px;
        position: relative;
      }
        .center {
          flex: 1 1 auto;
          border-left: 1px solid var(--border);
          border-right: 1px solid var(--border);
        }
      .right {
        width: 480px;
        min-width: 320px;
        max-width: 900px;
        position: relative;
      }

      /* 4-panel grid layout for customers tab */
      .layout-4panel {
        display: grid;
        grid-template-columns: var(--cust-list-width, 280px) 1fr;
        grid-template-rows: var(--cust-txitems-height, auto) 1fr;
        gap: 12px;
        height: calc(100vh - 140px);
        padding: 16px 20px;
      }
        .layout-4panel .panel {
          background: var(--panel);
          border: 1px solid var(--border);
          border-radius: 10px;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          padding: 0;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
      .left-col {
        grid-column: 1;
        grid-row: 1 / 3;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .right-top {
        grid-column: 2;
        grid-row: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        max-height: 280px;
        transition: max-height 0.3s ease;
      }
      .right-bottom {
        grid-column: 2;
        grid-row: 2;
        display: flex;
        flex-direction: row;
        gap: 12px;
        overflow: hidden;
      }

      .panel-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: auto;
        min-height: 0;
      }
      .scrollable {
        max-height: 100%;
        overflow-y: auto;
        overflow-x: auto;
        width: 100%;
      }

      /* Resize Handle */
      .resize-handle {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 6px;
        cursor: col-resize;
        z-index: 100;
        transition: background 0.2s;
      }
      .resize-handle:hover,
      .resize-handle.dragging {
        background: var(--accent);
      }
      .resize-handle.left-handle {
        right: -3px;
      }
      .resize-handle.right-handle {
        left: -3px;
      }

      .title {
        font-weight: 700;
        font-size: 14px;
        color: var(--accent-light);
        margin-bottom: 14px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 8px;
      }
      .list {
        overflow: auto;
        flex: 1;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
      }
      .terminal {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 14px;
        overflow: auto;
        font-size: 13px;
        line-height: 1.6;
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
        text-align: left;
      }
      th {
        position: sticky;
        top: 0;
        background: var(--panel);
        color: var(--accent-light);
        font-weight: 700;
        z-index: 10;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--accent);
      }
      tr:hover td {
        background: var(--panel-light);
      }
      tr.clickable {
        cursor: pointer;
        transition: background 0.2s;
      }
      .nowrap {
        white-space: nowrap;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      /* Pills & Badges */
      .pill {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .pill.vip {
        background: var(--warn);
        color: var(--bg);
      }
      .pill.medical {
        background: var(--success);
        color: #fff;
      }
      .pill.active {
        background: var(--success);
        color: #fff;
      }
      .pill.inactive {
        background: var(--danger);
        color: #fff;
      }
      .pill.churn {
        background: var(--warn);
        color: var(--bg);
      }

      /* Layout Helpers */
      .hstack {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .vstack {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      input[type="text"],
      input[type="search"],
      select {
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px 12px;
        width: 100%;
        font-size: 13px;
        transition: border-color 0.2s;
      }
      input[type="text"]:focus,
      input[type="search"]:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
      }
      .search-box {
        margin-bottom: 12px;
      }

      /* Metrics & Stats */
      .stat-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .stat-card .label {
        color: var(--muted);
        font-size: 11px;
        text-transform: uppercase;
        margin-bottom: 6px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
      }
      .stat-card .subtext {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px;
        margin-bottom: 22px;
      }
      .metric-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }
      .metric-box .metric-label {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        margin-bottom: 6px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .metric-box .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--muted);
      }
      .section {
        margin-bottom: 24px;
      }

      /* Recommendations */
      .recommendations {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        margin-top: 22px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }
      .recommendations .rec-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--accent-light);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 8px;
      }
      .recommendations .rec-item {
        padding: 12px 14px;
        margin-bottom: 10px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.6;
      }
      .recommendations .rec-item strong {
        color: var(--accent);
      }

      /* Product List */
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 13px;
        transition: all 0.2s;
      }
      .product-item:hover {
        border-color: var(--accent);
        background: var(--panel);
      }
      .product-item .product-name {
        flex: 1;
        font-weight: 600;
        color: var(--text);
      }
      .product-item .product-stats {
        display: flex;
        gap: 12px;
        align-items: center;
        font-weight: 700;
        color: var(--text-dim);
      }

      /* Analytics Navigation */
      .analytics-nav {
        display: flex;
        gap: 6px;
        margin-bottom: 18px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 10px;
      }
      .analytics-nav-item {
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        transition: all 0.2s;
      }
      .analytics-nav-item:hover {
        background: var(--panel-light);
        color: var(--text-dim);
      }
      .analytics-nav-item.active {
        background: var(--accent);
        color: var(--bg);
        box-shadow: 0 2px 4px rgba(200,117,51,0.3);
      }

      .filter-bar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .filter-bar select,
      .filter-bar input {
        flex: 1;
        min-width: 150px;
      }

      /* Chart Containers */
      .chart-container {
        position: relative;
        height: 200px;
        margin: 18px 0;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }
      .chart-container.large {
        height: 300px;
      }

      /* Collapsible sections */
      .collapsible-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: var(--panel);
        color: var(--text);
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        border-bottom: 1px solid var(--border);
        user-select: none;
        transition: background 0.2s;
      }
      .collapsible-header:hover {
        background: var(--panel-light);
      }
      .toggle-icon {
        transition: transform 0.2s;
        display: inline-block;
        color: var(--accent);
      }
      .toggle-icon.collapsed {
        transform: rotate(-90deg);
      }
      .collapsible-body {
        display: none;
        overflow-y: auto;
        flex: 1;
      }
      .collapsible-body.expanded {
        display: block;
      }

      /* Compact list for collapsed items/transactions */
      .compact-list {
        font-size: 13px;
        padding: 4px 0;
      }
      .compact-list.items-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        padding: 8px;
      }
      .compact-item {
        padding: 8px 14px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
      }
      .compact-item:hover {
        background: var(--panel-light);
      }
      .compact-list.items-grid .compact-item {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        font-size: 12px;
        background: var(--bg);
        transition: all 0.2s;
      }
      .compact-list.items-grid .compact-item:hover {
        background: var(--panel);
        border-color: var(--accent);
      }
      .compact-item.selected {
        background: var(--panel-light);
        border-color: var(--accent);
      }

      /* Panel title for suggested messages tab */
      .panel-title {
        padding: 12px 14px;
        background: var(--panel);
        color: var(--accent);
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border);
      }
      
      /* Resize controls for columns */
      .resize-controls {
        display: flex;
        gap: 2px;
        margin-left: auto;
      }
      .resize-btn {
        width: 20px;
        height: 20px;
        background: var(--panel-light);
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 10px;
        font-weight: bold;
        transition: all 0.15s;
        padding: 0;
      }
      .resize-btn:hover {
        background: var(--accent);
        color: var(--bg);
        border-color: var(--accent-hover);
      }
      .resize-btn:active {
        transform: scale(0.95);
      }
      .panel-title-resizable {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      /* Message item styling for suggested tab */
      .sug-msg-item {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }
      .sug-msg-item:hover {
        background: var(--panel-light);
      }
      .sug-msg-item.selected {
        background: var(--panel-light);
        border-left-color: var(--accent);
      }
      .sug-msg-item .msg-name {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 4px;
        color: var(--text);
      }
      .sug-msg-item .msg-tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        margin-right: 6px;
      }
      .sug-msg-item .msg-tag.sug { background: var(--warn); color: var(--bg); }
      .sug-msg-item .msg-tag.apr { background: var(--success); color: #fff; }
      .sug-msg-item .msg-tag.sent { background: var(--accent); color: var(--bg); }
      .sug-msg-item .msg-preview {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.4;
        margin-top: 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Messages tab: 3-column layout */
      .msg-layout-3col {
        display: flex;
        height: calc(100vh - 140px);
        overflow: hidden;
        width: 100%;
      }
      .msg-convos-col {
        width: 320px;
        flex: 0 0 320px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .msg-thread-col {
        flex: 1 1 500px;
        min-width: 400px;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .msg-card-col {
        width: 380px;
        flex: 0 0 380px;
        background: var(--panel);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .msg-convo-item {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.15s;
      }
      .msg-convo-item:hover {
        background: var(--bg);
      }
      .msg-convo-item.active {
        background: var(--accent);
        color: var(--bg);
      }
      .msg-convo-item.active .muted {
        color: var(--bg);
        opacity: 0.8;
      }
      .msg-convo-item .convo-phone {
        font-weight: 700;
        font-size: 13px;
      }
      .msg-convo-item .convo-name {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }
      .msg-convo-item .convo-preview {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .msg-convo-item .convo-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 4px;
        font-size: 10px;
      }
      .msg-convo-item .convo-time {
        color: var(--muted);
      }
      .msg-convo-item .convo-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 9px;
        font-weight: 700;
      }
      .msg-convo-item .convo-badge.unread {
        background: var(--danger);
        color: white;
      }
      .msg-convo-item .convo-badge.inbox {
        background: var(--warn);
        color: var(--bg);
      }
      .msg-bubble {
        max-width: 75%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 13px;
        line-height: 1.4;
        word-break: break-word;
      }
      .msg-bubble.inbound {
        background: var(--panel);
        border: 1px solid var(--border);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }
      .msg-bubble.outbound {
        background: var(--accent);
        color: var(--bg);
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .msg-bubble .bubble-time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }
      .msg-bubble .bubble-status {
        font-size: 9px;
        opacity: 0.6;
        margin-left: 6px;
      }
      .msg-filter-btn.active {
        background: var(--accent);
        color: var(--bg);
      }

      /* 4-column layout: Queue | Card | Analytics | Messages */
      .sug-layout-4col {
        display: flex;
        height: calc(100vh - 185px);
        overflow: hidden;
        width: 100%;
      }
      .sug-queue-col {
        width: 220px;
        flex: 0 0 220px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .sug-card-col {
        flex: 0 0 425px;
        min-width: 350px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .sug-analytics-col {
        flex: 0 0 300px;
        min-width: 250px;
        background: var(--panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .sug-message-col {
        flex: 0 0 500px;
        min-width: 400px;
        background: var(--panel);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Compact message items for wider queue */
      .sug-msg-item-compact {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.15s;
        border-left: 3px solid transparent;
      }
      .sug-msg-item-compact:hover {
        background: var(--panel-light);
      }
      .sug-msg-item-compact.selected {
        background: var(--panel-light);
        border-left-color: var(--accent);
      }
      .sug-msg-item-compact .msg-name {
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text);
      }
      .sug-msg-item-compact .msg-meta {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 4px;
      }
      .sug-msg-item-compact .msg-tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
      }
      .sug-msg-item-compact .msg-tag.sug { background: var(--warn); color: var(--bg); }
      .sug-msg-item-compact .msg-tag.apr { background: var(--success); color: #fff; }
      .sug-msg-item-compact .msg-tag.sent { background: var(--accent); color: var(--bg); }
      .sug-msg-item-compact .msg-tag.campaign { 
        background: var(--panel-light); 
        color: var(--muted); 
        font-weight: 600;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .sug-msg-item-compact .msg-preview {
        font-size: 11px;
        color: var(--text-dim);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Conversation bubble styles */
      .conv-bubble {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 10px;
        font-size: 14px;
        font-weight: 500;
        line-height: 1.5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }
      .conv-bubble.inbound {
        background: var(--panel-light);
        border: 2px solid var(--border);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }
      .conv-bubble.outbound {
        background: var(--accent);
        color: var(--bg);
        align-self: flex-end;
        border-bottom-right-radius: 4px;
        font-weight: 600;
      }
      .conv-bubble .conv-time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }

      /* Analytics column sections */
      .sug-card-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-bottom: 1px solid var(--border);
        min-height: 0;
      }
      .sug-card-content {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
      }
      .sug-analytics-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
      }
      .sug-analytics-content {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
      }

      /* Terminal text for baseball card and analytics */
      .terminal-text {
        margin: 0;
        padding: 12px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
          "Liberation Mono", monospace;
        font-size: 12px;
        color: var(--text);
        line-height: 1.5;
      }
      /* Animations */
      @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); border-color: rgba(239, 68, 68, 0.7); color: #ef4444; }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); border-color: rgba(239, 68, 68, 0); color: #ef4444; }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: rgba(239, 68, 68, 0); color: #ef4444; }
      }
      .update-available {
        animation: pulse-red 2s infinite;
        border-color: #ef4444 !important;
        color: #ef4444 !important;
        font-weight: bold;
      }
    </style>
    <script>
      const SUPABASE_URL = "https://kiwmwoqrguyrcpjytgte.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0";

      function triggerUpdate() {
        if(confirm("Update Admin System?\n\nThis will reload the application and fetch the latest version from the server.")) {
          window.location.reload();
        }
      }

      // --- Auto-Update Logic ---
      const GITHUB_PAYLOAD_URL = "https://raw.githubusercontent.com/mmamodelai/projectMR/main/resource_pack_02.dat";
      const APP_LOAD_TIME = new Date();

      async function checkForUpdates() {
          try {
              // Fetch HEAD to get Last-Modified with cache buster
              const response = await fetch(GITHUB_PAYLOAD_URL + "?t=" + Date.now(), { method: 'HEAD', cache: "no-store" });
              const lastModifiedHeader = response.headers.get('Last-Modified');
              
              if (lastModifiedHeader) {
                  const serverTime = new Date(lastModifiedHeader);
                  // If server file is newer than our load time (with 2 min buffer)
                  if (serverTime > new Date(APP_LOAD_TIME.getTime() + 120000)) {
                      const btn = document.getElementById('updateBtn');
                      if (btn) {
                          btn.classList.add('update-available');
                          btn.innerHTML = "â¬‡ Update Available";
                          btn.title = "New version detected! Click to reload.";
                          // Pulse animation defined in CSS
                      }
                  }
              }
          } catch (e) {
              console.warn("Update check failed:", e);
          }
      }
      
      // Check every 60 minutes
      setInterval(checkForUpdates, 60 * 60 * 1000);
      // Initial check after 10 seconds
      setTimeout(checkForUpdates, 10000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <img src="Public/cropped-logo-300x300.png" alt="MoTa" class="logo" />
          MoTa Admin Intelligence
          <span class="chip">Analytics Portal</span>
        </h1>
        <div class="row">
          <span class="chip" id="lastRefresh">Last: â€”</span>
          <button class="btn small" id="refreshBtn">Refresh Data</button>
          <button class="btn small" id="updateBtn" onclick="triggerUpdate()" title="Fetch latest version" style="background: #4a5568;">â¬‡ Update System</button>
          <button class="btn small" id="chatBtn" onclick="openChatModal()" style="background: #4a5568; border-color: #718096; color: white;">ðŸ’¬ Team Chat</button>
        </div>
      </header>

      <div class="tabs">
        <div class="tab" data-tab="customers">ðŸ‘¥ Customers</div>
        <div class="tab" data-tab="suggested">ðŸ“¨ Suggested</div>
        <div class="tab" data-tab="scheduled">ðŸ“… Scheduled</div>
        <div class="tab active" data-tab="messages" id="messagesTab">ðŸ’¬ Messages</div>
        <div class="tab" data-tab="allmsgs">ðŸ“‹ All</div>
        <div class="tab" data-tab="budtenders">ðŸŽ¯ Budtenders</div>
        <div class="tab" data-tab="overview">ðŸ“Š Overview</div>
      </div>

      <main>
        <!-- CUSTOMERS TAB: 4-panel layout -->
        <div id="customersMainView">
          <div class="layout-4panel">
            <!-- LEFT: Customers list -->
            <div class="left-col" id="custListCol">
              <div class="panel">
                <div class="panel-title panel-title-resizable">
                  <span>ðŸ‘¥ CUSTOMERS</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('custListCol', -30)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('custListCol', 30)" title="Expand">â–¶</button>
                  </div>
                </div>
                <div
                  class="search-box"
                  style="padding: 12px; background: #0b1220; display: flex; flex-direction: column; gap: 8px;"
                >
                  <input
                    id="customerSearch"
                    type="search"
                    placeholder="Search by name, phone, email, member ID..."
                  />
                  <div style="display: flex; gap: 12px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: var(--text);">
                      <input type="checkbox" id="filterPhone" checked style="cursor: pointer;">
                      Has Phone #
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: var(--text);">
                      <input type="checkbox" id="filterSmsDb" style="cursor: pointer;">
                      In SMS DB
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: var(--text);">
                      <input type="checkbox" id="filterRecent" checked style="cursor: pointer;">
                      Shopped < 12mo
                    </label>
                  </div>
                </div>
                <div
                  class="filter-bar"
                  style="
                    margin: 0;
                    padding: 12px;
                    background: #0b1220;
                    border-radius: 0;
                  "
                >
                  <select id="customerFilter">
                    <option value="all">All Customers</option>
                    <option value="vip">VIP Only</option>
                    <option value="medical">Medical</option>
                    <option value="active">Active (30d)</option>
                    <option value="churn">Churn Risk</option>
                  </select>
                <select id="customerSort">
                    <option value="recent">Most Recent</option>
                    <option value="lifetime_desc">Lifetime Value â†“</option>
                    <option value="visits_desc">Total Visits â†“</option>
                    <option value="name">Name A-Z</option>
                  </select>
                </div>
                <div class="panel-content">
                  <table id="customerTable">
                    <thead>
                      <tr>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Visits</th>
                        <th>LTV</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div
                  style="
                    padding: 8px 12px;
                    background: #0b1220;
                    border-top: 1px solid #1f2937;
                  "
                >
                  <div class="muted" id="customerCount">0 customers loaded</div>
                </div>
              </div>
            </div>

            <!-- TOP RIGHT: Collapsed Items & Transactions -->
            <div class="right-top" id="custTxItemsCol">
              <div class="panel">
                <div class="panel-title panel-title-resizable" style="padding: 8px 12px; display: flex; justify-content: space-between; align-items: center;">
                  <span>ðŸ“‹ TRANSACTIONS & ITEMS</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('custTxItemsCol', -30)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('custTxItemsCol', 30)" title="Expand">â–¶</button>
                  </div>
                </div>
                <!-- Transactions Section -->
                <div
                  class="collapsible-header"
                  onclick="toggleCollapsible(this)"
                >
                  <span class="toggle-icon collapsed">â–¼</span>
                  ðŸ“Š Transactions (select customer)
                  <span
                    id="txCount"
                    style="
                      margin-left: auto;
                      font-size: 11px;
                      color: var(--muted);
                    "
                    >0</span
                  >
                </div>
                <div class="collapsible-body">
                  <div class="compact-list" id="txList"></div>
                </div>

                <!-- Items Section -->
                <div
                  class="collapsible-header"
                  onclick="toggleCollapsible(this)"
                >
                  <span class="toggle-icon collapsed">â–¼</span>
                  ðŸ“¦ Items (select transaction)
                  <span
                    id="itemCount"
                    style="
                      margin-left: auto;
                      font-size: 11px;
                      color: var(--muted);
                    "
                    >0</span
                  >
                </div>
                <div class="collapsible-body">
                  <div class="compact-list" id="itemList"></div>
                </div>
              </div>
            </div>

            <!-- BOTTOM RIGHT: Baseball Card + Analytics + SMS Side-by-Side -->
            <div class="right-bottom" id="custRightBottom">
              <div class="panel" style="flex: 0 0 320px; min-width: 280px;" id="custCardCol">
                <div class="panel-title panel-title-resizable">
                  <span>âš¾ BASEBALL CARD</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('custCardCol', -40)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('custCardCol', 40)" title="Expand">â–¶</button>
                  </div>
                </div>
                <div class="panel-content scrollable">
                  <pre id="cardText" class="terminal-text">Select a customer to view baseball card</pre>
                </div>
              </div>
              <div class="panel" style="flex: 0 0 280px; min-width: 240px;" id="custAnalyticsCol">
                <div class="panel-title panel-title-resizable">
                  <span>ðŸ“ˆ VISIT ANALYTICS</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('custAnalyticsCol', -40)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('custAnalyticsCol', 40)" title="Expand">â–¶</button>
                  </div>
                </div>
                <div class="panel-content scrollable">
                  <pre id="analyticsText" class="terminal-text">Select a customer to view analytics</pre>
                </div>
              </div>
              <!-- SMS Messenger Panel -->
              <div class="panel" style="flex: 1; min-width: 300px;" id="custSmsCol">
                <div class="panel-title panel-title-resizable">
                  <span>ðŸ’¬ SMS MESSENGER</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('custSmsCol', -40)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('custSmsCol', 40)" title="Expand">â–¶</button>
                  </div>
                </div>
                <div id="custSmsHeader" style="padding: 8px 10px; background: var(--panel-light); border-bottom: 1px solid var(--border);">
                  <div style="font-size: 11px;">
                    <strong id="custSmsName">â€”</strong> 
                    <span id="custSmsPhone" style="font-family: monospace; color: var(--muted);">â€”</span>
                  </div>
                </div>
                <div id="custSmsThread" style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 200px; max-height: 350px; background: var(--bg);">
                  <div class="muted" style="text-align: center; padding: 40px; font-size: 11px;">Select a customer to view messages</div>
                </div>
                <!-- Reply Box for Customers Tab -->
                <div style="padding: 10px; border-top: 1px solid var(--border); background: var(--panel);">
                  <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <textarea id="custSmsReplyText" placeholder="Type message..." style="flex: 1; min-height: 50px; max-height: 80px; padding: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <button class="btn accent" id="custSmsSendBtn" style="padding: 6px 12px; font-size: 10px; font-weight: 700;">Send</button>
                      <button class="btn" id="custSmsQueueBtn" style="padding: 5px 10px; font-size: 9px; background: var(--success); border-color: var(--success);">+ Q</button>
                      <button class="btn" id="custSmsScheduleBtn" style="padding: 5px 10px; font-size: 9px; background: var(--warn); border-color: var(--warn); color: var(--bg);">ðŸ“…</button>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                    <span id="custSmsCharCount" class="muted" style="font-size: 9px;">0 / 160</span>
                  </div>
                  <!-- Schedule Modal for Customers Tab -->
                  <div id="custSmsScheduleModal" style="display: none; margin-top: 8px; padding: 8px; background: var(--panel-light); border-radius: 6px; border: 1px solid var(--border);">
                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 6px; color: var(--accent-light);">ðŸ“… Schedule</div>
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                      <input type="date" id="custSmsScheduleDate" style="padding: 4px 6px; font-size: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                      <input type="time" id="custSmsScheduleTime" style="padding: 4px 6px; font-size: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                      <button class="btn primary" id="custSmsScheduleConfirmBtn" style="font-size: 9px; padding: 4px 8px;">OK</button>
                      <button class="btn" id="custSmsScheduleCancelBtn" style="font-size: 9px; padding: 4px 8px;">X</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SUGGESTED MESSAGES TAB - 4 COLUMNS: Queue | Card | Analytics | Messages -->
        <div id="suggestedMainView" style="display: none">
          <!-- Stats Bar -->
          <div id="sugStatsBar" style="display: flex; gap: 16px; padding: 10px 20px; background: var(--panel); border-bottom: 2px solid var(--border); align-items: center;">
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="sugStatSug" style="color: var(--warn);">0</span> SUG
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="sugStatApr" style="color: var(--success);">0</span> APR
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="sugStatSent" style="color: var(--accent);">0</span> SENT
            </span>
          </div>
          <div class="sug-layout-4col">
            <!-- COL 1: Message Queue -->
            <div class="sug-queue-col" id="sugQueueCol">
              <div class="panel-title panel-title-resizable" style="display:flex; justify-content:space-between; align-items:center; padding: 10px 12px;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 14px;">ðŸ“¨ Queue</span>
                    <span id="sugQueueCount" style="font-size: 12px; color:var(--accent); font-weight: 700;">0</span>
                </div>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('sugQueueCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('sugQueueCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div style="padding: 8px; background: var(--bg); border-bottom: 1px solid var(--border);">
                <input id="sugSearch" type="search" placeholder="Search name..." style="width: 100%; padding: 8px 10px; font-size: 12px;" />
              </div>
              <div style="padding: 8px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px;">
                <select id="sugStatusFilter" style="width: 100%; padding: 6px 8px; font-size: 12px;">
                  <option value="SUG">ðŸ“‹ Suggested</option>
                  <option value="APR">âœ… Approved</option>
                  <option value="sent">ðŸ“¤ Sent</option>
                  <option value="all">All</option>
                </select>
                <select id="sugCampaignFilter" style="width: 100%; padding: 6px 8px; font-size: 12px;">
                  <option value="all">All Campaigns</option>
                </select>
              </div>
              <div id="sugMessageList" style="flex: 1; overflow-y: auto;"></div>
              <div style="padding: 8px 10px; background: var(--bg); border-top: 1px solid var(--border);">
                <div class="muted" style="font-size: 11px;" id="sugMessageCount">0 msgs</div>
              </div>
            </div>

            <!-- COL 2: Baseball Card -->
            <div class="sug-card-col" id="sugCardCol">
              <div class="panel-title panel-title-resizable">
                <span>âš¾ BASEBALL CARD</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('sugCardCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('sugCardCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div style="flex: 1; overflow-y: auto; padding: 10px; background: var(--bg);">
                <pre id="sugCardText" class="terminal-text" style="font-size: 11px; line-height: 1.4;">Select a message to view customer profile</pre>
              </div>
            </div>

            <!-- COL 3: Visit Analytics -->
            <div class="sug-analytics-col" id="sugAnalyticsCol">
              <div class="panel-title panel-title-resizable">
                <span>ðŸ“ˆ VISIT ANALYTICS</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('sugAnalyticsCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('sugAnalyticsCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div style="flex: 1; overflow-y: auto; padding: 10px; background: var(--bg);">
                <pre id="sugAnalyticsText" class="terminal-text" style="font-size: 11px; line-height: 1.4;">Select a message to view analytics</pre>
              </div>
            </div>

            <!-- COL 4: Conversation + Message Preview -->
            <div class="sug-message-col" id="sugMessageCol">
              <div class="panel-title panel-title-resizable" style="display:flex; justify-content:space-between; align-items:center;">
                <span>ðŸ’¬ MESSAGES</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span id="sugPreviewStatus" class="pill active" style="font-size: 9px;">SUG</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('sugMessageCol', -50)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('sugMessageCol', 50)" title="Expand">â–¶</button>
                  </div>
                </div>
              </div>
              <div id="sugCustomerInfo" style="padding: 8px 10px; background: var(--panel-light); border-bottom: 1px solid var(--border);">
                <div style="font-size: 11px;">
                  <strong id="sugCustName">â€”</strong> 
                  <span id="sugCustPhone" style="font-family: monospace; color: var(--muted);">â€”</span>
                </div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">
                  <span id="sugCustSegment">â€”</span> Â· <span id="sugCustCampaign">â€”</span>
                </div>
              </div>
              
              <!-- Conversation History -->
              <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="panel-title" style="font-size: 9px; padding: 6px 10px;">ðŸ“œ HISTORY</div>
                <div id="sugConversationHistory" style="flex: 1; overflow: auto; padding: 8px; background: var(--bg); display: flex; flex-direction: column;">
                  <div class="muted" style="text-align: center; padding: 20px; font-size: 11px;">Select a message</div>
                </div>
              </div>
              
              <!-- Message Content & Actions -->
              <div style="border-top: 2px solid var(--border); flex: 0 0 auto;">
                <div class="panel-title" style="font-size: 10px; padding: 8px 12px; background: var(--accent); color: var(--bg);">âœï¸ SUGGESTED</div>
                <div style="padding: 12px;">
                  <div id="sugMessageContent" style="background: var(--bg); border: 2px solid var(--border); border-radius: 8px; padding: 16px; min-height: 140px; max-height: 200px; overflow-y: auto; font-size: 15px; font-weight: 500; line-height: 1.6; color: var(--text);">
                    Select a message from the queue
                  </div>
                </div>
                <div id="sugNotesSection" style="padding: 0 12px 12px; display: none;">
                  <textarea id="sugNotesInput" style="width: 100%; min-height: 80px; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; color: var(--text); padding: 12px; font-size: 13px; resize: vertical;" placeholder="Notes..."></textarea>
                </div>
                <div id="sugActionBar" style="padding: 12px; background: var(--panel-light); border-top: 1px solid var(--border); display: none;">
                  <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn accent" id="sugBtnApprove" style="font-size: 13px; padding: 10px 20px; font-weight: 700;">âœ“ Approve</button>
                    <button class="btn" id="sugBtnEdit" style="font-size: 13px; padding: 10px 16px;">âœŽ Edit</button>
                    <button class="btn" style="background: var(--danger); font-size: 13px; padding: 10px 16px;" id="sugBtnReject">âœ•</button>
                    <button class="btn" id="sugBtnSkip" style="font-size: 13px; padding: 10px 16px;">â†’</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SCHEDULED TAB: APR -> Scheduled -> Queued workflow -->
        <div id="scheduledMainView" style="display: none">
          <!-- Stats Bar -->
          <div id="schedStatsBar" style="display: flex; gap: 16px; padding: 10px 20px; background: var(--panel); border-bottom: 2px solid var(--border); align-items: center; flex-wrap: wrap;">
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="schedStatApr" style="color: var(--success);">0</span> APR
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="schedStatScheduled" style="color: var(--warn);">0</span> Scheduled
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="schedStatQueued" style="color: var(--accent);">0</span> Queued
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--warn);">
              <input type="checkbox" id="schedAutoQ" checked style="width: 16px; height: 16px; cursor: pointer;">
              Auto-Q
            </label>
            <div style="flex: 1;"></div>
            <span id="schedCurrentTime" style="font-size: 11px; color: var(--muted);"></span>
          </div>
          
          <!-- Schedule Settings Bar -->
          <div style="display: flex; gap: 20px; padding: 8px 20px; background: var(--bg); border-bottom: 1px solid var(--border); align-items: center; font-size: 12px;">
            <div style="color: var(--muted);">
              <strong style="color: var(--text);">Window:</strong>
              <span style="margin-left: 8px; font-family: monospace; font-size: 13px; color: var(--accent);">0930 - 1830</span>
            </div>
            <div style="color: var(--muted);">
              <strong style="color: var(--text);">Interval:</strong>
              <span style="margin-left: 8px; font-family: monospace; font-size: 13px;">180s <span style="color: var(--warn);">Â±15%</span></span>
            </div>
          </div>
          
          <div style="display: flex; height: calc(100vh - 185px); gap: 0;">
            <!-- LEFT: APR Messages Queue -->
            <div id="schedAprCol" style="width: 280px; flex: 0 0 280px; border-right: 2px solid var(--border); display: flex; flex-direction: column; background: var(--panel);">
              <div class="panel-title panel-title-resizable">
                <span>âœ“ APPROVED (Ready)</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('schedAprCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('schedAprCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div style="padding: 8px;">
                <button class="btn accent" id="schedBtnScheduleAll" style="width: 100%; font-size: 12px; padding: 8px;">
                  ðŸ“… Schedule All APR Messages
                </button>
              </div>
              <div id="schedAprList" style="flex: 1; overflow-y: auto; padding: 8px;">
                <div class="muted" style="padding: 20px; text-align: center;">Loading...</div>
              </div>
            </div>
            
            <!-- CENTER: Scheduled Messages (with times) -->
            <div id="schedScheduledCol" style="flex: 1; display: flex; flex-direction: column; border-right: 2px solid var(--border); background: var(--bg);">
              <div class="panel-title panel-title-resizable">
                <span>ðŸ“… SCHEDULED</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('schedScheduledCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('schedScheduledCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center;">
                <label style="font-size: 11px; color: var(--muted);">Date:</label>
                <input type="date" id="schedDateFilter" style="padding: 4px 8px; font-size: 11px; background: var(--panel); border: 1px solid var(--border); color: var(--text); border-radius: 4px;">
                <button class="btn" id="schedBtnToday" style="font-size: 10px; padding: 4px 8px;">Today</button>
                <button class="btn" id="schedBtnTomorrow" style="font-size: 10px; padding: 4px 8px;">Tomorrow</button>
              </div>
              <div id="schedScheduledList" style="flex: 1; overflow-y: auto; padding: 8px;">
                <div class="muted" style="padding: 20px; text-align: center;">No scheduled messages</div>
              </div>
            </div>
            
            <!-- RIGHT: Message Preview & Actions -->
            <div id="schedDetailCol" style="width: 350px; flex: 0 0 350px; display: flex; flex-direction: column; background: var(--panel);">
              <div class="panel-title panel-title-resizable">
                <span>ðŸ“ MESSAGE DETAILS</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('schedDetailCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('schedDetailCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div id="schedMessagePreview" style="flex: 1; overflow-y: auto; padding: 12px;">
                <div class="muted" style="text-align: center; padding: 40px;">Select a message to view details</div>
              </div>
              <div id="schedActionBar" style="padding: 12px; border-top: 2px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn" id="schedBtnReschedule" style="font-size: 11px; padding: 6px 12px;" disabled>ðŸ• Reschedule</button>
                <button class="btn" id="schedBtnSendNow" style="font-size: 11px; padding: 6px 12px; background: var(--success);" disabled>âš¡ Send Now</button>
                <button class="btn" id="schedBtnCancel" style="font-size: 11px; padding: 6px 12px; background: var(--danger);" disabled>âœ• Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- BUDTENDERS TAB: Budtenders -->
        <div id="budtendersMainView" style="display: none">
          <!-- LEFT PANEL -->
          <section class="panel left" id="budtendersLeftPanel">
            <div id="budtendersListView">
              <div class="title panel-title-resizable">
                <span>Budtender Search</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('budtendersLeftPanel', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('budtendersLeftPanel', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div class="search-box">
                <input
                  id="budtenderSearch"
                  type="search"
                  placeholder="Search by name, dispensary..."
                />
              </div>
              <div class="filter-bar">
                <select id="budtenderFilter">
                  <option value="all">All Budtenders</option>
                  <option value="main">Main only</option>
                  <option value="external">External only</option>
                </select>
                <select id="budtenderDispensaryFilter">
                  <option value="all">All Dispensaries</option>
                  <!-- options will be populated dynamically -->
                </select>
                <select id="budtenderSort">
                  <option value="name">Name A-Z</option>
                  <option value="points_desc">Points â†“</option>
                  <option value="dispensary">Dispensary</option>
                </select>
              </div>
              <div class="list">
                <table id="budtenderTable">
                  <thead>
                    <tr>
                      <th>Budtender</th>
                      <th>Location</th>
                      <th>Points</th>
                      <th>Type</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="muted" style="margin-top: 8px" id="budtenderCount">
                0 budtenders loaded
              </div>
            </div>
          </section>

          <!-- CENTER PANEL: Budtenders Profile + Analytics -->
          <section class="panel center">
            <div id="budtendersDetailView">
              <div class="title">Budtender</div>
              <div class="analytics-nav" id="budtenderDetailNav">
                <div
                  class="analytics-nav-item active"
                  data-bdetail="profile"
                  id="budtenderDetailTabProfile"
                >
                  Profile
                </div>
                <div
                  class="analytics-nav-item"
                  data-bdetail="analytics"
                  id="budtenderDetailTabAnalytics"
                >
                  Analytics &amp; Insights
                </div>
              </div>
              <div id="budtenderProfileContent" class="loading">
                Select a budtender from the left to view their performance
                metrics, sales analytics, customer interactions, and insights.
              </div>

              <!-- Budtenders: Analytics en la misma columna, conmutado -->
              <div
                id="budtendersAnalyticsView"
                style="margin-top: 20px; display: none"
              >
                <div class="title">Budtender Analytics & Insights</div>

                <div class="analytics-nav">
                  <div
                    class="analytics-nav-item active"
                    data-section="performance"
                  >
                    Performance
                  </div>
                  <div class="analytics-nav-item" data-section="products">
                    Products
                  </div>
                <div class="analytics-nav-item" data-section="transactions">
                    Transactions
                  </div>
                  <div class="analytics-nav-item" data-section="coaching">
                    Coaching
                  </div>
                </div>

                <div id="budtenderAnalyticsContent" class="muted">
                  Select a budtender to see performance trends, top products
                  sold, customer satisfaction indicators, and coaching
                  recommendations.
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- MESSAGES TAB: Conversations with replies -->
        <div id="messagesMainView" style="display: none">
          <!-- Stats Bar -->
          <div id="msgStatsBar" style="display: flex; gap: 16px; padding: 10px 20px; background: var(--panel); border-bottom: 2px solid var(--border); align-items: center;">
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="msgStatConvos" style="color: var(--accent);">0</span> Conversations
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="msgStatUnread" style="color: var(--danger);">0</span> Unread
            </span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">|</span>
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">
              <span id="msgStatInbound" style="color: var(--warn);">0</span> Inbound Today
            </span>
            <div style="flex: 1;"></div>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; color: var(--muted);">
              <input type="checkbox" id="msgLiveToggle" style="width: 14px; height: 14px; cursor: pointer;">
              Live (15s)
            </label>
            <button class="btn" id="msgRefreshBtn" style="font-size: 11px; padding: 5px 10px;">Refresh</button>
          </div>
          
          <!-- 3-column layout: Conversations | Thread | Customer Card -->
          <div class="msg-layout-3col">
            <!-- Left: Conversation List -->
            <div class="msg-convos-col" id="msgConvosCol">
              <div class="title panel-title-resizable" style="padding: 10px; border-bottom: 1px solid var(--border);">
                <span>Conversations with Replies</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('msgConvosCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('msgConvosCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div style="padding: 8px;">
                <input type="search" id="msgSearchInput" placeholder="Search phone or name..." style="width: 100%; padding: 6px 10px; font-size: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
              <div style="padding: 0 8px 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                <button class="btn small msg-filter-btn active" data-filter="all" style="font-size: 10px; padding: 4px 8px;">All</button>
                <button class="btn small msg-filter-btn" data-filter="unread" style="font-size: 10px; padding: 4px 8px;">Unread</button>
                <button class="btn small msg-filter-btn" data-filter="today" style="font-size: 10px; padding: 4px 8px;">Today</button>
              </div>
              <div id="msgConvoList" style="flex: 1; overflow-y: auto; padding: 0 8px;">
                <div class="muted" style="padding: 20px; text-align: center;">Loading conversations...</div>
              </div>
            </div>
            
            <!-- Center: Thread View -->
            <div class="msg-thread-col" id="msgThreadCol">
              <div class="title panel-title-resizable" style="padding: 10px; border-bottom: 1px solid var(--border);">
                <span id="msgThreadHeader">Select a conversation</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('msgThreadCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('msgThreadCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div id="msgThreadContent" style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px;">
                <div class="muted" style="text-align: center; padding: 40px;">Select a conversation to view messages</div>
              </div>
              <!-- Reply Box -->
              <div id="msgReplyBox" style="padding: 10px; border-top: 1px solid var(--border); background: var(--panel);">
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                  <textarea id="msgReplyText" placeholder="Type your reply... Use [BUBBLE] to split into multiple SMS." style="flex: 1; min-height: 60px; max-height: 120px; padding: 8px; font-size: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <button class="btn accent" id="msgSendBtn" style="padding: 8px 16px; font-size: 12px; font-weight: 700;">Send</button>
                    <button class="btn" id="msgQueueBtn" style="padding: 6px 12px; font-size: 10px; font-weight: 600; background: var(--success); border-color: var(--success);">+ Queue</button>
                    <button class="btn" id="msgScheduleBtn" style="padding: 6px 12px; font-size: 10px; font-weight: 600; background: var(--warn); border-color: var(--warn); color: var(--bg);">ðŸ“… Schedule</button>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                  <span id="msgCharCount" class="muted" style="font-size: 10px;">0 / 160</span>
                  <div style="display: flex; gap: 6px; align-items: center;">
                    <button class="btn small" id="msgMarkReadBtn" style="font-size: 10px; padding: 3px 8px;">Mark Read</button>
                  </div>
                </div>
                <!-- Schedule Modal -->
                <div id="msgScheduleModal" style="display: none; margin-top: 8px; padding: 10px; background: var(--panel-light); border-radius: 6px; border: 1px solid var(--border);">
                  <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: var(--accent-light);">ðŸ“… Schedule Send</div>
                  <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="msgScheduleDate" style="padding: 6px 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                    <input type="time" id="msgScheduleTime" style="padding: 6px 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                    <button class="btn primary" id="msgScheduleConfirmBtn" style="font-size: 10px; padding: 6px 12px;">Confirm</button>
                    <button class="btn" id="msgScheduleCancelBtn" style="font-size: 10px; padding: 6px 12px;">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right: Customer Card + Analytics -->
            <div class="msg-card-col" id="msgCardCol" style="width: 480px; flex: 0 0 480px;">
              <div style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div class="title panel-title-resizable" style="padding: 10px; border-bottom: 1px solid var(--border);">
                  <span>âš¾ Baseball Card</span>
                  <div class="resize-controls">
                    <button class="resize-btn" onclick="resizeColumn('msgCardCol', -50)" title="Shrink">â—€</button>
                    <button class="resize-btn" onclick="resizeColumn('msgCardCol', 50)" title="Expand">â–¶</button>
                  </div>
                </div>
                <div id="msgBaseballCard" style="flex: 1; overflow-y: auto; padding: 10px; min-height: 0;">
                  <pre id="msgCardText" style="margin: 0; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 11px; color: var(--text);">Select a conversation to view customer details</pre>
                </div>
                <div class="title" style="padding: 10px; border-bottom: 1px solid var(--border); border-top: 1px solid var(--border);">
                  ðŸ“ˆ Visit Analytics
                </div>
                <div id="msgAnalyticsCard" style="flex: 1; overflow-y: auto; padding: 10px; min-height: 0;">
                  <pre id="msgAnalyticsText" style="margin: 0; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 11px; color: var(--text);">Select a conversation to view analytics</pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ALL MESSAGES TAB: Last 100 messages -->
        <div id="allmsgsMainView" style="display: none">
          <div style="padding: 10px 20px; background: var(--panel); border-bottom: 2px solid var(--border); display: flex; align-items: center; gap: 16px;">
            <span style="font-weight: 700; color: var(--accent-light); font-size: 13px;">Last 100 Messages (All In/Out)</span>
            <div style="flex: 1;"></div>
            <button class="btn" id="allmsgsRefreshBtn" style="font-size: 11px; padding: 5px 10px;">Refresh</button>
          </div>
          <div style="display: flex; height: calc(100vh - 140px);">
            <!-- Left: Message list -->
            <div style="flex: 1; overflow-y: auto; border-right: 1px solid var(--border);">
              <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                  <tr style="background: var(--panel); position: sticky; top: 0; z-index: 10;">
                    <th style="padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border);">Time</th>
                    <th style="padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border);">Phone</th>
                    <th style="padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border);">Customer</th>
                    <th style="padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border);">Dir</th>
                    <th style="padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border);">Status</th>
                    <th style="padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border);">Message</th>
                  </tr>
                </thead>
                <tbody id="allmsgsTableBody">
                  <tr><td colspan="6" class="muted" style="padding: 20px; text-align: center;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
            <!-- Right: Conversation panel -->
            <div id="allMsgThreadCol" style="width: 400px; flex: 0 0 400px; display: flex; flex-direction: column; background: var(--panel);">
              <div class="title panel-title-resizable" style="padding: 10px; border-bottom: 1px solid var(--border);">
                <span id="allmsgsConvoHeader">Click a message to view conversation</span>
                <div class="resize-controls">
                  <button class="resize-btn" onclick="resizeColumn('allMsgThreadCol', -50)" title="Shrink">â—€</button>
                  <button class="resize-btn" onclick="resizeColumn('allMsgThreadCol', 50)" title="Expand">â–¶</button>
                </div>
              </div>
              <div id="allmsgsConvoContent" style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px;">
                <div class="muted" style="text-align: center; padding: 40px;">Select a message to view full conversation</div>
              </div>
              <!-- Reply Box -->
              <div style="padding: 10px; border-top: 1px solid var(--border); background: var(--bg);">
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                  <textarea id="allmsgsReplyText" placeholder="Type your reply..." style="flex: 1; min-height: 50px; max-height: 80px; padding: 8px; font-size: 12px; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
                  <button class="btn accent" id="allmsgsSendBtn" style="padding: 8px 12px; font-size: 11px; font-weight: 700;">Send</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- OVERVIEW TAB: Original 3-panel layout restored -->
        <div id="overviewMainView" style="display: none">
          <!-- LEFT PANEL -->
          <section class="panel left" id="overviewLeftPanel">
            <div id="overviewListView">
              <div class="title">Quick Stats</div>
              <div class="stat-card">
                <div class="label">Total Customers</div>
                <div class="value" id="statTotalCustomers">â€”</div>
                <div class="subtext">Active members</div>
              </div>
              <div class="stat-card">
                <div class="label">Total Budtenders</div>
                <div class="value" id="statTotalBudtenders">â€”</div>
                <div class="subtext">Across all locations</div>
              </div>
              <div class="stat-card">
                <div class="label">Total Transactions</div>
                <div class="value" id="statTotalTransactions">â€”</div>
                <div class="subtext">All-time sales</div>
              </div>
              <div class="stat-card">
                <div class="label">Total Revenue</div>
                <div class="value" id="statTotalRevenue">â€”</div>
                <div class="subtext">Lifetime value</div>
              </div>
            </div>
          </section>

          <!-- CENTER PANEL: Overview content -->
          <section class="panel center">
            <div id="overviewDetailView">
              <div class="title">Business Overview & Insights</div>
              <div id="overviewContent" class="loading">
                Loading overview analytics...
              </div>

              <div id="overviewAnalyticsView" style="margin-top: 20px">
                <div class="title">Strategic Recommendations</div>
                <div id="overviewAnalyticsContent" class="muted">
                  Loading strategic business recommendations...
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      // ========== GLOBAL STATE ==========
      let supabaseClient = null;
      let activeTab = "messages";
      let currentCustomerId = null;
      let currentBudtenderId = null;
      let customersData = [];
      let budtendersData = [];
      let transactionsCache = new Map();
      let itemsCache = new Map();
      let currentAnalyticsSection = "overview";
      let currentCustomerData = null;
      let currentBudtenderData = null;
      let chartInstances = {};
      let currentBudAnalyticsSection = "performance";
      let overviewDispAggregates = [];
      let overviewMainBudSummary = [];
      let overviewBudChart = null;
      let overviewCustomerSummary = null;

      // ========== SUPABASE CLIENT ==========
      function ensureClient() {
        if (!supabaseClient) {
          supabaseClient = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY,
            { auth: { persistSession: false } }
          );
        }
        return supabaseClient;
      }

      // ========== COLLAPSIBLE TOGGLE ==========
      function toggleCollapsible(header) {
        const body = header.nextElementSibling;
        if (!body) return;
        const icon = header.querySelector(".toggle-icon");
        body.classList.toggle("expanded");
        icon.classList.toggle("collapsed");
      }

      // ========== FORMATTING UTILITIES ==========
      function fmtMoney(n) {
        return typeof n === "number" && !isNaN(n)
          ? `$${n.toLocaleString("en-US", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}`
          : "$0.00";
      }
      function fmtDate(d) {
        if (!d) return "â€”";
        try {
          return new Date(d).toLocaleDateString("en-US");
        } catch {
          return "â€”";
        }
      }
      function fmtDateTime(d) {
        if (!d) return "â€”";
        try {
          return new Date(d).toLocaleString("en-US");
        } catch {
          return "â€”";
        }
      }
      function calculateAge(dob) {
        if (!dob) return null;
        try {
          const d = new Date(dob);
          const today = new Date();
          let age = today.getFullYear() - d.getFullYear();
          const m = today.getMonth() - d.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
          return age;
        } catch {
          return null;
        }
      }
      function ageGroup(age) {
        if (age == null) return "Unknown";
        if (age < 21) return "Under 21";
        if (age <= 25) return "21-25";
        if (age <= 30) return "26-30";
        if (age <= 35) return "31-35";
        if (age <= 45) return "36-45";
        if (age <= 55) return "46-55";
        return "55+";
      }
      function setLastRefresh() {
        document.getElementById("lastRefresh").textContent =
          "Last: " + new Date().toLocaleTimeString();
      }

      // ========== PANEL RESIZING (NOT USED IN NEW LAYOUT) ==========
      function initResizablePanels() {
        // Resizing is not used in the current layout
        // Kept for compatibility
      }

      // ========== COLUMN RESIZE FUNCTIONALITY ==========
      const columnWidths = {
        sugQueueCol: 280,
        sugCardCol: 425,
        sugAnalyticsCol: 300,
        sugMessageCol: 500,
        msgCardCol: 480,
        msgThreadCol: 500,
        custCardCol: 320,
        custAnalyticsCol: 280,
        custSmsCol: 400,
        custListCol: 280,
        custTxItemsCol: 100,
        schedAprCol: 280,
        schedScheduledCol: 400,
        schedDetailCol: 350,
        allMsgThreadCol: 400,
        msgConvosCol: 300,
        budtendersLeftPanel: 300
      };
      const columnMinMax = {
        sugQueueCol: { min: 200, max: 600 },
        sugCardCol: { min: 250, max: 1000 },
        sugAnalyticsCol: { min: 200, max: 800 },
        sugMessageCol: { min: 350, max: 1200 },
        msgCardCol: { min: 300, max: 1000 },
        msgThreadCol: { min: 400, max: 1200 },
        custCardCol: { min: 200, max: 800 },
        custAnalyticsCol: { min: 180, max: 800 },
        custSmsCol: { min: 280, max: 1000 },
        custListCol: { min: 200, max: 1000 },
        custTxItemsCol: { min: 80, max: 400 },
        schedAprCol: { min: 200, max: 600 },
        schedScheduledCol: { min: 300, max: 800 },
        schedDetailCol: { min: 250, max: 600 },
        allMsgThreadCol: { min: 300, max: 800 },
        msgConvosCol: { min: 200, max: 600 },
        budtendersLeftPanel: { min: 200, max: 600 }
      };

      // Load saved column widths from localStorage
      function loadColumnWidths() {
        try {
          const saved = localStorage.getItem('motaColumnWidths');
          if (saved) {
            const parsed = JSON.parse(saved);
            Object.assign(columnWidths, parsed);
          }
        } catch (e) {
          console.warn('Could not load column widths:', e);
        }
        // Apply saved widths to columns
        Object.keys(columnWidths).forEach(colId => {
          applyColumnWidth(colId, columnWidths[colId]);
        });
      }

      // Save column widths to localStorage
      function saveColumnWidths() {
        try {
          localStorage.setItem('motaColumnWidths', JSON.stringify(columnWidths));
        } catch (e) {
          console.warn('Could not save column widths:', e);
        }
      }

      // Apply width to a column element
      function applyColumnWidth(colId, width) {
        const col = document.getElementById(colId);
        if (!col) return;
        
        // Special handling for customer list column - uses CSS variable for grid
        if (colId === 'custListCol') {
          document.documentElement.style.setProperty('--cust-list-width', width + 'px');
          return;
        }
        
        // Special handling for transactions/items section height
        if (colId === 'custTxItemsCol') {
          col.style.maxHeight = width + 'px';
          return;
        }
        
        col.style.width = width + 'px';
        col.style.flex = `0 0 ${width}px`;
        col.style.minWidth = width + 'px';
      }

      // Resize a column by delta amount
      function resizeColumn(colId, delta) {
        const limits = columnMinMax[colId] || { min: 200, max: 600 };
        const currentWidth = columnWidths[colId] || 400;
        const newWidth = Math.max(limits.min, Math.min(limits.max, currentWidth + delta));
        columnWidths[colId] = newWidth;
        applyColumnWidth(colId, newWidth);
        saveColumnWidths();
      }

      // Initialize column widths on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadColumnWidths();
        startNewMessageChecker();
      });

      // ========== TAB SWITCHING ==========
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll(".tab").forEach((t) => {
          t.classList.toggle("active", t.dataset.tab === tab);
        });

        document.getElementById("customersMainView").style.display =
          tab === "customers" ? "" : "none";
        document.getElementById("suggestedMainView").style.display =
          tab === "suggested" ? "" : "none";
        document.getElementById("scheduledMainView").style.display =
          tab === "scheduled" ? "" : "none";
        document.getElementById("messagesMainView").style.display =
          tab === "messages" ? "" : "none";
        document.getElementById("allmsgsMainView").style.display =
          tab === "allmsgs" ? "" : "none";
        document.getElementById("budtendersMainView").style.display =
          tab === "budtenders" ? "" : "none";
        document.getElementById("overviewMainView").style.display =
          tab === "overview" ? "" : "none";

        if (tab === "scheduled") {
          loadScheduledMessages();
        }
        if (tab === "messages") {
          loadMessagesTab();
          // Clear the new message indicator when viewing Messages tab
          const messagesTab = document.getElementById("messagesTab");
          if (messagesTab) messagesTab.classList.remove("has-new-messages");
        }
        if (tab === "allmsgs") {
          loadAllMsgsTab();
        }
        if (tab === "customers" && customersData.length === 0) {
          loadCustomers();
        } else if (tab === "suggested") {
          loadSuggestedMessages();
        } else if (tab === "budtenders" && budtendersData.length === 0) {
          loadBudtenders();
        } else if (tab === "overview") {
          loadOverview();
        }
      }

      // ========== LOAD CUSTOMERS ==========
      async function loadCustomers() {
        try {
          const sb = ensureClient();
          const cardText = document.getElementById("cardText");
          if (cardText) {
            cardText.textContent = "Loading customers...";
          }

          const searchTerm = (
            document.getElementById("customerSearch").value || ""
          ).trim();
          const filter = document.getElementById("customerFilter").value;
          const sort = document.getElementById("customerSort").value;
          const filterPhone = document.getElementById("filterPhone").checked;
          const filterSmsDb = document.getElementById("filterSmsDb").checked;
          const filterRecent = document.getElementById("filterRecent").checked;

          // Use IC viewer approach: Hybrid "Live Queue" + Global Search
          // 1. Always fetch the "Live Queue" (recent active shoppers) first if sort is 'recent'
          if (sort === "recent" && !filterSmsDb) {
            // Get the most recent transactions to find today's shoppers
            // Increased limit to 1000 to match IC Viewer depth
            // Removed date filter to ensure we catch recent shoppers even if data is older or sparse
            const { data: recentTxs, error: txErr } = await sb
              .from("transactions")
              .select("customer_id, date")
              .order("date", { ascending: false })
              .limit(1000);
            
            if (txErr) throw txErr;
            
            // Get unique customer IDs from the transactions (limit to 100 unique customers)
            const customerIds = [...new Set((recentTxs || []).map(tx => tx.customer_id))].slice(0, 100);
            
            if (customerIds.length > 0) {
              // Get customer details
              let query = sb.from("customers").select("*").in("member_id", customerIds);
              
              // Apply standard filters to the queue fetch
              if (filter === "vip") query = query.not("vip_status", "in", '("New",null)');
              else if (filter === "medical") query = query.eq("is_medical", true);
              else if (filter === "active") query = query.lte("days_since_last_visit", 30);
              else if (filter === "churn") query = query.eq("churn_risk", "High");
              
              // Apply new checkbox filters to queue fetch
              if (filterPhone) query = query.not("phone", "is", null).neq("phone", "");
              // Recent filter is implicit in Live Queue, but we can enforce stricter 12mo if needed
              // For now, Live Queue implies recent activity, so we'll skip extra date filtering here
              
              const { data, error } = await query;
              if (error) throw error;
              
              // Update last_visited with actual transaction dates (Live Data)
              const latestDateMap = {};
              for (const tx of (recentTxs || [])) {
                if (!latestDateMap[tx.customer_id]) {
                  latestDateMap[tx.customer_id] = tx.date;
                }
              }
              
              for (const c of (data || [])) {
                if (latestDateMap[c.member_id]) {
                  c.last_visited = latestDateMap[c.member_id];
                }
              }
              
              // Sort by most recent transaction date
              (data || []).sort((a, b) => {
                const dateA = new Date(a.last_visited || 0);
                const dateB = new Date(b.last_visited || 0);
                return dateB - dateA;
              });
              
              let queueData = data || [];

              // Filter queue data by "Shopped < 12mo" if checked
              if (filterRecent) {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                queueData = queueData.filter(c => {
                  const lastVisit = new Date(c.last_visited || 0);
                  return lastVisit >= oneYearAgo;
                });
              }

              // If we have a search term, filter the QUEUE first
              if (searchTerm) {
                const lowerTerm = searchTerm.toLowerCase().trim();
                // Normalize input for phone search
                const digits = lowerTerm.replace(/\D/g, "");
                
                const filteredQueue = queueData.filter(c => {
                  const text = `${c.first_name} ${c.last_name} ${c.name} ${c.phone} ${c.email} ${c.member_id}`.toLowerCase();
                  if (text.includes(lowerTerm)) return true;
                  
                  // Phone match logic
                  if (digits.length >= 4 && c.phone) {
                    const cDigits = c.phone.replace(/\D/g, "");
                    if (cDigits.includes(digits)) return true;
                  }
                  return false;
                });
                
                // If we found matches in the Live Queue, show them!
                // This preserves the "Live" status/timestamps for active customers
                if (filteredQueue.length > 0) {
                  // NEW: Even for queue data, check SMS status if needed
                  // We will do this in bulk for the displayed list below
                  customersData = filteredQueue;
                  await enrichWithSmsStatus(customersData);
                  renderCustomerList(customersData);
                  setLastRefresh();
                  selectCustomer(customersData[0]);
                  return; // Done, we found them in the queue
                }
                
                // If NOT found in queue, fall through to Global Search below
                console.log("Not found in live queue, falling back to global search...");
              } else {
                // No search term, just show the queue
                customersData = queueData;
                await enrichWithSmsStatus(customersData);
                renderCustomerList(customersData);
                setLastRefresh();
                if (customersData.length > 0) selectCustomer(customersData[0]);
                return;
              }
            }
          }

          // Fallback to standard query for search or other sorts
          // Use customers_blaze for better search results (like ic_viewer)
          // Standard customers table is used for Live Queue, but blaze table has better search fields
          const table = searchTerm ? "customers_blaze" : "customers";
          let query = sb.from(table).select("*");

          // *** NEW: If "In SMS DB" is checked, we need to filter by phone numbers in messages table ***
          // This is tricky without a direct join. Strategy:
          // 1. Fetch distinct phone numbers from messages (limit to most recent 500?)
          // 2. Or use RPC if available.
          // 3. Or, if searching, search messages first?
          
          let smsDbPhones = null;
          if (filterSmsDb) {
             // Fetch distinct phones from messages
             // Limit to recent messages for performance if no search term
             // If search term exists, we can't limit easily without potentially missing older matches
             // Let's try fetching 1000 most recent message phones
             const { data: msgPhones } = await sb
               .from("messages")
               .select("phone_number")
               .order("timestamp", { ascending: false })
               .limit(1000); // Reasonable limit for client-side filter
             
             if (msgPhones) {
               smsDbPhones = new Set(msgPhones.map(m => normalizePhone(m.phone_number)));
             }
          }

          // Apply search filter (searches across ALL customers in DB)
          if (searchTerm) {
            const searchPattern = `%${searchTerm}%`;
            
            // If it looks like a phone number (mostly digits), prioritize phone search
            const digits = searchTerm.replace(/\D/g, "");
            if (digits.length >= 4) {
               // Flexible phone search
               // Only search the 'phone' column in customers_blaze
               query = query.ilike("phone", `%${digits}%`);
            } else {
               // General search
               query = query.or(
                 `first_name.ilike.${searchPattern},last_name.ilike.${searchPattern},name.ilike.${searchPattern},phone.ilike.${searchPattern},email.ilike.${searchPattern},member_id.ilike.${searchPattern}`
               );
            }
          }

          // Apply filters
          if (filter === "vip") {
            query = query.not("vip_status", "in", '("New",null)');
          } else if (filter === "medical") {
            query = query.eq("is_medical", true);
          } else if (filter === "active") {
            // customers_blaze also has days_since_last_visit or we can calculate from last_visited
            // using last_visited is safer across tables
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            query = query.gte("last_visited", thirtyDaysAgo.toISOString());
          } else if (filter === "churn") {
            query = query.eq("churn_risk", "High");
          }
          
          // Apply checkbox filters
          if (filterPhone) {
            query = query.not("phone", "is", null).neq("phone", "");
          }
          
          if (filterRecent) {
            // Shopped within last 12 months
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            query = query.gte("last_visited", oneYearAgo.toISOString());
          }

          // Apply sorting
          if (sort === "lifetime_desc") {
            query = query.order("lifetime_value", { ascending: false });
          } else if (sort === "visits_desc") {
            query = query.order("total_visits", { ascending: false });
          } else if (sort === "recent") {
            query = query.order("last_visited", {
              ascending: false,
              nullsFirst: false,
            });
          } else if (sort === "name") {
            query = query.order("first_name", { ascending: true });
          } else {
            query = query.order("lifetime_value", { ascending: false });
          }

          // Limit results for performance: 20 default, 100 when searching
          // If filtering by SMS DB client-side, we might need to fetch more
          const limit = searchTerm || filterSmsDb ? 100 : 20;
          query = query.limit(limit);

          const { data, error } = await query;

          if (error) throw error;
          
          let resultData = data || [];
          
          // Client-side filter for "In SMS DB" if we didn't have a better way
          // We also need to enrich ALL results with SMS status
          await enrichWithSmsStatus(resultData);
          
          if (filterSmsDb) {
            // Only keep those with smsStatus.hasHistory
            resultData = resultData.filter(c => c.smsStatus && c.smsStatus.hasHistory);
          }

          customersData = resultData;
          renderCustomerList(customersData);
          setLastRefresh();
          
          // Auto-select the first customer if available
          if (customersData.length > 0 && !searchTerm) {
            selectCustomer(customersData[0]);
          }
        } catch (e) {
          console.error(e);
          alert("Failed to load customers: " + e.message);
        }
      }

      // Helper to check SMS status for a batch of customers
      async function enrichWithSmsStatus(customers) {
        if (!customers || customers.length === 0) return;
        
        const sb = ensureClient();
        // Get all normalized phone numbers
        const phoneMap = new Map(); // normalized -> customer objects
        const phonesToCheck = [];
        
        customers.forEach(c => {
           if (c.phone) {
             const norm = normalizePhone(c.phone);
             if (norm.length >= 10) {
               if (!phoneMap.has(norm)) phoneMap.set(norm, []);
               phoneMap.get(norm).push(c);
               phonesToCheck.push(norm);
             }
           }
        });
        
        if (phonesToCheck.length === 0) return;
        
        // Batch query messages table
        // We want to know: do they have messages? what was the last one?
        // We can't easily do "group by" with supabase client without RPC
        // So we'll just fetch ANY messages for these phones, limit 1000
        // Or use a wildcard ILIKE query for each? No, efficient IN query
        
        // Since we store phones in various formats in messages table, this is hard
        // But assuming most are standard or we can match loosely
        
        // Let's try to match the "normalized" digits against message phone numbers
        // This is imperfect without a normalized column in DB
        // But we can try matching against likely formats? 
        // For now, let's just check exact match against the normalized digits (if DB has them) 
        // OR match typical formats.
        
        // BETTER: use the 'messages' table query with ilike for each phone? Too many queries.
        // compromise: fetch recent 2000 messages and match in memory?
        
        try {
          // Fetch messages that might match (wildcard or exact)
          // This is a "best effort" check for the UI
          const { data: msgs } = await sb
            .from("messages")
            .select("phone_number, timestamp, direction")
            .order("timestamp", { ascending: false })
            .limit(1000); // Get 1000 most recent messages system-wide
            
          if (msgs) {
             // Map phone -> last message info
             const msgHistory = new Map();
             msgs.forEach(m => {
                const p = normalizePhone(m.phone_number);
                if (!msgHistory.has(p)) {
                   msgHistory.set(p, { 
                     lastTime: m.timestamp, 
                     count: 1,
                     direction: m.direction 
                   });
                } else {
                   const entry = msgHistory.get(p);
                   entry.count++;
                }
             });
             
             // Apply to customers
             customers.forEach(c => {
                if (c.phone) {
                   const norm = normalizePhone(c.phone);
                   if (msgHistory.has(norm)) {
                      c.smsStatus = {
                        hasHistory: true,
                        ...msgHistory.get(norm)
                      };
                   }
                }
             });
          }
          
          // If we are filtering by SMS DB specifically, and we missed some because of the 1000 limit,
          // we might need a specific query for the *displayed* customers to be sure.
          // Let's do a specific check for the customers we found
          const specificChecks = phonesToCheck.slice(0, 20); // Check top 20 to avoid massive OR query
          if (specificChecks.length > 0) {
             const orQuery = specificChecks.map(p => `phone_number.ilike.%${p}%`).join(",");
             const { data: specificMsgs } = await sb
               .from("messages")
               .select("phone_number, timestamp, direction")
               .or(orQuery)
               .order("timestamp", { ascending: false });
               
             if (specificMsgs) {
                specificMsgs.forEach(m => {
                   const p = normalizePhone(m.phone_number);
                   customers.forEach(c => {
                      if (c.phone && normalizePhone(c.phone) === p) {
                         // Update if not already set or if this is newer
                         if (!c.smsStatus || new Date(m.timestamp) > new Date(c.smsStatus.lastTime)) {
                           c.smsStatus = {
                             hasHistory: true,
                             lastTime: m.timestamp,
                             direction: m.direction
                           };
                         }
                      }
                   });
                });
             }
          }
          
        } catch (e) {
          console.error("Error checking SMS status:", e);
        }
      }

      function renderCustomerList(data) {
        const tbody = document.querySelector("#customerTable tbody");
        tbody.innerHTML = "";

        const searchTerm = (
          document.getElementById("customerSearch").value || ""
        ).trim();
        const sort = document.getElementById("customerSort").value;

        // Data already filtered and sorted by database query
        const display = data;

        display.forEach((c) => {
          const tr = document.createElement("tr");
          tr.classList.add("clickable");
          tr.addEventListener("click", () => selectCustomer(c));

          const name =
            `${c.first_name || ""} ${c.last_name || ""}`.trim() ||
            c.name ||
            "Unknown";
          const ltv = fmtMoney(parseFloat(c.lifetime_value) || 0);
          const visits = c.total_visits || 0;
          const phone = c.phone || "";
          const hasPhone = phone && phone.trim() !== "";
          const phoneDisplay = hasPhone 
            ? `<span style="color: var(--success);">${phone}</span>` 
            : `<span style="color: var(--danger);">No phone</span>`;

          let statusPills = "";
          // Add SMS Status Pill if applicable
          if (c.smsStatus && c.smsStatus.hasHistory) {
            // Show icon based on direction
            const icon = c.smsStatus.direction === 'inbound' ? 'ðŸ“©' : 'ðŸ“¤';
            // Format time
            let timeStr = "";
            try {
               const d = new Date(c.smsStatus.lastTime);
               // Simple format: Jan 1 or 12:30pm
               const now = new Date();
               if (d.toDateString() === now.toDateString()) {
                  timeStr = d.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
               } else {
                  timeStr = d.toLocaleDateString([], {month: 'short', day: 'numeric'});
               }
            } catch(e) {}
            
            statusPills += `<span class="pill" style="background: var(--panel-light); border: 1px solid var(--border); color: var(--text); font-size: 10px;" title="Last message: ${c.smsStatus.lastTime}">${icon} ${timeStr}</span> `;
          }

          if (c.vip_status && c.vip_status !== "New")
            statusPills += '<span class="pill vip">VIP</span> ';
          if (c.is_medical)
            statusPills += '<span class="pill medical">MED</span> ';
          if (c.churn_risk === "High")
            statusPills += '<span class="pill churn">CHURN</span> ';
          if (!statusPills)
            statusPills = '<span class="pill active">ACTIVE</span>';

          tr.innerHTML = `
          <td><strong>${name}</strong><div class="muted">${
            c.member_id || "No ID"
          }</div></td>
          <td class="nowrap" style="font-family: monospace; font-size: 11px;">${phoneDisplay}</td>
          <td class="nowrap">${visits}</td>
          <td class="nowrap">${ltv}</td>
          <td class="nowrap">${statusPills}</td>
        `;
          tbody.appendChild(tr);
        });

        let suffix;
        if (searchTerm) {
          suffix = "customers found";
        } else if (sort === "lifetime_desc") {
          suffix = "customers (top by LTV)";
        } else if (sort === "visits_desc") {
          suffix = "customers (top by visits)";
        } else if (sort === "recent") {
          suffix = "customers (most recent)";
        } else if (sort === "name") {
          suffix = "customers (Aâ€“Z)";
        } else {
          suffix = "customers";
        }
        const countLabel = `${display.length} ${suffix}`;
        document.getElementById("customerCount").textContent = countLabel;
      }

      // ========== SELECT CUSTOMER ==========
      async function selectCustomer(customer) {
        currentCustomerId = customer.member_id || customer.id;
        currentCustomerData = customer;
        const cardText = document.getElementById("cardText");
        const analyticsText = document.getElementById("analyticsText");

        cardText.textContent = "Loading baseball card...";
        analyticsText.textContent = "Loading analytics...";

        try {
          // Load transactions for this customer
          await loadTransactionsForCustomer(currentCustomerId);

          // Generate baseball card and analytics
          await loadCustomerAnalytics(customer);
          
          // Load SMS thread for this customer
          const customerName = `${customer.first_name || ""} ${customer.last_name || ""}`.trim() || customer.name || "Unknown";
          const phone = customer.phone || customer.phone_number;
          
          if (phone) {
            custCurrentCustomerId = currentCustomerId;
            await loadCustSmsThread(phone, customerName);
          } else {
            document.getElementById("custSmsName").textContent = customerName;
            document.getElementById("custSmsPhone").textContent = "No phone";
            document.getElementById("custSmsThread").innerHTML = '<div class="muted" style="text-align: center; padding: 40px; font-size: 11px;">Customer has no phone number</div>';
            custCurrentPhone = null;
          }
        } catch (e) {
          console.error(e);
          cardText.textContent = "Error loading profile: " + e.message;
          analyticsText.textContent = "";
        }
      }

      // ========== LOAD TRANSACTIONS FOR CUSTOMER ==========
      async function loadTransactionsForCustomer(customerId) {
        const txList = document.getElementById("txList");
        txList.innerHTML = "";
        document.getElementById("itemList").innerHTML = "";
        if (!customerId) return;

        try {
          const sb = ensureClient();
          const r = await sb
            .from("transactions")
            .select(
              "transaction_id, date, created_at, total_amount, payment_type, seller_id"
            )
            .eq("customer_id", customerId)
            .order("date", { ascending: false })
            .limit(100);
          let txs = r.data || [];

          // DEDUPE by transaction_id
          const seen = new Set();
          txs = txs.filter((t) => {
            if (seen.has(t.transaction_id)) return false;
            seen.add(t.transaction_id);
            return true;
          });

          // Show only 10 most recent transactions
          const recentTxs = txs.slice(0, 10);

          // Render as compact items
          for (const t of recentTxs) {
            // Get MOTA %
            const motaPct = await computeMotaPct(t.transaction_id);

            const item = document.createElement("div");
            item.className = "compact-item";
            item.innerHTML = `
              <strong>${fmtDate(t.date || t.created_at)}</strong> â€¢ 
              ${fmtMoney(t.total_amount)} â€¢ 
              ${t.payment_type || "Cash"} â€¢ 
              ${motaPct}% MOTA
            `;
            item.addEventListener("click", () => {
              loadItemsForTransaction(t.transaction_id);
            });
            txList.appendChild(item);
          }
          document.getElementById(
            "txCount"
          ).textContent = `${recentTxs.length} of ${txs.length}`;
        } catch (e) {
          console.error(e);
        }
      }

      // ========== LOAD ITEMS FOR TRANSACTION ==========
      async function loadItemsForTransaction(transactionId) {
        const itemList = document.getElementById("itemList");
        itemList.innerHTML = "";
        if (!transactionId) return;
        try {
          const sb = ensureClient();
          const r = await sb
            .from("transaction_items_blaze")
            .select(
              "product_name, brand, quantity, total_price, unit_price, category"
            )
            .eq("transaction_id", transactionId)
            .order("id", { ascending: false });
          const items = r.data || [];

          // Add grid class for items
          itemList.classList.add("items-grid");

          for (const it of items) {
            const total =
              it.total_price != null && it.total_price !== 0
                ? it.total_price
                : Number(it.unit_price || 0) * Number(it.quantity || 1);
            const item = document.createElement("div");
            item.className = "compact-item";
            item.innerHTML = `
              <div style="font-weight:600; margin-bottom:3px;">${
                it.product_name || "â€”"
              }</div>
              <div style="color:var(--muted); font-size:10px; margin-bottom:3px;">${
                it.brand || "â€”"
              }</div>
              <div style="margin-bottom:3px;">Qty: ${Number(
                it.quantity || 0
              ).toFixed(1)}</div>
              <div style="color:var(--accent); font-weight:600;">${fmtMoney(
                total
              )}</div>
            `;
            itemList.appendChild(item);
          }
          document.getElementById("itemCount").textContent = items.length;
        } catch (e) {
          console.error(e);
        }
      }

      // ========== COMPUTE MOTA PERCENTAGE ==========
      async function computeMotaPct(transactionId) {
        try {
          const sb = ensureClient();
          const r = await sb
            .from("transaction_items_blaze")
            .select("brand, total_price, unit_price, quantity")
            .eq("transaction_id", transactionId);
          const items = r.data || [];
          if (!items.length) return 0;
          let total = 0,
            mota = 0;
          for (const it of items) {
            const val =
              Number(it.total_price || 0) ||
              Number(it.unit_price || 0) * Number(it.quantity || 1);
            total += val;
            if ((it.brand || "").toUpperCase().includes("MOTA")) mota += val;
          }
          return total > 0 ? Math.round((mota / total) * 100) : 0;
        } catch {
          return 0;
        }
      }

      // ========== LOAD CUSTOMER ANALYTICS ==========
      async function loadCustomerAnalytics(customer) {
        try {
          const sb = ensureClient();
          const customerId =
            customer.member_id || customer.customer_id || customer.id;

          // Fetch transactions
          const { data: txs, error: txError } = await sb
            .from("transactions")
            .select("*")
            .eq("customer_id", customerId)
            .order("date", { ascending: false })
            .limit(500);

          if (txError) throw txError;

          if (!txs || txs.length === 0) {
            document.getElementById("cardText").textContent =
              "No transaction history available.";
            document.getElementById("analyticsText").textContent = "";
            return;
          }

          // Fetch transaction items
          const txIds = txs.map((t) => t.transaction_id).filter(Boolean);
          let itemsList = [];
          for (let i = 0; i < txIds.length; i += 200) {
            const batch = txIds.slice(i, i + 200);
            const { data: batchItems } = await sb
              .from("transaction_items_blaze")
              .select("*")
              .in("transaction_id", batch);
            if (batchItems) itemsList = itemsList.concat(batchItems);
          }

          // Build baseball card and analytics text
          const cardText = await buildBaseballCard(customer, txs, itemsList);
          const analyticsText = await buildAnalyticsText(
            customer,
            txs,
            itemsList
          );

          document.getElementById("cardText").textContent = cardText;
          document.getElementById("analyticsText").textContent = analyticsText;
        } catch (e) {
          console.error(e);
          document.getElementById("cardText").textContent =
            "Error loading analytics: " + e.message;
          document.getElementById("analyticsText").textContent = "";
        }
      }

      // ========== BUILD BASEBALL CARD TEXT ==========
      async function buildBaseballCard(customer, txs, itemsList) {
        const name =
          customer.name ||
          `${customer.first_name || ""} ${customer.last_name || ""}`.trim() ||
          "Unknown";
        const age = calculateAge(customer.date_of_birth);
        const lifetime = parseFloat(customer.lifetime_value) || 0;
        const visits = txs.length;
        const avgTicket =
          visits > 0
            ? txs.reduce((a, t) => a + (parseFloat(t.total_amount) || 0), 0) /
              visits
            : 0;
        const vipStatus =
          (customer.vip_status || "").toUpperCase() || "REGULAR";
        const lastVisit = txs[0]?.date
          ? fmtDate(txs[0].date)
          : txs[0]?.created_at
          ? fmtDate(txs[0].created_at)
          : "â€”";
        const joinDate = customer.created_at
          ? new Date(customer.created_at).toLocaleDateString("en-US", {
              month: "2-digit",
              day: "2-digit",
              year: "numeric",
            })
          : "N/A";

        // Calculate items per transaction
        const totalItemsCount = itemsList.length;
        const avgItemsPerTx =
          visits > 0 ? (totalItemsCount / visits).toFixed(1) : "0";

        // Category spending
        const categorySpend = {};
        itemsList.forEach((item) => {
          const cat = item.category || "Other";
          const price = parseFloat(
            item.total_price || item.final_price || item.unit_price || 0
          );
          categorySpend[cat] = (categorySpend[cat] || 0) + price;
        });

        // Top brands
        const brandSpend = {};
        itemsList.forEach((item) => {
          const brand = (item.brand || "Unknown").trim();
          const price = parseFloat(
            item.total_price || item.final_price || item.unit_price || 0
          );
          brandSpend[brand] = (brandSpend[brand] || 0) + price;
        });
        const topBrands = Object.entries(brandSpend)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(([brand, spend]) => `   ${brand.padEnd(20)} ${fmtMoney(spend)}`);

        // Top products
        const itemCounts = {};
        itemsList.forEach((item) => {
          const productName =
            item.product_name && item.product_name.toLowerCase() !== "null"
              ? item.product_name
              : "Unknown Product";
          const key = `${productName} (${item.brand || "Unknown"})`;
          itemCounts[key] = (itemCounts[key] || 0) + 1;
        });
        const topItems = Object.entries(itemCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 7)
          .map(
            ([name, count], i) => `   ${i + 1}. ${name} - ${count} purchases`
          );

        // Format birthday
        const birthday = customer.date_of_birth 
          ? new Date(customer.date_of_birth).toLocaleDateString("en-US", {
              month: "2-digit",
              day: "2-digit",
              year: "numeric",
            })
          : "N/A";

        return [
          `${name}`,
          `${age || "Unknown"} years old â€¢ ${
            customer.is_medical ? "Medical" : "Recreational"
          }`,
          ``,
          `KEY STATS`,
          `Lifetime Value : ${fmtMoney(lifetime)}`,
          `Total Visits   : ${visits}`,
          `Avg Ticket     : ${fmtMoney(avgTicket)}`,
          `Items/Trans    : ${avgItemsPerTx}`,
          `VIP Status     : ${vipStatus}`,
          `Last Visit     : ${lastVisit}`,
          `Loyalty Points : ${customer.loyalty_points || 0}`,
          ``,
          `SPENDING BY CATEGORY`,
          ...Object.entries(categorySpend)
            .sort((a, b) => b[1] - a[1])
            .map(([cat, spend]) => `   ${cat.padEnd(15)} ${fmtMoney(spend)}`),
          ``,
          `TOP 5 BRANDS BY SPEND`,
          ...topBrands,
          ``,
          `TOP 7 PURCHASED ITEMS`,
          ...topItems,
          ``,
          `CONTACT`,
          `Phone      : ${customer.phone || "N/A"}`,
          `Email      : ${customer.email || "N/A"}`,
          `Birthday   : ${birthday}`,
          `SMS Opt-in : ${customer.text_opt_in ? "Yes" : "No"}`,
          `Email Opt  : ${customer.email_opt_in ? "Yes" : "No"}`,
          ``,
          `TIMELINE`,
          `Member Since   : ${joinDate}`,
        ].join("\n");
      }

      // ========== BUILD ANALYTICS TEXT ==========
      async function buildAnalyticsText(customer, txs, itemsList) {
        if (!txs.length) return "No transactions found.";

        const sb = ensureClient();

        // Calculate days active
        const now = new Date();
        const oldestTx = txs[txs.length - 1];
        const oldestDate = oldestTx?.date
          ? new Date(oldestTx.date)
          : oldestTx?.created_at
          ? new Date(oldestTx.created_at)
          : now;
        const daysActive = Math.floor(
          (now - oldestDate) / (1000 * 60 * 60 * 24)
        );

        // Calculate avg visits per month
        const avgVisitsPerMonth =
          daysActive > 0 ? ((txs.length / daysActive) * 30).toFixed(1) : "N/A";

        // Monthly breakdown
        const months = new Map();
        txs.forEach((t) => {
          let dateStr = t.date || t.created_at;
          if (!dateStr) return;
          const key = dateStr.substring(0, 7); // YYYY-MM
          months.set(key, (months.get(key) || 0) + 1);
        });

        // Get last 12 months
        let lastMonthStr = "2025-11";
        if (months.size > 0) {
          const sortedMonths = Array.from(months.keys()).sort().reverse();
          lastMonthStr = sortedMonths[0];
        }

        const [lastYear, lastMonth] = lastMonthStr.split("-").map(Number);
        const lastDate = new Date(lastYear, lastMonth - 1, 1);

        const allMonths = [];
        for (let i = 0; i < 12; i++) {
          const d = new Date(
            lastDate.getFullYear(),
            lastDate.getMonth() - i,
            1
          );
          const key = `${String(d.getFullYear()).slice(-2)}-${String(
            d.getMonth() + 1
          ).padStart(2, "0")}`;
          allMonths.unshift(key);
        }

        const sorted = allMonths
          .map((k) => {
            const [yy, mm] = k.split("-");
            const yyyy = "20" + yy;
            const dataKey = `${yyyy}-${mm}`;
            const count = months.get(dataKey) || 0;
            return [k, count];
          })
          .reverse();

        const max = Math.max(1, ...sorted.map(([_, c]) => c));
        const monthlyLines = sorted
          .map(([k, c]) => {
            const barLength = Math.round((c / max) * 20);
            const bar = c > 0 ? "â– ".repeat(barLength) : "";
            return `${k}  ${String(c).padStart(2, " ")}  ${bar}`;
          })
          .join("\n");

        // MOTA calculation
        let total = 0,
          mota = 0;
        itemsList.forEach((it) => {
          const val =
            Number(it.total_price || 0) ||
            Number(it.unit_price || 0) * Number(it.quantity || 1);
          total += val;
          if ((it.brand || "").toUpperCase().includes("MOTA")) mota += val;
        });
        const motaPct = total > 0 ? Math.round((mota / total) * 100) : 0;

        // Budtender breakdown
        const budtenderMap = new Map();
        for (const tx of txs) {
          const sellerId = tx.seller_id;
          if (!sellerId) continue;
          if (!budtenderMap.has(sellerId)) {
            budtenderMap.set(sellerId, { count: 0, total: 0, name: null });
          }
          const bd = budtenderMap.get(sellerId);
          bd.count += 1;
          bd.total += Number(tx.total_amount || 0);
        }

        // Fetch budtender names
        const sellerIds = Array.from(budtenderMap.keys());
        const nameMap = {};
        if (sellerIds.length > 0) {
          try {
            const emRes = await sb
              .from("employees_blaze")
              .select("employee_id, name")
              .in("employee_id", sellerIds);
            if (emRes.data) {
              emRes.data.forEach((em) => {
                nameMap[em.employee_id] = em.name || em.employee_id;
              });
            }
          } catch (e) {
            console.error("Budtender lookup error:", e);
          }
        }

        for (const [sellerId, data] of budtenderMap.entries()) {
          data.name = nameMap[sellerId] || sellerId;
        }

        const budtenderLines = Array.from(budtenderMap.entries())
          .sort((a, b) => b[1].count - a[1].count)
          .slice(0, 5)
          .map(
            ([_, data]) =>
              `   ${data.name}: ${data.count} txs (${fmtMoney(data.total)})`
          )
          .join("\n");

        // Generate recommendations
        const recommendations = [];
        const avgTicket =
          txs.length > 0
            ? txs.reduce(
                (sum, t) => sum + (parseFloat(t.total_amount) || 0),
                0
              ) / txs.length
            : 0;
        const daysSinceLastVisit = customer.days_since_last_visit || 0;

        if (motaPct < 30) {
          recommendations.push(
            `ðŸŽ¯ MOTA Upsell: Only ${motaPct}% MOTA. Recommend signature strains.`
          );
        }
        if (daysSinceLastVisit > 60) {
          recommendations.push(
            `ðŸ“¬ Re-engage: ${daysSinceLastVisit}d since last visit. Send offer.`
          );
        }
        if (avgTicket < 40) {
          recommendations.push(
            `ðŸ’° Increase basket: Avg ${fmtMoney(avgTicket)}. Suggest bundles.`
          );
        }
        if (
          txs.length > 10 &&
          (!customer.vip_status || customer.vip_status === "New")
        ) {
          recommendations.push(
            `â­ VIP Upgrade: ${txs.length} visits qualify for VIP!`
          );
        }

        // Last 5 visits with budtender names and items (Moved from Baseball Card)
        const last5Visits = [];
        const last5Txs = txs.slice(0, 5);
        
        // Group items by transaction_id
        const itemsByTx = {};
        itemsList.forEach((item) => {
          const txId = item.transaction_id;
          if (!txId) return;
          if (!itemsByTx[txId]) itemsByTx[txId] = [];
          itemsByTx[txId].push(item);
        });

        // Re-fetch seller names for last 5 visits if not covered by budtender breakdown
        const sellerIdsForVisits = last5Txs
          .map((t) => t.seller_id)
          .filter(Boolean)
          .filter((v, i, a) => a.indexOf(v) === i);
          
        const extraSellerIds = sellerIdsForVisits.filter(id => !nameMap[id]);
        
        if (extraSellerIds.length > 0) {
           try {
            const emRes = await sb
              .from("employees_blaze")
              .select("employee_id, name")
              .in("employee_id", extraSellerIds);
            if (emRes.data) {
              emRes.data.forEach((em) => {
                nameMap[em.employee_id] = em.name || em.employee_id;
              });
            }
          } catch (e) {
            console.debug("Budtender lookup error:", e);
          }
        }

        for (const tx of last5Txs) {
          const date = fmtDate(tx.date || tx.created_at);
          const amount = fmtMoney(parseFloat(tx.total_amount) || 0);
          const budtenderName = nameMap[tx.seller_id] || tx.seller_id || "â€”";
          last5Visits.push(`   ${date}  ${amount}  ${budtenderName}`);
          
          // Add items purchased in this transaction
          const txItems = itemsByTx[tx.transaction_id] || [];
          txItems.forEach((item) => {
            const productName = item.product_name && item.product_name.toLowerCase() !== "null" 
              ? item.product_name 
              : "Unknown Product";
            const qty = item.quantity || 1;
            const brand = item.brand || "";
            // Truncate long product names
            const displayName = productName.length > 40 ? productName.substring(0, 37) + "..." : productName;
            last5Visits.push(`      â€¢ ${displayName}${brand ? ` (${brand})` : ""}${qty > 1 ? ` x${qty}` : ""}`);
          });
        }

        return [
          `OVERVIEW`,
          `Total Visits      : ${txs.length}`,
          `Days Active       : ${daysActive} days`,
          `Avg Visits/Month  : ${avgVisitsPerMonth}`,
          `First Visit       : ${
            customer.created_at
              ? new Date(customer.created_at).toLocaleDateString()
              : "N/A"
          }`,
          `Last Visit        : ${
            txs[0]?.date
              ? new Date(txs[0].date).toLocaleDateString()
              : txs[0]?.created_at
              ? new Date(txs[0].created_at).toLocaleDateString()
              : "N/A"
          }`,
          ``,
          `MONTHLY (last 12)`,
          monthlyLines || "â€”",
          ``,
          `MOTA % (by spend) : ${motaPct}%`,
          `Total Spend       : ${fmtMoney(total)}`,
          `MOTA Spend        : ${fmtMoney(mota)}`,
          ``,
          `TOP BUDTENDERS`,
          budtenderLines || "   (No data)",
          ``,
          `LAST 5 VISITS`,
          ...last5Visits,
          ``,
          `ðŸ’¡ RECOMMENDATIONS`,
          ...recommendations.map((r) => `   ${r}`),
        ].join("\n");
      }

      // Analytics rendering functions removed - now using baseball card and analytics text format

      // ========== RENDER BUDTENDER ANALYTICS SECTIONS ==========
      function renderBudtenderAnalyticsSection(section) {
        currentBudAnalyticsSection = section;
        const analyticsContent = document.getElementById(
          "budtenderAnalyticsContent"
        );
        const navItems = document.querySelectorAll(
          "#budtendersAnalyticsView .analytics-nav-item"
        );
        navItems.forEach((item) => {
          item.classList.toggle("active", item.dataset.section === section);
        });

        const data = window.budtenderAnalyticsData;
        if (!data) {
          analyticsContent.innerHTML =
            '<div class="muted">Select a budtender to view analytics.</div>';
          return;
        }

        // Clear budtender-specific charts (reuse same registry)
        Object.values(chartInstances).forEach((chart) => chart.destroy());
        chartInstances = {};

        if (section === "performance") {
          renderBudPerformanceSection(analyticsContent, data);
        } else if (section === "products") {
          renderBudProductsSection(analyticsContent, data);
        } else if (section === "transactions") {
          renderBudTransactionsSection(analyticsContent, data);
        } else if (section === "coaching") {
          renderBudCoachingSection(analyticsContent, data);
        }
      }

      function renderBudPerformanceSection(container, data) {
        const {
          budtender,
          txs,
          motaPct,
          motaItems,
          uniqueCustomers,
          totalSales,
          avgTicket,
          sales7d,
          sales30d,
          sales365d,
          tx7d,
          tx30d,
        } = data;
        const totalTx = txs.length;

        const avgTicket7 = tx7d > 0 ? sales7d / tx7d : 0;
        const avgTicket30 = tx30d > 0 ? sales30d / tx30d : 0;

        // Monthly sales (revenue) last 12 months
        const monthlySales = {};
        txs.forEach((t) => {
          const d = t.date || t.completed_time || t.created_at;
          if (!d) return;
          const month = d.substring(0, 7);
          const amt = parseFloat(t.total_amount) || 0;
          monthlySales[month] = (monthlySales[month] || 0) + amt;
        });
        const monthKeys = Object.keys(monthlySales).sort().slice(-12);

        container.innerHTML = `
        <div class="section">
          <div class="title">Performance Metrics (Last 7 Days & Last 30 Days)</div>
          <div class="metric-grid">
            <div class="metric-box">
              <div class="metric-label">Sales (Last 7 Days)</div>
              <div class="metric-value">${fmtMoney(sales7d || 0)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Transactions (Last 7 Days)</div>
              <div class="metric-value">${(tx7d || 0).toLocaleString()}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Avg Ticket (Last 7 Days)</div>
              <div class="metric-value">${fmtMoney(avgTicket7 || 0)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Sales (Last 30 Days)</div>
              <div class="metric-value">${fmtMoney(sales30d || 0)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Transactions (Last 30 Days)</div>
              <div class="metric-value">${(tx30d || 0).toLocaleString()}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Avg Ticket (Last 30 Days)</div>
              <div class="metric-value">${fmtMoney(avgTicket30 || 0)}</div>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="title">Performance Metrics (Last 6 Months)</div>
          <div class="metric-grid">
            <div class="metric-box">
              <div class="metric-label">Total Transactions</div>
              <div class="metric-value">${totalTx}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Total Sales</div>
              <div class="metric-value">${fmtMoney(totalSales || 0)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Avg Ticket</div>
              <div class="metric-value">${fmtMoney(avgTicket || 0)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Unique Customers</div>
              <div class="metric-value">${uniqueCustomers || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">MOTA Expertise</div>
              <div class="metric-value">${motaPct}%</div>
              <div class="muted">${motaItems.length} items</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Sales (Last 365 Days)</div>
              <div class="metric-value">${fmtMoney(sales365d || 0)}</div>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="title">Monthly Sales (Last 12 Months)</div>
          <div class="chart-container large">
            <canvas id="budMonthlySalesChart"></canvas>
          </div>
        </div>
      `;

        const ctx = document.getElementById("budMonthlySalesChart");
        if (ctx && window.Chart && monthKeys.length > 0) {
          chartInstances.budMonthlySales = new Chart(ctx.getContext("2d"), {
            type: "bar",
            data: {
              labels: monthKeys,
              datasets: [
                {
                  label: "Sales",
                  data: monthKeys.map((k) => monthlySales[k]),
                  backgroundColor: "#c87533",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { grid: { display: false }, ticks: { color: "#a89584" } },
                y: {
                  beginAtZero: true,
                  ticks: { color: "#a89584" },
                  grid: { color: "#4a3830" },
                },
              },
            },
          });
        }
      }

      function renderBudProductsSection(container, data) {
        const { itemsList } = data;
        if (!itemsList || !itemsList.length) {
          container.innerHTML =
            '<div class="muted">No product data available for this budtender.</div>';
          return;
        }

        const categorySpend = {};
        const brandSpend = {};
        itemsList.forEach((item) => {
          const cat = item.category || "Other";
          const brand = item.brand || "Unknown";
          const price = parseFloat(item.total_price || item.final_price || 0);
          categorySpend[cat] = (categorySpend[cat] || 0) + price;
          brandSpend[brand] = (brandSpend[brand] || 0) + price;
        });

        const topCategories = Object.entries(categorySpend)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        const topBrands = Object.entries(brandSpend)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        container.innerHTML = `
        <div class="section">
          <div class="title">Top Categories by Sales</div>
          <div class="chart-container">
            <canvas id="budCategoryChart"></canvas>
          </div>
        </div>
        <div class="section">
          <div class="title">Top Brands</div>
          <div class="product-list">
            ${topBrands
              .map(
                ([brand, amt]) => `
              <div class="product-item">
                <span class="product-name">${brand}</span>
                <span class="product-stats">${fmtMoney(amt)}</span>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;

        const ctx = document.getElementById("budCategoryChart");
        if (ctx && window.Chart && topCategories.length) {
          const colors = [
            "#c87533",
            "#d88a4a",
            "#e8a547",
            "#5d8a3a",
            "#a89584",
          ];
          chartInstances.budCategory = new Chart(ctx.getContext("2d"), {
            type: "doughnut",
            data: {
              labels: topCategories.map(([c]) => c),
              datasets: [
                {
                  data: topCategories.map(([, amt]) => amt),
                  backgroundColor: colors.slice(0, topCategories.length),
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: "bottom", labels: { color: "#f5ede4" } },
              },
            },
          });
        }
      }

      async function renderBudTransactionsSection(container, data) {
        const { txs, itemsList } = data;
        if (!txs || !txs.length) {
          container.innerHTML =
            '<div class="muted">No transactions found for this budtender in the selected period.</div>';
          return;
        }

        // Map transaction_id -> items to compute MOTA %
        const itemsByTx = new Map();
        (itemsList || []).forEach((it) => {
          const id = it.transaction_id;
          if (!id) return;
          if (!itemsByTx.has(id)) itemsByTx.set(id, []);
          itemsByTx.get(id).push(it);
        });

        const recent = txs.slice(0, 20);

        // Batch resolve customer names for recent transactions
        const customerIds = [...new Set(recent.map(t => t.customer_id).filter(Boolean))];
        const customerNames = {};
        if (customerIds.length > 0) {
          try {
            const sb = ensureClient();
            const { data: custData } = await sb.from("customers")
              .select("member_id, first_name, last_name, name")
              .in("member_id", customerIds);
            (custData || []).forEach(c => {
              const name = `${c.first_name || ""} ${c.last_name || ""}`.trim() || c.name || c.member_id;
              customerNames[c.member_id] = name;
            });
          } catch (e) { console.debug("Customer name lookup error:", e); }
        }

        // Store globally so we can render details on click
        window.currentBudTxItemsById = itemsByTx;
        const txById = new Map();
        txs.forEach((t) => {
          if (t.transaction_id) txById.set(t.transaction_id, t);
        });
        window.currentBudTxById = txById;
        window.currentBudCustomerNames = customerNames;
        
        const rows = recent
          .map((t) => {
            const items = itemsByTx.get(t.transaction_id) || [];
            let total = 0;
            let mota = 0;
            items.forEach((it) => {
              const val =
                Number(it.total_price || 0) ||
                Number(it.unit_price || 0) * Number(it.quantity || 1);
              total += val;
              if ((it.brand || "").toUpperCase().includes("MOTA")) {
                mota += val;
              }
            });
            const motaPct =
              total > 0 ? Math.round((mota / total) * 100) + "%" : "â€”";
            
            // Resolve customer name
            const custName = customerNames[t.customer_id] || t.customer_id || "â€”";
            const custDisplay = custName.length > 20 ? custName.substring(0, 18) + "..." : custName;

            return `
            <tr class="clickable" onclick="showBudTransactionDetail('${
              t.transaction_id
            }')">
              <td class="nowrap">${fmtDate(t.date || t.created_at)}</td>
              <td class="nowrap" title="${custName}">${custDisplay}</td>
              <td class="nowrap">${fmtMoney(
                parseFloat(t.total_amount) || 0
              )}</td>
              <td class="nowrap">${t.payment_type || "Unknown"}</td>
              <td class="nowrap">${motaPct}</td>
            </tr>`;
          })
          .join("");

        container.innerHTML = `
        <div class="section">
          <div class="title">Recent Transactions (Last 12 Months)</div>
          <div class="list" style="max-height:320px;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Customer</th>
                  <th>Amount</th>
                  <th>Payment</th>
                  <th>MOTA %</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
          <div class="muted" style="margin-top:8px;">
            Showing ${recent.length} of ${txs.length} transactions (last 12 months).
          </div>
        </div>
        <div class="section">
          <div class="title">Transaction Details</div>
          <div id="budTransactionDetail" class="terminal">
            Select a transaction above to see item-level details and MOTA mix.
          </div>
        </div>
      `;
      }

      // Detail panel for a single transaction in the Transactions tab
      function showBudTransactionDetail(transactionId) {
        const detailEl = document.getElementById("budTransactionDetail");
        if (!detailEl || !transactionId) return;
        const itemsByTx = window.currentBudTxItemsById || new Map();
        const txById = window.currentBudTxById || new Map();
        const customerNames = window.currentBudCustomerNames || {};
        const items = itemsByTx.get(transactionId) || [];
        const tx = txById.get(transactionId);

        if (!tx && !items.length) {
          detailEl.innerHTML =
            "No additional details available for this transaction.";
          return;
        }

        let total = 0;
        let mota = 0;
        items.forEach((it) => {
          const val =
            Number(it.total_price || 0) ||
            Number(it.unit_price || 0) * Number(it.quantity || 1);
          total += val;
          if ((it.brand || "").toUpperCase().includes("MOTA")) {
            mota += val;
          }
        });
        const motaPct =
          total > 0 ? Math.round((mota / total) * 100) + "%" : "â€”";

        const itemLines = items.length
          ? items
              .map((it) => {
                const val =
                  Number(it.total_price || 0) ||
                  Number(it.unit_price || 0) * Number(it.quantity || 1);
                return `â€¢ ${it.product_name || "Unknown product"} (${
                  it.brand || "Unknown brand"
                }) â€“ Qty: ${Number(it.quantity || 0).toFixed(1)}, ${fmtMoney(
                  val
                )}`;
              })
              .join("<br>")
          : "No item-level details available.";

        // Resolve customer name
        const custName = customerNames[tx?.customer_id] || tx?.customer_id || "Unknown";

        detailEl.innerHTML = `
          <div><strong>Transaction ID:</strong> ${transactionId}</div>
          <div><strong>Customer:</strong> ${custName}</div>
          <div><strong>Date:</strong> ${fmtDate(tx?.date || tx?.created_at)}</div>
          <div><strong>Total Amount:</strong> ${fmtMoney(
            parseFloat(tx?.total_amount) || total || 0
          )}</div>
          <div><strong>Payment Type:</strong> ${tx?.payment_type || "Unknown"}</div>
          <div><strong>MOTA % (by value):</strong> ${motaPct}</div>
          <div style="margin-top:8px;"><strong>Items:</strong></div>
          <div>${itemLines}</div>
        `;
      }

      function renderBudCoachingSection(container, data) {
        const {
          recommendations,
          totalSales,
          avgTicket,
          uniqueCustomers,
          motaPct,
          sales7d,
          sales30d,
          sales365d,
        } = data;
        const recHtml =
          recommendations && recommendations.length
            ? recommendations
                .map((rec) => '<div class="rec-item">' + rec + "</div>")
                .join("")
            : '<div class="muted">No coaching recommendations at this time.</div>';

        container.innerHTML = `
        <div class="section">
          <div class="title">Performance Snapshot</div>
          <div class="terminal">
            <div><strong>Total Sales (12m):</strong> ${fmtMoney(totalSales || 0)}</div>
            <div><strong>Average Ticket:</strong> ${fmtMoney(avgTicket || 0)}</div>
            <div><strong>Unique Customers:</strong> ${uniqueCustomers || 0}</div>
            <div><strong>MOTA Share:</strong> ${motaPct || 0}%</div>
            <div><strong>Sales Last 7 Days:</strong> ${fmtMoney(sales7d || 0)}</div>
            <div><strong>Sales Last 30 Days:</strong> ${fmtMoney(sales30d || 0)}</div>
            <div><strong>Sales Last 365 Days:</strong> ${fmtMoney(
              sales365d || 0
            )}</div>
          </div>
        </div>
        <div class="recommendations">
          <div class="rec-title">ðŸ’¡ Budtender Coaching & Growth Recommendations</div>
          ${recHtml}
        </div>
      `;
      }

      // ========== LOAD BUDTENDERS ==========
      async function loadBudtenders() {
        try {
          const sb = ensureClient();
          document.getElementById("budtenderProfileContent").innerHTML =
            '<div class="loading">Loading budtenders...</div>';

          // Load core budtenders list
          const { data, error } = await sb
            .from("budtenders")
            .select("*")
            .order("points", { ascending: false })
            .limit(500);
          if (error) throw error;
          budtendersData = data || [];

          // Load staging metrics for enrichment
          const { data: stagingRows } = await sb
            .from("mr_budtenders_staging")
            .select("*");
          const stagingByEmail = new Map();
          const stagingByPhone = new Map();
          (stagingRows || []).forEach((row) => {
            const emailLower = (row.email_lower || row.email || "")
              .toLowerCase()
              .trim();
            if (emailLower) stagingByEmail.set(emailLower, row);
            const phoneDigits = (row.phone_digits || "").trim();
            if (phoneDigits) stagingByPhone.set(phoneDigits, row);
          });

          // Load Blaze employees (to map to seller_id)
          const { data: employeeRows } = await sb
            .from("employees_blaze")
            .select(
              "employee_id, first_name, last_name, email, name, role_name, is_disabled, shop_ids"
            );
          const employeesByEmail = new Map();
          const employeesByName = new Map();
          const employeesById = new Map();
          (employeeRows || []).forEach((row) => {
            const emailLower = (row.email || "").toLowerCase().trim();
            if (emailLower) employeesByEmail.set(emailLower, row);
            const fullName = `${row.first_name || ""} ${row.last_name || ""}`
              .trim()
              .toLowerCase();
            if (fullName) employeesByName.set(fullName, row);
            if (row.employee_id) employeesById.set(row.employee_id, row);
          });

          // Enrich EXTERNAL budtenders (tabla budtenders) con datos de staging
          for (let bt of budtendersData) {
            const fullName = `${bt.first_name || ""} ${bt.last_name || ""}`
              .trim()
              .toLowerCase();
            const emailLower = (bt.email || "").toLowerCase().trim();

            // 1) Enrich from staging (sales attributed, points, tier)
            let staging =
              stagingByEmail.get(emailLower) ||
              stagingByPhone.get((bt.phone || "").replace(/\D/g, ""));
            if (staging) {
              bt.staging_total_sales_attributed =
                parseFloat(staging.total_sales_attributed) || 0;
              bt.staging_total_points = staging.total_points || 0;
              bt.performance_tier =
                staging.performance_tier || bt.performance_tier;
              bt.staging_dispensary = staging.dispensary || bt.dispensary_name;
              bt.hire_date = staging.hire_date || bt.hire_date;
            }

            // Todos los registros actuales de la tabla `budtenders`
            // se consideran EXTERNAL por defecto (no tienen seller_id conocido).
            bt.budtender_type = "EXTERNAL";
            bt.transactions_count = bt.transactions_count || 0;
            bt.total_sales = bt.total_sales || 0;
            bt.avg_ticket = bt.avg_ticket || 0;
          }

          // ========== INTERNAL BUDTENDERS (MAIN + HISTORICAL, basados en seller_id) ==========
          // Agregamos seller_id de `transactions_blaze` y los clasificamos:
          // - MAIN: seller_id existe en employees_blaze.employee_id
          // - HISTORICAL: seller_id NO existe en employees_blaze
          const { data: internalTxs, error: internalError } = await sb
            .from("transactions_blaze")
            .select("seller_id, total_amount")
            .not("seller_id", "is", null);
          if (internalError) throw internalError;

          const bySeller = new Map();
          (internalTxs || []).forEach((row) => {
            const sellerId = row.seller_id;
            if (!sellerId) return;
            const amt = parseFloat(row.total_amount) || 0;
            let agg = bySeller.get(sellerId);
            if (!agg) agg = { total_sales: 0, tx_count: 0 };
            agg.total_sales += amt;
            agg.tx_count += 1;
            bySeller.set(sellerId, agg);
          });

          const internalBudtenders = [];
          bySeller.forEach((agg, sellerId) => {
            const emp = employeesById.get(sellerId);
            // Solo queremos MAIN (con empleado en Blaze). Los HISTORICAL se omiten.
            if (!emp) return;

            const totalSales = agg.total_sales || 0;
            const txCount = agg.tx_count || 0;
            const avgTicket = txCount > 0 ? totalSales / txCount : 0;

            internalBudtenders.push({
              id: sellerId, // usamos seller_id como identificador Ãºnico para internos
              seller_id: sellerId,
              first_name: emp.first_name || "",
              last_name: emp.last_name || "",
              email: emp.email || null,
              phone: emp.phone || null,
              dispensary_name: null,
              points: 0,
              employee_id: emp.employee_id,
              budtender_type: "MAIN",
              total_sales: totalSales,
              transactions_count: txCount,
              avg_ticket: avgTicket,
              performance_tier: null,
              hire_date: null,
              role_name: emp.role_name || null,
              is_disabled: emp.is_disabled,
              shop_ids: emp.shop_ids || [],
            });
          });

          // Mezclamos INTERNAL (MAIN + HISTORICAL) con EXTERNAL (tabla budtenders)
          budtendersData = [...internalBudtenders, ...budtendersData];

          // Poblar filtro de dispensario con los nombres Ãºnicos de budtenders (principalmente EXTERNAL)
          const dispSelect = document.getElementById(
            "budtenderDispensaryFilter"
          );
          if (dispSelect) {
            const dispensaries = new Set();
            budtendersData.forEach((bt) => {
              if (bt.dispensary_name) {
                dispensaries.add(bt.dispensary_name);
              }
            });
            const sorted = Array.from(dispensaries).sort((a, b) =>
              a.localeCompare(b)
            );
            // Limpiar excepto la opciÃ³n "all"
            dispSelect.innerHTML =
              '<option value="all">All Dispensaries</option>' +
              sorted
                .map(
                  (d) =>
                    `<option value="${d.toLowerCase()}">${d}</option>`
                )
                .join("");
          }

          renderBudtenderList(budtendersData);
          setLastRefresh();
        } catch (e) {
          console.error(e);
          alert("Failed to load budtenders: " + e.message);
        }
      }

      function renderBudtenderList(data) {
        const tbody = document.querySelector("#budtenderTable tbody");
        tbody.innerHTML = "";

        const searchTerm = (
          document.getElementById("budtenderSearch").value || ""
        ).toLowerCase();
        const filter = document.getElementById("budtenderFilter").value;
        const dispFilter =
          (document.getElementById("budtenderDispensaryFilter") &&
            document
              .getElementById("budtenderDispensaryFilter")
              .value.toLowerCase()) ||
          "all";
        const sort = document.getElementById("budtenderSort").value;

        let filtered = data.filter((bt) => {
          const searchText = `${bt.first_name || ""} ${bt.last_name || ""} ${
            bt.dispensary_name || ""
          }`.toLowerCase();
          if (searchTerm && !searchText.includes(searchTerm)) return false;

          const type = bt.budtender_type || (bt.employee_id ? "MAIN" : "EXTERNAL");
          if (filter === "main") {
            if (type !== "MAIN") return false;
          } else if (filter === "external") {
            if (type !== "EXTERNAL") return false;
          }

          if (dispFilter !== "all") {
            const d = (bt.dispensary_name || "").toLowerCase();
            if (d !== dispFilter) return false;
          }

          return true;
        });

        if (sort === "points_desc") {
          filtered.sort((a, b) => (b.points || 0) - (a.points || 0));
        } else if (sort === "name") {
          filtered.sort((a, b) => {
            const aName = `${a.first_name || ""} ${a.last_name || ""}`.trim();
            const bName = `${b.first_name || ""} ${b.last_name || ""}`.trim();
            return aName.localeCompare(bName);
          });
        } else if (sort === "dispensary") {
          filtered.sort((a, b) => {
            const ad = (a.dispensary_name || "").toLowerCase();
            const bd = (b.dispensary_name || "").toLowerCase();
            return ad.localeCompare(bd);
          });
        }

        const display = searchTerm ? filtered : filtered.slice(0, 20);

        display.forEach((bt) => {
          const tr = document.createElement("tr");
          tr.classList.add("clickable");
          tr.addEventListener("click", () => selectBudtender(bt));

          const name = `${bt.first_name || ""} ${bt.last_name || ""}`.trim();
          const points = typeof bt.points === "number" ? bt.points : 0;
          const type = bt.budtender_type || (bt.employee_id ? "MAIN" : "EXTERNAL");
          const typeClass = type === "MAIN" ? "active" : "churn";

          tr.innerHTML = `
          <td><strong>${name}</strong><div class="muted">${
            bt.email || "No email"
          }</div></td>
          <td class="nowrap">${bt.dispensary_name || "â€”"}</td>
          <td class="nowrap">${points}</td>
          <td class="nowrap"><span class="pill ${typeClass}">${type}</span></td>
        `;
          tbody.appendChild(tr);
        });

        const countLabel =
          searchTerm || filter !== "all"
            ? `${filtered.length} budtenders`
            : `${display.length} of ${filtered.length} budtenders`;
        document.getElementById("budtenderCount").textContent = countLabel;
      }

      // ========== SELECT BUDTENDER ==========
      async function selectBudtender(budtender) {
        currentBudtenderId = budtender.id;
        currentBudtenderData = budtender;
        const content = document.getElementById("budtenderProfileContent");
        const analytics = document.getElementById("budtenderAnalyticsContent");
        const analyticsTab = document.getElementById(
          "budtenderDetailTabAnalytics"
        );
        const analyticsView = document.getElementById(
          "budtendersAnalyticsView"
        );

        content.innerHTML =
          '<div class="loading">Loading budtender profile...</div>';
        analytics.innerHTML =
          '<div class="loading">Analyzing performance...</div>';

        try {
          const name = `${budtender.first_name || ""} ${
            budtender.last_name || ""
          }`.trim();
          const sales = budtender.total_sales || 0;
          const txns = budtender.transactions_count || 0;
          const avgTicket = budtender.avg_ticket || 0;
          const points = budtender.points || 0;
          const attributedSales =
            budtender.staging_total_sales_attributed || sales || 0;
          const attributedPoints =
            budtender.staging_total_points || points || 0;
          const tier = budtender.performance_tier || "â€”";
          const hireDate = budtender.hire_date || "â€”";
          const type =
            budtender.budtender_type ||
            (budtender.employee_id ? "MAIN" : "EXTERNAL");
          const status =
            type === "MAIN"
              ? budtender.is_disabled
                ? "Disabled"
                : "Active"
              : "External";
          const roleLabel =
            type === "MAIN" ? budtender.role_name || "Budtender" : "â€”";
          const shops =
            type === "MAIN" && Array.isArray(budtender.shop_ids)
              ? budtender.shop_ids.join(", ")
              : "â€”";

          let profileHTML = `
          <div class="metric-grid">
            <div class="metric-box">
              <div class="metric-label">Name</div>
              <div class="metric-value" style="font-size:18px;">${name}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Location</div>
              <div class="metric-value" style="font-size:16px;">${
                budtender.dispensary_name || "N/A"
              }</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Points</div>
              <div class="metric-value">${points}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Type</div>
              <div class="metric-value" style="font-size:16px;">${type}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Role</div>
              <div class="metric-value" style="font-size:16px;">${roleLabel}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Status</div>
              <div class="metric-value" style="font-size:16px;">${status}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Performance Tier</div>
              <div class="metric-value" style="font-size:16px;">${tier}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Hire Date</div>
              <div class="metric-value" style="font-size:16px;">${hireDate}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Shops</div>
              <div class="metric-value" style="font-size:14px;">${shops}</div>
            </div>
          </div>
        `;

          if (type === "MAIN") {
            profileHTML += `
          <div class="section">
            <div class="title">Sales Performance (Blaze)</div>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-label">Total Sales</div>
                <div class="metric-value">${fmtMoney(sales)}</div>
              </div>
              <div class="metric-box">
                <div class="metric-label">Transactions</div>
                <div class="metric-value">${txns}</div>
              </div>
              <div class="metric-box">
                <div class="metric-label">Avg Ticket</div>
                <div class="metric-value">${fmtMoney(avgTicket)}</div>
              </div>
              <div class="metric-box">
                <div class="metric-label">Attributed Sales (Staging)</div>
                <div class="metric-value">${fmtMoney(attributedSales)}</div>
                <div class="muted">${attributedPoints} pts</div>
              </div>
            </div>
          </div>
        `;
          } else {
            // EXTERNAL budtender: no known Blaze sales
            profileHTML += `
          <div class="section">
            <div class="title">External Budtender (Rewards Table)</div>
            <div class="terminal">
              <div>Type: <strong>EXTERNAL</strong> (row in <code>budtenders</code> rewards table).</div>
              <div>No matching <code>seller_id</code> or Blaze transactions were found for this budtender.</div>
              <div>Only contact information, dispensary and reward points are available.</div>
            </div>
          </div>
        `;
          }

          profileHTML += `
          <div class="section">
            <div class="title">Contact Information</div>
            <div class="terminal">
              <div><strong>Phone:</strong> ${budtender.phone || "â€”"}</div>
              <div><strong>Email:</strong> ${budtender.email || "â€”"}</div>
              <div><strong>Dispensary:</strong> ${
                budtender.dispensary_name || "â€”"
              }</div>
            </div>
          </div>
        `;

          content.innerHTML = profileHTML;

          // Mostrar/ocultar pestaÃ±a de Analytics segÃºn el tipo
          if (type === "EXTERNAL") {
            // Solo perfil para EXTERNAL budtenders
            if (analyticsTab) analyticsTab.style.display = "none";
            if (analyticsView) analyticsView.style.display = "none";
            showBudtenderDetailPane("profile");
          } else {
            if (analyticsTab) analyticsTab.style.display = "";
            if (analyticsView) {
              // Por defecto seguimos mostrando Profile; el usuario puede cambiar a Analytics
              showBudtenderDetailPane("profile");
            }
            await loadBudtenderAnalytics(budtender);
          }
        } catch (e) {
          console.error(e);
          content.innerHTML =
            '<div class="muted">Error loading profile: ' + e.message + "</div>";
        }
      }

      async function loadBudtenderAnalytics(budtender) {
        const analytics = document.getElementById("budtenderAnalyticsContent");
        try {
          // EXTERNAL budtenders (tabla `budtenders` sin seller_id) no tienen
          // historial de ventas Blaze, asÃ­ que no intentamos cargar analÃ­ticas
          // de transacciones. Para MAIN e HISTORICAL sÃ­ usamos seller_id.
          if (!budtender.seller_id) {
            analytics.innerHTML =
              '<div class="muted">No transaction analytics available for EXTERNAL budtenders (no Blaze seller_id linked). Use points and dispensary metrics only.</div>';
            window.budtenderAnalyticsData = null;
            return;
          }

          const sb = ensureClient();

          analytics.innerHTML =
            '<div class="loading">Loading budtender analytics...</div>';

          // Fetch transactions (last 12 months para analytics anual/mensual/semanal) por seller_id
          const lookbackDate = new Date();
          lookbackDate.setMonth(lookbackDate.getMonth() - 12);

          const { data: txs, error: txError } = await sb
            .from("transactions_blaze")
            .select("*")
            .eq("seller_id", budtender.seller_id)
            .gte("date", lookbackDate.toISOString())
            .order("date", { ascending: false })
            .limit(1000);

          if (txError) throw txError;

          if (!txs || txs.length === 0) {
            analytics.innerHTML =
              '<div class="muted">No transaction history available for the last 6 months.</div>';
            return;
          }

          // Fetch transaction items in batches
          const txIds = txs.map((t) => t.transaction_id).filter(Boolean);
          let itemsList = [];

          for (let i = 0; i < txIds.length; i += 200) {
            const batch = txIds.slice(i, i + 200);
            const { data: batchItems } = await sb
              .from("transaction_items_blaze")
              .select("*")
              .in("transaction_id", batch);
            if (batchItems) itemsList = itemsList.concat(batchItems);
          }

          // MOTA expertise calculation
          const motaItems = itemsList.filter((i) =>
            (i.brand || "").toLowerCase().includes("mota")
          );
          const motaPct =
            itemsList.length > 0
              ? Math.round((motaItems.length / itemsList.length) * 100)
              : 0;

          // Unique customers
          const uniqueCustomers = new Set(
            txs.map((t) => t.customer_id).filter(Boolean)
          ).size;

          // Calculate total sales from transactions
          const totalSales = txs.reduce(
            (sum, t) => sum + (parseFloat(t.total_amount) || 0),
            0
          );

          // Sales windows (7d / 30d / 365d)
          const now = new Date();
          const msPerDay = 1000 * 60 * 60 * 24;
          let sales7d = 0,
            sales30d = 0,
            sales365d = 0;
          let tx7d = 0,
            tx30d = 0,
            tx365d = 0;
          txs.forEach((t) => {
            const d = new Date(t.date || t.completed_time || t.created_at);
            const diffDays = (now - d) / msPerDay;
            const amt = parseFloat(t.total_amount) || 0;
            if (diffDays <= 7) {
              sales7d += amt;
              tx7d += 1;
            }
            if (diffDays <= 30) {
              sales30d += amt;
              tx30d += 1;
            }
            if (diffDays <= 365) {
              sales365d += amt;
              tx365d += 1;
            }
          });

          // Coaching recommendations (performance + products)
          let recommendations = [];
          if (motaPct < 25) {
            recommendations.push(
              "ðŸŽ¯ <strong>MOTA Training:</strong> Only " +
                motaPct +
                "% of items sold are MOTA products. Provide product knowledge session."
            );
          }
          const avgTicket = txs.length > 0 ? totalSales / txs.length : 0;
          if (avgTicket < 45) {
            recommendations.push(
              "ðŸ’° <strong>Upselling Coaching:</strong> Avg ticket is " +
                fmtMoney(avgTicket) +
                ". Train on bundle suggestions and add-ons."
            );
          }
          if (txs.length > 50 && uniqueCustomers < txs.length * 0.5) {
            recommendations.push(
              "ðŸ¤ <strong>Customer Retention:</strong> Build relationships with repeat customers for loyalty growth."
            );
          }
          if (txs.length > 20) {
            recommendations.push(
              "â­ <strong>Top Performer Recognition:</strong> " +
                txs.length +
                " transactions with " +
                fmtMoney(totalSales) +
                " in sales. Reward excellence!"
            );
          }

          // Additional product-mix based recommendations
          if (itemsList && itemsList.length > 0 && totalSales > 0) {
            const categorySpend = {};
            const brandSpend = {};
            itemsList.forEach((item) => {
              const cat = item.category || "Other";
              const brand = item.brand || "Unknown";
              const price = parseFloat(
                item.total_price || item.final_price || item.unit_price || 0
              );
              categorySpend[cat] = (categorySpend[cat] || 0) + price;
              brandSpend[brand] = (brandSpend[brand] || 0) + price;
            });

            const topCatEntries = Object.entries(categorySpend).sort(
              (a, b) => b[1] - a[1]
            );
            if (topCatEntries.length) {
              const [topCat, topCatSales] = topCatEntries[0];
              const share = (topCatSales / totalSales) * 100;
              if (share > 70) {
                recommendations.push(
                  "ðŸ§© <strong>Category Mix:</strong> " +
                    topCat +
                    " represents " +
                    share.toFixed(1) +
                    "% of sales. Coach on cross-selling other categories to balance the mix."
                );
              }
            }

            const distinctBrands = Object.keys(brandSpend).length;
            if (distinctBrands < 5 && totalSales > 0) {
              recommendations.push(
                "ðŸ·ï¸ <strong>Brand Portfolio:</strong> Very few brands in the mix. Introduce and recommend more brands to diversify sales."
              );
            }
          }

          // Store data for budtender analytics sections
          window.budtenderAnalyticsData = {
            budtender,
            txs,
            itemsList,
            motaItems,
            motaPct,
            uniqueCustomers,
            recommendations,
            totalSales,
            avgTicket,
            sales7d,
            sales30d,
            sales365d,
            tx7d,
            tx30d,
            tx365d,
          };

          // Render current budtender analytics section
          renderBudtenderAnalyticsSection(currentBudAnalyticsSection);
        } catch (e) {
          console.error(e);
          analytics.innerHTML =
            '<div class="muted">Error loading analytics: ' +
            e.message +
            "</div>";
        }
      }

      // ========== LOAD OVERVIEW ==========
      async function loadOverview() {
        try {
          const sb = ensureClient();
          const content = document.getElementById("overviewContent");
          const analytics = document.getElementById("overviewAnalyticsContent");

          content.innerHTML =
            '<div class="loading">Loading business overview...</div>';
          analytics.innerHTML =
            '<div class="loading">Generating insights...</div>';

          const [custRes, budRes, txRes, customersSample] = await Promise.all([
            sb
              .from("customers")
              .select("lifetime_value", { count: "exact", head: true }),
            sb.from("budtenders").select("*", { count: "exact", head: true }),
            sb
              .from("transactions")
              .select("total_amount", { count: "exact", head: true }),
            sb
              .from("customers")
              .select(
                "lifetime_value, total_visits, days_since_last_visit, vip_status"
              )
              .limit(10000),
          ]);

          const totalCustomers = custRes.count || 0;
          const totalBudtenders = budRes.count || 0;
          const totalTransactions = txRes.count || 0;

          const { data: recentTxs } = await sb
            .from("transactions")
            .select("total_amount")
            .order("date", { ascending: false })
            .limit(10000);
          const totalRevenue = (recentTxs || []).reduce(
            (sum, t) => sum + (parseFloat(t.total_amount) || 0),
            0
          );
          const avgTicket =
            totalTransactions > 0 ? totalRevenue / totalTransactions : 0;

          // Customer summary metrics
          let sample = customersSample.data || customersSample || [];
          let totalVisitsSample = 0;
          let totalLtvSample = 0;
          let active30 = 0;
          let vipCount = 0;
          sample.forEach((c) => {
            const visits = c.total_visits || 0;
            const ltv = parseFloat(c.lifetime_value) || 0;
            totalVisitsSample += visits;
            totalLtvSample += ltv;
            if (c.days_since_last_visit != null && c.days_since_last_visit <= 30)
              active30 += 1;
            if (c.vip_status && c.vip_status !== "New") vipCount += 1;
          });
          const avgVisitsPerCustomer =
            sample.length > 0 ? totalVisitsSample / sample.length : 0;
          const avgLtvPerCustomer =
            sample.length > 0 ? totalLtvSample / sample.length : 0;

          // ===== Additional business / budtender performance metrics =====
          // Load employees_blaze to identify internal MAIN budtenders
          const { data: empRows } = await sb
            .from("employees_blaze")
            .select("employee_id, first_name, last_name, name");
          const mainSellerIds = new Set(
            (empRows || []).map((e) => e.employee_id).filter(Boolean)
          );

          // Use transactions_blaze for budtender-based performance (last 365 days)
          const lookbackDate = new Date();
          lookbackDate.setDate(lookbackDate.getDate() - 365);

          const { data: txsBlaze } = await sb
            .from("transactions_blaze")
            .select("seller_id, total_amount, date, shop_location")
            .gte("date", lookbackDate.toISOString());

          let mainSales = 0,
            mainTx = 0;
          let allSales365 = 0,
            allTx365 = 0;
          const now = new Date();
          const msPerDay = 1000 * 60 * 60 * 24;
          let mainSales7 = 0,
            mainTx7 = 0;
          let mainSales30 = 0,
            mainTx30 = 0;

          const byMainSeller365 = new Map();
          const byMainSeller182 = new Map();
          const byMainSeller90 = new Map();
          const byMainSeller30 = new Map();
          const byMainSeller7 = new Map();
          const dispMap = new Map(); // per-dispensary aggregates

          (txsBlaze || []).forEach((t) => {
            const amt = parseFloat(t.total_amount) || 0;
            const d = new Date(t.date || now);
            const diffDays = (now - d) / msPerDay;
            allSales365 += amt;
            allTx365 += 1;
            if (mainSellerIds.has(t.seller_id)) {
              mainSales += amt;
              mainTx += 1;
              if (diffDays <= 7) {
                mainSales7 += amt;
                mainTx7 += 1;
              }
              if (diffDays <= 30) {
                mainSales30 += amt;
                mainTx30 += 1;
              }

              // Per-seller aggregation for MAIN budtenders by period
              function bump(map) {
                let ms = map.get(t.seller_id);
                if (!ms) ms = { sales: 0, tx: 0 };
                ms.sales += amt;
                ms.tx += 1;
                map.set(t.seller_id, ms);
              }
              if (diffDays <= 365) bump(byMainSeller365);
              if (diffDays <= 182) bump(byMainSeller182);
              if (diffDays <= 90) bump(byMainSeller90);
              if (diffDays <= 30) bump(byMainSeller30);
              if (diffDays <= 7) bump(byMainSeller7);

              // Per-dispensary (location) aggregation for MAIN
              const loc = t.shop_location || "Unknown";
              let disp = dispMap.get(loc);
              if (!disp)
                disp = {
                  name: loc,
                  mainSales: 0,
                  mainTx: 0,
                  extCount: 0,
                  extPoints: 0,
                  externals: [],
                };
              disp.mainSales += amt;
              disp.mainTx += 1;
              dispMap.set(loc, disp);
            }
          });

          const mainAvgTicket365 = mainTx > 0 ? mainSales / mainTx : 0;
          const mainAvgTicket7 = mainTx7 > 0 ? mainSales7 / mainTx7 : 0;
          const mainAvgTicket30 = mainTx30 > 0 ? mainSales30 / mainTx30 : 0;

          // External budtenders per dispensary (points)
          const { data: extBudRows } = await sb
            .from("budtenders")
            .select("id, first_name, last_name, dispensary_name, points");
          let totalExtPoints = 0;
          let totalExtCount = 0;
          (extBudRows || []).forEach((b) => {
            const dispName = b.dispensary_name || "Unknown";
            let disp = dispMap.get(dispName);
            if (!disp)
              disp = {
                name: dispName,
                mainSales: 0,
                mainTx: 0,
                extCount: 0,
                extPoints: 0,
                externals: [],
              };
            const pts = b.points || 0;
            disp.extCount += 1;
            disp.extPoints += pts;
            if (!disp.externals) disp.externals = [];
            const fullName =
              (b.first_name || "") + " " + (b.last_name || "");
            disp.externals.push({
              id: b.id,
              name: fullName.trim() || `Budtender #${b.id}`,
              points: pts,
            });
            dispMap.set(dispName, disp);
            totalExtPoints += pts;
            totalExtCount += 1;
          });

          overviewDispAggregates = Array.from(dispMap.values());

          // MAIN budtender summary lists (top performers) per period for Overview
          const empById = new Map(
            (empRows || []).map((e) => [e.employee_id, e])
          );
          function buildMainBudArray(map) {
            return Array.from(map.entries())
              .map(([sellerId, agg]) => {
                const emp = empById.get(sellerId);
                const fullName =
                  (emp?.first_name || "") + " " + (emp?.last_name || "");
                const name = fullName.trim() || emp?.name || sellerId;
                const avg = agg.tx > 0 ? agg.sales / agg.tx : 0;
                return {
                  sellerId,
                  name,
                  totalSales: agg.sales,
                  txCount: agg.tx,
                  avgTicket: avg,
                };
              })
              .sort((a, b) => b.totalSales - a.totalSales)
              .slice(0, 10);
          }

          overviewMainBudSummary = {
            "12m": buildMainBudArray(byMainSeller365),
            "6m": buildMainBudArray(byMainSeller182),
            "3m": buildMainBudArray(byMainSeller90),
            "1m": buildMainBudArray(byMainSeller30),
            "7d": buildMainBudArray(byMainSeller7),
          };

          overviewCustomerSummary = {
            totalCustomers,
            avgVisitsPerCustomer,
            avgLtvPerCustomer,
            active30,
            vipCount,
          };

          document.getElementById("statTotalCustomers").textContent =
            totalCustomers.toLocaleString();
          document.getElementById("statTotalBudtenders").textContent =
            totalBudtenders.toLocaleString();
          document.getElementById("statTotalTransactions").textContent =
            totalTransactions.toLocaleString();
          document.getElementById("statTotalRevenue").textContent =
            fmtMoney(totalRevenue);

          // Build Overview sub-navigation and sections
          const dispOptions = overviewDispAggregates
            .map((d) => d.name)
            .filter(Boolean)
            .sort((a, b) => a.localeCompare(b));

          content.innerHTML = `
          <div class="analytics-nav" id="overviewSubNav">
            <div class="analytics-nav-item active" data-osection="summary">Summary</div>
            <div class="analytics-nav-item" data-osection="dispensaries">Dispensaries</div>
            <div class="analytics-nav-item" data-osection="budtenders">Budtenders</div>
            <div class="analytics-nav-item" data-osection="customers">Customers</div>
          </div>

          <div id="overviewSectionSummary">
            <div class="section">
              <div class="title">Business Snapshot</div>
              <div class="metric-grid">
                <div class="metric-box">
                  <div class="metric-label">Total Customers</div>
                  <div class="metric-value">${totalCustomers.toLocaleString()}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Total Budtenders</div>
                  <div class="metric-value">${totalBudtenders.toLocaleString()}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Total Transactions</div>
                  <div class="metric-value">${totalTransactions.toLocaleString()}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Total Revenue (sample)</div>
                  <div class="metric-value">${fmtMoney(totalRevenue)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Avg Ticket</div>
                  <div class="metric-value">${fmtMoney(avgTicket)}</div>
                </div>
              </div>
            </div>
            <div class="section">
              <div class="title">Budtender Performance Overview (Last 12 Months)</div>
              <div class="metric-grid">
                <div class="metric-box">
                  <div class="metric-label">Main Budtenders Sales (365d)</div>
                  <div class="metric-value">${fmtMoney(mainSales)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Main Budtenders Transactions (365d)</div>
                  <div class="metric-value">${mainTx.toLocaleString()}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Main Avg Ticket (365d)</div>
                  <div class="metric-value">${fmtMoney(mainAvgTicket365)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Main Sales Last 30 Days</div>
                  <div class="metric-value">${fmtMoney(mainSales30)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Main Avg Ticket (30d)</div>
                  <div class="metric-value">${fmtMoney(mainAvgTicket30)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Main Sales Last 7 Days</div>
                  <div class="metric-value">${fmtMoney(mainSales7)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Main Avg Ticket (7d)</div>
                  <div class="metric-value">${fmtMoney(mainAvgTicket7)}</div>
                </div>
              </div>
            </div>
            <div class="section">
              <div class="title">System Health</div>
              <div class="terminal">
                <div>âœ… <strong>Database:</strong> Connected</div>
                <div>âœ… <strong>Customers:</strong> ${totalCustomers.toLocaleString()} records</div>
                <div>âœ… <strong>Transactions:</strong> ${totalTransactions.toLocaleString()} records</div>
                <div>âœ… <strong>Budtenders:</strong> ${totalBudtenders.toLocaleString()} active</div>
              </div>
            </div>
          </div>

          <div id="overviewSectionDispensaries" style="display:none">
            <div class="section">
              <div class="title">Performance by Dispensary</div>
              <div class="filter-bar">
                <select id="overviewDispensaryFilter">
                  <option value="all">All Dispensaries</option>
                  ${dispOptions
                    .map(
                      (d) =>
                        `<option value="${d.replace(/"/g, "&quot;")}">${d}</option>`
                    )
                    .join("")}
                </select>
              </div>
              <div class="list" style="max-height:340px;">
                <table>
                  <thead>
                    <tr>
                      <th>Dispensary</th>
                      <th>Main Sales (365d)</th>
                      <th>Main Tx</th>
                      <th>Main Avg Ticket</th>
                      <th>External Budtenders</th>
                      <th>External Points</th>
                      <th>Avg Points / External</th>
                    </tr>
                  </thead>
                  <tbody id="overviewDispensaryTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="overviewSectionBudtenders" style="display:none">
            <div class="section">
              <div class="title">Top Main Budtenders</div>
              <div class="analytics-nav" id="overviewBudPeriodNav">
                <div class="analytics-nav-item active" data-period="12m">Last 12 months</div>
                <div class="analytics-nav-item" data-period="6m">Last 6 months</div>
                <div class="analytics-nav-item" data-period="3m">Last 3 months</div>
                <div class="analytics-nav-item" data-period="1m">Last month</div>
                <div class="analytics-nav-item" data-period="7d">Last 7 days</div>
              </div>
              <div class="chart-container">
                <canvas id="overviewMainBudChart"></canvas>
              </div>
              <div class="list" style="max-height:360px;">
                <table>
                  <thead>
                    <tr>
                      <th>Budtender</th>
                      <th>Seller ID</th>
                      <th>Total Sales</th>
                      <th>Transactions</th>
                      <th>Avg Ticket</th>
                    </tr>
                  </thead>
                  <tbody id="overviewMainBudTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="overviewSectionCustomers" style="display:none">
            <div class="section">
              <div class="title">Customer Overview</div>
              <div class="metric-grid">
                <div class="metric-box">
                  <div class="metric-label">Total Customers</div>
                  <div class="metric-value">${totalCustomers.toLocaleString()}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Active (â‰¤30d since last visit)</div>
                  <div class="metric-value">${active30.toLocaleString()}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Average Visits per Customer (sample)</div>
                  <div class="metric-value">${avgVisitsPerCustomer.toFixed(1)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">Average LTV per Customer (sample)</div>
                  <div class="metric-value">${fmtMoney(avgLtvPerCustomer)}</div>
                </div>
                <div class="metric-box">
                  <div class="metric-label">VIP Customers (sample)</div>
                  <div class="metric-value">${vipCount.toLocaleString()}</div>
                </div>
              </div>
            </div>
          </div>
        `;

          analytics.innerHTML = `
          <div class="recommendations">
            <div class="rec-title">ðŸŽ¯ Strategic Business Recommendations</div>
            <div class="rec-item"><strong>VIP Program Expansion:</strong> Identify top 10% customers by LTV and create exclusive rewards tier.</div>
            <div class="rec-item"><strong>MOTA Brand Push:</strong> Train all budtenders on MOTA product line. Target 40% of all sales.</div>
            <div class="rec-item"><strong>Churn Prevention:</strong> Automate SMS campaigns for customers inactive 60+ days with personalized offers.</div>
            <div class="rec-item"><strong>Budtender Incentives:</strong> Implement leaderboard and monthly bonuses for top performers by sales and customer satisfaction.</div>
            <div class="rec-item"><strong>Data-Driven Inventory:</strong> Analyze top-selling products by location and season to optimize stock levels.</div>
          </div>
        `;

          // Initialize Overview sub-section navigation and tables
          function showOverviewSection(section) {
            const sections = [
              "summary",
              "dispensaries",
              "budtenders",
              "customers",
            ];
            sections.forEach((s) => {
              const el = document.getElementById(
                "overviewSection" + s.charAt(0).toUpperCase() + s.slice(1)
              );
              if (el) el.style.display = s === section ? "" : "none";
            });
            const navItems = document.querySelectorAll(
              "#overviewSubNav .analytics-nav-item"
            );
            navItems.forEach((item) => {
              item.classList.toggle(
                "active",
                item.dataset.osection === section
              );
            });
          }

          // Toggle external budtenders detail for a dispensary row
          window.toggleDispensaryDetail = function (row) {
            const detailRow = row.nextElementSibling;
            if (
              detailRow &&
              detailRow.classList.contains("disp-external-row")
            ) {
              const isHidden =
                detailRow.style.display === "none" || !detailRow.style.display;
              detailRow.style.display = isHidden ? "table-row" : "none";
            }
          };

          // Render dispensary table
          function renderOverviewDispensaryTable() {
            const tbody = document.getElementById(
              "overviewDispensaryTableBody"
            );
            if (!tbody) return;
            const filter =
              (document.getElementById("overviewDispensaryFilter") &&
                document
                  .getElementById("overviewDispensaryFilter")
                  .value) || "all";
            const rows = overviewDispAggregates
              .filter(
                (d) => filter === "all" || d.name === filter
              )
              .map((d) => {
                const avgMain =
                  d.mainTx > 0 ? fmtMoney(d.mainSales / d.mainTx) : "$0.00";
                const avgPoints =
                  d.extCount > 0 ? (d.extPoints / d.extCount).toFixed(1) : "0";
                const externalRows =
                  d.externals && d.externals.length
                    ? `
                      <div class="terminal">
                        <div><strong>External Budtenders (${d.externals.length})</strong></div>
                      </div>
                      <table style="width:100%; margin-top:8px;">
                        <thead>
                          <tr>
                            <th style="text-align:left;">Name</th>
                            <th style="text-align:right;">Points</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${d.externals
                            .map(
                              (eb) => `
                            <tr>
                              <td>${eb.name}</td>
                              <td style="text-align:right;">${(eb.points || 0).toLocaleString()}</td>
                            </tr>
                          `
                            )
                            .join("")}
                        </tbody>
                      </table>
                    `
                    : `<div class="muted">No external budtenders for this dispensary.</div>`;

                return `
                  <tr class="disp-row" onclick="toggleDispensaryDetail(this)">
                    <td>${d.name}</td>
                    <td>${fmtMoney(d.mainSales)}</td>
                    <td>${d.mainTx.toLocaleString()}</td>
                    <td>${avgMain}</td>
                    <td>${d.extCount.toLocaleString()}</td>
                    <td>${d.extPoints.toLocaleString()}</td>
                    <td>${avgPoints}</td>
                  </tr>
                  <tr class="disp-external-row" style="display:none;">
                    <td colspan="7">
                      ${externalRows}
                    </td>
                  </tr>`;
              })
              .join("");
            tbody.innerHTML = rows || `<tr><td colspan="7">No data.</td></tr>`;
          }

          renderOverviewDispensaryTable();
          const dispFilterEl = document.getElementById(
            "overviewDispensaryFilter"
          );
          if (dispFilterEl) {
            dispFilterEl.addEventListener("change", renderOverviewDispensaryTable);
          }

          // Render top main budtenders table by period
          function renderOverviewMainBudTable(period) {
            const budTbody = document.getElementById("overviewMainBudTableBody");
            if (!budTbody) return;
            const arr =
              (overviewMainBudSummary && overviewMainBudSummary[period]) || [];
            const budRows = arr
              .map(
                (b) => `
              <tr>
                <td>${b.name}</td>
                <td class="nowrap">${b.sellerId}</td>
                <td class="nowrap">${fmtMoney(b.totalSales)}</td>
                <td class="nowrap">${b.txCount.toLocaleString()}</td>
                <td class="nowrap">${fmtMoney(b.avgTicket)}</td>
              </tr>`
              )
              .join("");
            budTbody.innerHTML =
              budRows || `<tr><td colspan="5">No main budtender data.</td></tr>`;

            // Update overview budtender chart for the selected period
            const chartCanvas = document.getElementById("overviewMainBudChart");
            if (chartCanvas && window.Chart && arr.length) {
              const top = arr.slice(0, 5);
              if (overviewBudChart) {
                overviewBudChart.destroy();
                overviewBudChart = null;
              }
              overviewBudChart = new Chart(chartCanvas.getContext("2d"), {
                type: "bar",
                data: {
                  labels: top.map((b) => b.name),
                  datasets: [
                    {
                      label: "Sales",
                      data: top.map((b) => b.totalSales),
                      backgroundColor: "#22c55e",
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: {
                    x: {
                      grid: { display: false },
                      ticks: { color: "#a89584" },
                    },
                    y: {
                      beginAtZero: true,
                      ticks: { color: "#a89584" },
                      grid: { color: "#4a3830" },
                    },
                  },
                },
              });
            } else if (overviewBudChart) {
              overviewBudChart.destroy();
              overviewBudChart = null;
            }
          }

          renderOverviewMainBudTable("12m");

          const budPeriodNav = document.getElementById("overviewBudPeriodNav");
          if (budPeriodNav) {
            budPeriodNav.querySelectorAll(".analytics-nav-item").forEach((el) => {
              el.addEventListener("click", () => {
                const period = el.dataset.period || "12m";
                budPeriodNav
                  .querySelectorAll(".analytics-nav-item")
                  .forEach((x) =>
                    x.classList.toggle("active", x.dataset.period === period)
                  );
                renderOverviewMainBudTable(period);
              });
            });
          }

          // Navigation events
          document
            .querySelectorAll("#overviewSubNav .analytics-nav-item")
            .forEach((item) => {
              item.addEventListener("click", () => {
                const section = item.dataset.osection || "summary";
                showOverviewSection(section);
              });
            });
          showOverviewSection("summary");

          setLastRefresh();
        } catch (e) {
          console.error(e);
          alert("Failed to load overview: " + e.message);
        }
      }

      // ========== SUGGESTED MESSAGES TAB ==========
      let suggestedMessages = [];
      let selectedSugMessage = null;
      let sugIsEditMode = false;
      let customerNameCache = new Map();

      async function loadSuggestedMessages() {
        const listEl = document.getElementById("sugMessageList");
        listEl.innerHTML = '<div class="loading">Loading messages...</div>';
        
        try {
          const sb = ensureClient();
          const status = document.getElementById("sugStatusFilter").value;
          const campaign = document.getElementById("sugCampaignFilter").value;
          const search = (document.getElementById("sugSearch").value || "").trim().toLowerCase();
          
          // Query BOTH tables: campaign_messages AND messages (with payload containing campaign_key)
          // This ensures we see all campaigns regardless of which table they're in
          
          // 1. Get from campaign_messages table
          let cmQuery = sb.from("campaign_messages").select("*")
            .order("generated_at", { ascending: false }).limit(300);
          if (status !== "all") cmQuery = cmQuery.eq("status", status);
          if (campaign !== "all" && !campaign.startsWith("msg:")) {
            cmQuery = cmQuery.eq("campaign_name", campaign);
          }
          
          // 2. Get from messages table - ALL SUG/APR messages (campaign messages)
          let msgQuery = sb.from("messages").select("*")
            .order("timestamp", { ascending: false }).limit(300);
          // Filter by status for messages table
          if (status !== "all") {
            msgQuery = msgQuery.eq("status", status);
          } else {
            // Only get campaign messages (SUG/APR), not regular sent/received
            msgQuery = msgQuery.in("status", ["SUG", "APR"]);
          }
          
          const [cmResult, msgResult] = await Promise.all([
            cmQuery,
            msgQuery
          ]);
          
          // Gracefully handle missing campaign_messages table (legacy)
          if (cmResult.error) {
            console.warn("Legacy campaign_messages table skipped:", cmResult.error.message);
          }
          if (msgResult.error) throw msgResult.error;
          
          // Normalize messages from messages table to match campaign_messages format
          // Include ALL SUG/APR messages, not just those with campaign_key
          const normalizedMsgs = (msgResult.data || [])
            .map(m => {
              // Try to extract customer name from content if not in payload
              let customerName = m.payload?.customer_name || "Unknown";
              if (customerName === "Unknown" && m.content) {
                // Try to extract name from "Hey NAME," or "Hi NAME," pattern
                const match = m.content.match(/^(?:Hey|Hi|Hello)\s+([A-Za-z]+)[,:\s]/i);
                if (match) customerName = match[1];
              }
              
              // Determine campaign name from column, payload, or content
              let campaignName = m.campaign_name || m.payload?.campaign_key || "Unknown";
              if (campaignName === "Unknown" && m.content) {
                // Detect campaign type from content
                if (m.content.toLowerCase().includes("birthday") || m.content.toLowerCase().includes("happy birthday")) {
                  campaignName = "birthday_week";
                } else if (m.content.toLowerCase().includes("trust you liked") || m.content.toLowerCase().includes("free fatty")) {
                  campaignName = "product_feedback";
                } else if (m.content.toLowerCase().includes("good to see you")) {
                  campaignName = "new_customer_retention";
                }
              }
              
              return {
                id: m.id,
                customer_id: m.payload?.customer_id || null,
                customer_name: customerName,
                phone_number: m.phone_number,
                message_content: m.content,
                campaign_name: campaignName,
                status: m.status,
                generated_at: m.timestamp,
                strategy_type: m.payload?.strategy_type || "ai_generated",
                source_table: "messages"
              };
            });
          
          // Add source_table to campaign_messages
          const cmData = (cmResult.data || []).map(m => ({ ...m, source_table: "campaign_messages" }));
          
          // Merge both sources
          let allMessages = [...cmData, ...normalizedMsgs];
          
          // Filter by campaign if selected (handle both table formats)
          if (campaign !== "all") {
            allMessages = allMessages.filter(m => m.campaign_name === campaign);
          }
          
          // Apply search filter
          if (search) {
            allMessages = allMessages.filter(m => 
              (m.customer_name || "").toLowerCase().includes(search) ||
              (m.phone_number || "").includes(search) ||
              (m.message_content || "").toLowerCase().includes(search)
            );
          }
          
          // Sort by date (newest first)
          allMessages.sort((a, b) => {
            const dateA = new Date(a.generated_at || a.timestamp || 0);
            const dateB = new Date(b.generated_at || b.timestamp || 0);
            return dateB - dateA;
          });
          
          suggestedMessages = allMessages;
          
          // Update campaign filter with all campaigns from both sources
          await updateCampaignDropdown(allMessages);
          
          renderSuggestedList();
          updateSugStats();
          setLastRefresh();
        } catch (e) {
          console.error(e);
          listEl.innerHTML = '<div class="muted">Error: ' + e.message + '</div>';
        }
      }

      async function updateSugStats() {
        try {
          const sb = ensureClient();
          
          // Legacy counts (safe fetch)
          let cmSug = { count: 0 }, cmApr = { count: 0 }, cmSent = { count: 0 };
          const [r1, r2, r3] = await Promise.all([
            sb.from("campaign_messages").select("id", { count: "exact" }).eq("status", "SUG"),
            sb.from("campaign_messages").select("id", { count: "exact" }).eq("status", "APR"),
            sb.from("campaign_messages").select("id", { count: "exact" }).eq("status", "sent")
          ]);
          if (!r1.error) cmSug = r1;
          if (!r2.error) cmApr = r2;
          if (!r3.error) cmSent = r3;

          // Messages table counts
          const [msgSug, msgApr] = await Promise.all([
            sb.from("messages").select("id", { count: "exact" }).eq("status", "SUG"),
            sb.from("messages").select("id", { count: "exact" }).eq("status", "APR")
          ]);
          
          const totalSug = (cmSug.count || 0) + (msgSug.count || 0);
          const totalApr = (cmApr.count || 0) + (msgApr.count || 0);
          const totalSent = cmSent.count || 0;
          
          // Update stats bar
          document.getElementById("sugStatSug").textContent = totalSug;
          document.getElementById("sugStatApr").textContent = totalApr;
          document.getElementById("sugStatSent").textContent = totalSent;
          
          // Update queue count (simplified)
          document.getElementById("sugQueueCount").textContent = totalSug;
        } catch {}
      }

      // Build campaign dropdown from messages that actually exist
      // Campaigns auto-populate based on what's in campaign_messages table
      // When you (backend) create new campaigns and generate messages, they automatically appear here
      async function updateCampaignDropdown(allMessages) {
        try {
          const campSelect = document.getElementById("sugCampaignFilter");
          const currentCamp = campSelect.value;
          const currentStatus = document.getElementById("sugStatusFilter").value;
          
          // Count messages per campaign with full status breakdown
          const campaignStats = {};
          (allMessages || []).forEach(m => {
            const name = m.campaign_name;
            if (!name) return;
            if (!campaignStats[name]) {
              campaignStats[name] = { total: 0, SUG: 0, APR: 0, sent: 0 };
            }
            campaignStats[name].total++;
            const status = m.status || "";
            if (campaignStats[name][status] !== undefined) {
              campaignStats[name][status]++;
            }
          });
          
          // Sort: campaigns with pending (SUG) first, then by total messages
          const sortedCampaigns = Object.entries(campaignStats)
            .sort((a, b) => {
              // Prioritize campaigns with SUG messages
              if (a[1].SUG > 0 && b[1].SUG === 0) return -1;
              if (b[1].SUG > 0 && a[1].SUG === 0) return 1;
              // Then by total
              return b[1].total - a[1].total;
            });
          
          // Build clean dropdown
          let options = `<option value="all">All Campaigns (${allMessages?.length || 0})</option>`;
          
          sortedCampaigns.forEach(([name, stats]) => {
            const selected = name === currentCamp ? ' selected' : '';
            
            // Clean up the campaign name for display
            let displayName = name
              .replace(/_/g, ' ')
              .replace(/v\d+$/i, '')
              .replace(/BT /i, '')
              .trim();
            
            // Show status counts inline
            let statusInfo = [];
            if (stats.SUG > 0) statusInfo.push(`${stats.SUG} pending`);
            if (stats.APR > 0) statusInfo.push(`${stats.APR} approved`);
            if (stats.sent > 0) statusInfo.push(`${stats.sent} sent`);
            
            const label = `${displayName} (${statusInfo.join(', ') || stats.total + ' total'})`;
            options += `<option value="${name}"${selected}>${label}</option>`;
          });
          
          campSelect.innerHTML = options;
        } catch (e) {
          console.error("Error updating campaign dropdown:", e);
          const campaigns = [...new Set((allMessages || []).map(m => m.campaign_name).filter(Boolean))];
          const campSelect = document.getElementById("sugCampaignFilter");
          campSelect.innerHTML = '<option value="all">All Campaigns</option>' +
            campaigns.map(c => `<option value="${c}">${c}</option>`).join("");
        }
      }

      function renderSuggestedList() {
        const listEl = document.getElementById("sugMessageList");
        listEl.innerHTML = "";
        document.getElementById("sugMessageCount").textContent = `${suggestedMessages.length} msgs`;
        
        if (!suggestedMessages.length) {
          listEl.innerHTML = '<div class="muted" style="padding: 30px 10px; text-align: center; font-size: 11px;">ðŸ“­ No messages</div>';
          return;
        }
        
        suggestedMessages.forEach(msg => {
          const item = document.createElement("div");
          item.className = "sug-msg-item-compact" + (selectedSugMessage?.id === msg.id ? " selected" : "");
          
          const statusClass = (msg.status || "").toLowerCase();
          // Shorten campaign name for display (e.g., "BT_Product_Feedback_v1" -> "Product Feedback")
          const campaignShort = (msg.campaign_name || "")
            .replace(/^BT_/i, "")
            .replace(/_v\d+$/i, "")
            .replace(/_/g, " ")
            .trim() || "â€”";
          
          item.innerHTML = `
            <div class="msg-name">${msg.customer_name || "Unknown"}</div>
            <div class="msg-meta">
              <span class="msg-tag ${statusClass}">${msg.status || "â€”"}</span>
              <span class="msg-tag campaign" title="${msg.campaign_name || ''}">${campaignShort}</span>
            </div>
            <div class="msg-preview">${(msg.message_content || "").substring(0, 50)}...</div>
          `;
          item.addEventListener("click", () => selectSugMessage(msg));
          listEl.appendChild(item);
        });
      }

      async function selectSugMessage(msg) {
        selectedSugMessage = msg;
        sugIsEditMode = false;
        renderSuggestedList();
        renderSugMessagePreview();
        loadConversationHistory(msg.phone_number);
        await loadSugCustomerCard(msg.customer_id, msg.phone_number);
      }

      async function loadConversationHistory(phoneNumber) {
        const historyEl = document.getElementById("sugConversationHistory");
        if (!phoneNumber) {
          historyEl.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">No phone number</div>';
          return;
        }
        
        historyEl.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">Loading...</div>';
        
        try {
          const sb = ensureClient();
          
          // Normalize phone to last 10 digits for flexible matching
          const digits = normalizePhone(phoneNumber);
          
          // Build OR filter for multiple phone formats
          // This catches: +16199773020, 6199773020, (619) 977-3020, etc.
          const phoneVariants = getPhoneVariants(phoneNumber);
          const orFilters = phoneVariants.map(v => `phone_number.eq.${v}`).join(",");
          
          // Also add ilike patterns to catch any format
          const ilikePattern = `%${digits}%`;
          
          // Query with flexible matching - include only real message statuses
          const { data, error } = await sb.from("messages")
            .select("*")
            .ilike("phone_number", ilikePattern)
            .in("status", ["sent", "read", "unread", "queued", "delivered", "failed", "rejected"])
            .order("timestamp", { ascending: true })
            .limit(100);
          
          if (error) throw error;
          
          // Filter to only messages that actually match our phone (last 10 digits)
          const filtered = (data || []).filter(m => normalizePhone(m.phone_number) === digits);
          
          if (filtered.length === 0) {
            historyEl.innerHTML = '<div class="muted" style="text-align: center; padding: 20px; font-size: 11px;">No conversation history<br><span style="font-size: 10px;">This may be a new contact</span></div>';
            return;
          }
          
          historyEl.innerHTML = "";
          filtered.forEach(msg => {
            // All messages should be real sent/received messages now (filtered at DB level)
            
            const bubble = document.createElement("div");
            const isInbound = msg.direction === "inbound";
            bubble.className = "conv-bubble " + (isInbound ? "inbound" : "outbound");
            
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString("en-US", {
              month: "short", day: "numeric", hour: "numeric", minute: "2-digit"
            }) : "";
            
            // Decode hex content if needed
            const content = decodeHexUCS2(msg.content || msg.message || "â€”");
            
            bubble.innerHTML = `
              <div>${content}</div>
              <div class="conv-time">${time}</div>
            `;
            historyEl.appendChild(bubble);
          });
          
          // Scroll to bottom
          historyEl.scrollTop = historyEl.scrollHeight;
        } catch (e) {
          console.error("Error loading conversation:", e);
          historyEl.innerHTML = '<div class="muted" style="text-align: center; padding: 20px; font-size: 11px;">Could not load history</div>';
        }
      }

      function renderSugMessagePreview() {
        const msg = selectedSugMessage;
        if (!msg) {
          document.getElementById("sugMessageContent").textContent = "Select a message from the queue";
          document.getElementById("sugActionBar").style.display = "none";
          document.getElementById("sugNotesSection").style.display = "none";
          return;
        }
        
        // Update customer info
        document.getElementById("sugCustName").textContent = msg.customer_name || "Unknown";
        document.getElementById("sugCustPhone").textContent = msg.phone_number || "N/A";
        document.getElementById("sugCustSegment").textContent = msg.customer_segment || "N/A";
        document.getElementById("sugCustCampaign").textContent = msg.campaign_name || "N/A";
        
        // Update status badge
        const statusEl = document.getElementById("sugPreviewStatus");
        statusEl.textContent = msg.status || "â€”";
        const statusClass = (msg.status || "").toLowerCase();
        statusEl.className = "pill " + (statusClass === "sug" ? "churn" : statusClass === "apr" ? "active" : "vip");
        
        // Show/hide action bar based on status
        const isSug = msg.status === "SUG";
        document.getElementById("sugActionBar").style.display = isSug ? "flex" : "none";
        document.getElementById("sugNotesSection").style.display = isSug ? "block" : "none";
        
        // Update edit button text
        document.getElementById("sugBtnEdit").textContent = sugIsEditMode ? "â† Back" : "âœŽ Edit";
        document.getElementById("sugBtnApprove").textContent = sugIsEditMode ? "âœ“ Save & Approve" : "âœ“ Approve";
        
        // Render message content (editable or not)
        const contentEl = document.getElementById("sugMessageContent");
        if (sugIsEditMode) {
          contentEl.innerHTML = `<textarea id="sugEditTextarea" style="width: 100%; min-height: 100px; background: var(--bg); border: 2px solid var(--accent); border-radius: 6px; color: var(--text); padding: 12px; font-size: 13px; resize: vertical; font-family: inherit; line-height: 1.5;">${msg.message_content || ""}</textarea>
          <div class="muted" style="text-align: right; font-size: 10px; margin-top: 4px;"><span id="sugCharCount">${(msg.message_content || "").length}</span> chars</div>`;
          const textarea = document.getElementById("sugEditTextarea");
          textarea.addEventListener("input", () => {
            const len = textarea.value.length;
            const countEl = document.getElementById("sugCharCount");
            countEl.textContent = len;
            countEl.style.color = len > 160 ? (len > 320 ? "var(--danger)" : "var(--warn)") : "var(--muted)";
          });
        } else {
          contentEl.innerHTML = `<div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${msg.message_content || "No content"}</div>`;
        }
      }

      async function loadSugCustomerCard(customerId, phoneNumber) {
        const cardEl = document.getElementById("sugCardText");
        const analyticsEl = document.getElementById("sugAnalyticsText");
        
        cardEl.textContent = "Loading...";
        analyticsEl.textContent = "";
        
        try {
          const sb = ensureClient();
          let cust = null;
          let foundCustomerId = customerId;
          
          // Strategy 1: Look up by customer_id if provided
          if (customerId) {
            let r = await sb.from("customers").select("*").eq("member_id", customerId).limit(1);
            cust = r.data?.[0];
            if (!cust) {
              r = await sb.from("customers_blaze").select("*").eq("member_id", customerId).limit(1);
              cust = r.data?.[0];
            }
          }
          
          // Strategy 2: Look up by phone number if no customer found yet
          if (!cust && phoneNumber) {
            // Clean phone number - extract just digits
            const cleanPhone = (phoneNumber || "").replace(/\D/g, "");
            // Try last 10 digits (most reliable)
            const phone10 = cleanPhone.slice(-10);
            
            if (phone10.length === 10) {
              // Search in customers table by phone
              let r = await sb.from("customers").select("*").ilike("phone", `%${phone10}%`).limit(1);
              cust = r.data?.[0];
              
              if (!cust) {
                // Try customers_blaze
                r = await sb.from("customers_blaze").select("*").ilike("phone", `%${phone10}%`).limit(1);
                cust = r.data?.[0];
              }
              
              if (cust) {
                foundCustomerId = cust.member_id;
                console.log(`Found customer by phone: ${cust.first_name} ${cust.last_name} (${cust.member_id})`);
              }
            }
          }
          
          if (!cust) {
            cardEl.textContent = "No customer ID linked.\n\nThis is a new contact.\n\nPhone: " + (phoneNumber || "N/A");
            analyticsEl.textContent = "No transaction history available.";
            return;
          }
          
          // Get transactions using the found customer ID (either from payload or phone lookup)
          const txRes = await sb.from("transactions")
            .select("transaction_id, date, created_at, total_amount, seller_id")
            .eq("customer_id", foundCustomerId)
            .order("date", { ascending: false }).limit(500);
          const txs = txRes.data || [];
          
          // Get items
          const txIds = txs.map(t => t.transaction_id).filter(Boolean);
          let items = [];
          for (let i = 0; i < txIds.length; i += 200) {
            const chunk = txIds.slice(i, i + 200);
            const ir = await sb.from("transaction_items_blaze")
              .select("transaction_id, product_name, brand, category, total_price, unit_price, quantity")
              .in("transaction_id", chunk);
            if (ir.data) items = items.concat(ir.data);
          }
          
          // Build card and analytics using existing functions
          const cardText = await buildBaseballCard(cust, txs, items);
          const analyticsText = await buildAnalyticsText(cust, txs, items);
          
          cardEl.textContent = cardText;
          analyticsEl.textContent = analyticsText;
        } catch (e) {
          console.error(e);
          cardEl.textContent = "Error: " + e.message;
        }
      }

      async function approveSugMessage() {
        if (!selectedSugMessage) return;
        try {
          const sb = ensureClient();
          const editedContent = sugIsEditMode ? document.getElementById("sugEditTextarea")?.value : null;
          const notes = document.getElementById("sugNotesInput")?.value || null;
          const finalContent = editedContent || selectedSugMessage.message_content;
          
          // Check which table this message came from
          const sourceTable = selectedSugMessage.source_table || "campaign_messages";
          
          if (sourceTable === "messages") {
            // Update in messages table - set status to 'APR' (approved, ready for scheduling)
            const { error } = await sb.from("messages")
              .update({ 
                status: "APR",
                content: finalContent
              }).eq("id", selectedSugMessage.id);
            if (error) throw error;
          } else {
            // Update in campaign_messages table
            const { error } = await sb.from("campaign_messages")
              .update({ 
                status: "APR", 
                message_content: finalContent,
                reviewed_at: new Date().toISOString(),
                reviewed_by: "MoTa Admin Intelligence",
                feedback_notes: notes
              }).eq("id", selectedSugMessage.id);
            if (error) throw error;
          }
          
          showSugToast("Message approved â†’ APR");
          await loadSuggestedMessages();
          selectNextSugMessage();
        } catch (e) {
          showSugToast("Error: " + e.message, true);
        }
      }

      async function rejectSugMessage() {
        if (!selectedSugMessage) return;
        try {
          const sb = ensureClient();
          const notes = document.getElementById("sugNotesInput")?.value || null;
          
          // Check which table this message came from
          const sourceTable = selectedSugMessage.source_table || "campaign_messages";
          
          if (sourceTable === "messages") {
            // Update in messages table - set status to 'rejected'
            const { error } = await sb.from("messages")
              .update({ status: "rejected" })
              .eq("id", selectedSugMessage.id);
            if (error) throw error;
          } else {
            // Update in campaign_messages table
            const { error } = await sb.from("campaign_messages")
              .update({ 
                status: "rejected",
                reviewed_at: new Date().toISOString(),
                reviewed_by: "MoTa Admin Intelligence",
                feedback_notes: notes
              }).eq("id", selectedSugMessage.id);
            if (error) throw error;
          }
          
          showSugToast("Message rejected");
          await loadSuggestedMessages();
          selectNextSugMessage();
        } catch (e) {
          showSugToast("Error: " + e.message, true);
        }
      }

      function toggleSugEdit() {
        sugIsEditMode = !sugIsEditMode;
        renderSugMessagePreview();
      }

      function selectNextSugMessage() {
        if (!suggestedMessages.length) {
          selectedSugMessage = null;
          renderSugMessagePreview();
          return;
        }
        const idx = suggestedMessages.findIndex(m => m.id === selectedSugMessage?.id);
        const next = idx >= 0 && idx < suggestedMessages.length - 1 ? idx + 1 : 0;
        if (suggestedMessages[next]) {
          selectedSugMessage = suggestedMessages[next];
          sugIsEditMode = false;
          renderSuggestedList();
          renderSugMessagePreview();
          loadSugCustomerCard(selectedSugMessage.customer_id, selectedSugMessage.phone_number);
        }
      }

      function showSugToast(message, isError = false) {
        // Create toast element if it doesn't exist
        let toast = document.getElementById("sugToast");
        if (!toast) {
          toast = document.createElement("div");
          toast.id = "sugToast";
          toast.style.cssText = "position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000;";
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.background = isError ? "var(--danger)" : "var(--success)";
        toast.style.color = "#fff";
        toast.style.transform = "translateY(0)";
        toast.style.opacity = "1";
        setTimeout(() => {
          toast.style.transform = "translateY(100px)";
          toast.style.opacity = "0";
        }, 3000);
      }

      // Helper to resolve customer ID to name (cached)
      async function resolveCustomerName(customerId) {
        if (!customerId) return "Unknown";
        if (customerNameCache.has(customerId)) return customerNameCache.get(customerId);
        
        try {
          const sb = ensureClient();
          const { data } = await sb.from("customers")
            .select("first_name, last_name, name")
            .eq("member_id", customerId)
            .limit(1);
          
          if (data && data[0]) {
            const c = data[0];
            const name = `${c.first_name || ""} ${c.last_name || ""}`.trim() || c.name || customerId;
            customerNameCache.set(customerId, name);
            return name;
          }
        } catch {}
        
        customerNameCache.set(customerId, customerId);
        return customerId;
      }

      // ========== SCHEDULED TAB FUNCTIONS ==========
      let scheduledMessages = [];
      let selectedSchedMessage = null;
      let autoQEnabled = true; // Default to enabled
      let autoQInterval = null;

      // Schedule settings (hardcoded) - Military time format
      const SCHED_CONFIG = {
        baseIntervalSec: 180,    // 180 seconds between messages
        swingPercent: 15,        // Â±15% variation
        startTime: "0930",       // Start time: 09:30 (9:30 AM)
        endTime: "1830"          // End time: 18:30 (6:30 PM)
      };

      function parseMillitaryTime(milTime) {
        // Parse "0930" -> { hours: 9, minutes: 30 }
        const h = parseInt(milTime.substring(0, 2), 10);
        const m = parseInt(milTime.substring(2, 4), 10);
        return { hours: h, minutes: m };
      }

      function isWithinScheduleWindow() {
        const now = new Date();
        const start = parseMillitaryTime(SCHED_CONFIG.startTime);
        const end = parseMillitaryTime(SCHED_CONFIG.endTime);
        
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const startMinutes = start.hours * 60 + start.minutes;
        const endMinutes = end.hours * 60 + end.minutes;
        
        return currentMinutes >= startMinutes && currentMinutes < endMinutes;
      }

      function getNextScheduleTime(fromTime = null) {
        const now = fromTime || new Date();
        const start = parseMillitaryTime(SCHED_CONFIG.startTime);
        const end = parseMillitaryTime(SCHED_CONFIG.endTime);
        
        // Calculate interval with swing (Â±15%)
        const swing = SCHED_CONFIG.baseIntervalSec * (SCHED_CONFIG.swingPercent / 100);
        const minInterval = SCHED_CONFIG.baseIntervalSec - swing;
        const maxInterval = SCHED_CONFIG.baseIntervalSec + swing;
        const intervalSec = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
        
        let schedTime = new Date(now.getTime() + intervalSec * 1000);
        
        // Check if within window
        const schedMinutes = schedTime.getHours() * 60 + schedTime.getMinutes();
        const endMinutes = end.hours * 60 + end.minutes;
        
        if (schedMinutes >= endMinutes) {
          // Move to next day's start time
          schedTime.setDate(schedTime.getDate() + 1);
          schedTime.setHours(start.hours, start.minutes, 0, 0);
        }
        
        return schedTime;
      }

      function updateCurrentTimeDisplay() {
        const now = new Date();
        const timeStr = now.toLocaleString("en-US", {
          weekday: "short", month: "short", day: "numeric",
          hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
        });
        const inWindow = isWithinScheduleWindow();
        const windowStatus = inWindow 
          ? '<span style="color: var(--success);">â— IN WINDOW</span>' 
          : '<span style="color: var(--danger);">â—‹ OUTSIDE WINDOW</span>';
        document.getElementById("schedCurrentTime").innerHTML = `${timeStr} ${windowStatus}`;
      }

      async function loadScheduledMessages() {
        updateCurrentTimeDisplay();
        updateSchedStats();
        loadAprMessages();
        loadScheduledList();
      }

      async function updateSchedStats() {
        try {
          const sb = ensureClient();
          // Count APR messages from both tables
          const [cmApr, msgApr, cmSched, msgSched, cmQueued, msgQueued] = await Promise.all([
            sb.from("campaign_messages").select("id", { count: "exact" }).eq("status", "APR"),
            sb.from("messages").select("id", { count: "exact" }).eq("status", "APR"),
            sb.from("campaign_messages").select("id", { count: "exact" }).eq("status", "scheduled"),
            sb.from("messages").select("id", { count: "exact" }).eq("status", "scheduled"),
            sb.from("campaign_messages").select("id", { count: "exact" }).eq("status", "queued"),
            sb.from("messages").select("id", { count: "exact" }).eq("status", "queued")
          ]);

          document.getElementById("schedStatApr").textContent = (cmApr.count || 0) + (msgApr.count || 0);
          document.getElementById("schedStatScheduled").textContent = (cmSched.count || 0) + (msgSched.count || 0);
          document.getElementById("schedStatQueued").textContent = (cmQueued.count || 0) + (msgQueued.count || 0);
        } catch (e) {
          console.error("Error updating scheduled stats:", e);
        }
      }

      async function loadAprMessages() {
        const listEl = document.getElementById("schedAprList");
        listEl.innerHTML = '<div class="loading">Loading...</div>';
        
        try {
          const sb = ensureClient();
          // Get APR messages from both tables
          const [cmRes, msgRes] = await Promise.all([
            sb.from("campaign_messages").select("*").eq("status", "APR").order("generated_at", { ascending: false }).limit(100),
            sb.from("messages").select("*").eq("status", "APR").order("timestamp", { ascending: false }).limit(100)
          ]);

          let messages = [];
          
          // Process campaign_messages
          if (cmRes.data) {
            cmRes.data.forEach(m => {
              messages.push({
                id: m.id,
                source_table: "campaign_messages",
                phone_number: m.phone_number,
                content: m.message_content,
                customer_name: m.customer_name,
                campaign_key: m.campaign_name,
                status: m.status,
                created_at: m.generated_at
              });
            });
          }
          
          // Process messages table
          if (msgRes.data) {
            msgRes.data.forEach(m => {
              messages.push({
                id: m.id,
                source_table: "messages",
                phone_number: m.phone_number,
                content: m.content,
                customer_name: m.payload?.customer_name || "Unknown",
                campaign_key: m.payload?.campaign_key || m.campaign_name || "Unknown",
                status: m.status,
                created_at: m.timestamp
              });
            });
          }

          if (messages.length === 0) {
            listEl.innerHTML = '<div class="muted" style="padding: 20px; text-align: center;">No approved messages ready to schedule</div>';
            return;
          }

          listEl.innerHTML = messages.map(m => `
            <div class="sched-apr-item" data-id="${m.id}" data-source="${m.source_table}" style="padding: 8px; margin-bottom: 6px; background: var(--bg); border-radius: 6px; cursor: pointer; border: 1px solid var(--border);">
              <div style="font-weight: 600; font-size: 11px; color: var(--text);">${m.customer_name || "Unknown"}</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">${m.phone_number}</div>
              <div style="font-size: 10px; color: var(--accent); margin-top: 2px;">${m.campaign_key}</div>
            </div>
          `).join("");

          // Store messages for selection
          scheduledMessages = messages;

          // Add click handlers
          listEl.querySelectorAll(".sched-apr-item").forEach(el => {
            el.addEventListener("click", () => selectSchedMessage(el.dataset.id, el.dataset.source, "apr"));
          });
        } catch (e) {
          listEl.innerHTML = `<div class="muted" style="padding: 20px; text-align: center; color: var(--danger);">Error: ${e.message}</div>`;
        }
      }

      async function loadScheduledList() {
        const listEl = document.getElementById("schedScheduledList");
        listEl.innerHTML = '<div class="loading">Loading...</div>';
        
        const dateFilter = document.getElementById("schedDateFilter").value;
        
        try {
          const sb = ensureClient();
          
          let query1 = sb.from("campaign_messages").select("*").eq("status", "scheduled");
          let query2 = sb.from("messages").select("*").eq("status", "scheduled");
          
          if (dateFilter) {
            const startOfDay = new Date(dateFilter + "T00:00:00").toISOString();
            const endOfDay = new Date(dateFilter + "T23:59:59").toISOString();
            query1 = query1.gte("scheduled_for", startOfDay).lte("scheduled_for", endOfDay);
            query2 = query2.gte("scheduled_for", startOfDay).lte("scheduled_for", endOfDay);
          }
          
          const [cmRes, msgRes] = await Promise.all([
            query1.order("scheduled_for", { ascending: true }).limit(200),
            query2.order("scheduled_for", { ascending: true }).limit(200)
          ]);

          let messages = [];
          
          if (cmRes.data) {
            cmRes.data.forEach(m => {
              messages.push({
                id: m.id,
                source_table: "campaign_messages",
                phone_number: m.phone_number,
                content: m.message_content,
                customer_name: m.customer_name,
                campaign_key: m.campaign_name,
                status: m.status,
                scheduled_for: m.scheduled_for
              });
            });
          }
          
          if (msgRes.data) {
            msgRes.data.forEach(m => {
              messages.push({
                id: m.id,
                source_table: "messages",
                phone_number: m.phone_number,
                content: m.content,
                customer_name: m.payload?.customer_name || "Unknown",
                campaign_key: m.payload?.campaign_key || m.campaign_name || "Unknown",
                status: m.status,
                scheduled_for: m.scheduled_for
              });
            });
          }

          // Sort by scheduled_for
          messages.sort((a, b) => new Date(a.scheduled_for) - new Date(b.scheduled_for));

          if (messages.length === 0) {
            listEl.innerHTML = '<div class="muted" style="padding: 20px; text-align: center;">No scheduled messages' + (dateFilter ? ' for this date' : '') + '</div>';
            return;
          }

          listEl.innerHTML = messages.map(m => {
            const schedTime = m.scheduled_for ? new Date(m.scheduled_for).toLocaleString("en-US", {
              month: "short", day: "numeric", hour: "numeric", minute: "2-digit", hour12: true
            }) : "Not set";
            return `
              <div class="sched-item" data-id="${m.id}" data-source="${m.source_table}" style="padding: 10px; margin-bottom: 6px; background: var(--panel); border-radius: 6px; cursor: pointer; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; font-size: 12px; color: var(--text);">${m.customer_name || "Unknown"}</div>
                  <div style="font-size: 10px; color: var(--muted);">${m.phone_number}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 11px; color: var(--warn); font-weight: 600;">â° ${schedTime}</div>
                  <div style="font-size: 9px; color: var(--accent);">${m.campaign_key}</div>
                </div>
              </div>
            `;
          }).join("");

          // Add click handlers
          listEl.querySelectorAll(".sched-item").forEach(el => {
            el.addEventListener("click", () => selectSchedMessage(el.dataset.id, el.dataset.source, "scheduled"));
          });
        } catch (e) {
          listEl.innerHTML = `<div class="muted" style="padding: 20px; text-align: center; color: var(--danger);">Error: ${e.message}</div>`;
        }
      }

      function selectSchedMessage(id, source, type) {
        const msg = scheduledMessages.find(m => String(m.id) === String(id) && m.source_table === source);
        if (!msg) return;
        
        selectedSchedMessage = msg;
        
        // Update preview
        const previewEl = document.getElementById("schedMessagePreview");
        const schedTime = msg.scheduled_for ? new Date(msg.scheduled_for).toLocaleString() : "Not scheduled";
        
        previewEl.innerHTML = `
          <div style="margin-bottom: 12px;">
            <div style="font-weight: 700; font-size: 14px; color: var(--text);">${msg.customer_name || "Unknown"}</div>
            <div style="font-size: 12px; color: var(--muted);">${msg.phone_number}</div>
            <div style="font-size: 11px; color: var(--accent); margin-top: 4px;">${msg.campaign_key}</div>
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">
            Status: <span style="color: var(--${msg.status === 'APR' ? 'success' : 'warn'}); font-weight: 600;">${msg.status}</span>
            ${msg.scheduled_for ? `<br>Scheduled: <span style="color: var(--warn);">${schedTime}</span>` : ''}
          </div>
          <div style="background: var(--bg); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap;">${msg.content}</div>
        `;

        // Enable action buttons
        document.getElementById("schedBtnReschedule").disabled = false;
        document.getElementById("schedBtnSendNow").disabled = false;
        document.getElementById("schedBtnCancel").disabled = false;
      }

      async function scheduleAllAprMessages() {
        try {
          const sb = ensureClient();
          
          // Get all APR messages
          const [cmRes, msgRes] = await Promise.all([
            sb.from("campaign_messages").select("id").eq("status", "APR"),
            sb.from("messages").select("id").eq("status", "APR")
          ]);

          const cmIds = (cmRes.data || []).map(m => m.id);
          const msgIds = (msgRes.data || []).map(m => m.id);
          const totalCount = cmIds.length + msgIds.length;

          if (totalCount === 0) {
            showSchedToast("No APR messages to schedule", true);
            return;
          }

          // Calculate schedule times using config (military time)
          const now = new Date();
          const start = parseMillitaryTime(SCHED_CONFIG.startTime);
          const end = parseMillitaryTime(SCHED_CONFIG.endTime);
          const endMinutes = end.hours * 60 + end.minutes;
          
          let scheduleDate = new Date(now);
          
          // If outside window, start at next window
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          
          if (currentMinutes >= endMinutes) {
            scheduleDate.setDate(scheduleDate.getDate() + 1);
          }
          
          // Start at window start or now if within window
          let startTime = new Date(scheduleDate);
          startTime.setHours(start.hours, start.minutes, 0, 0);
          
          if (isWithinScheduleWindow()) {
            // Start from now + one interval
            startTime = getNextScheduleTime(now);
          }
          
          // Calculate time slots with 180s base Â±15% swing
          const scheduleTimes = [];
          let currentTime = new Date(startTime);
          
          for (let i = 0; i < totalCount; i++) {
            // Check if past end of window
            const currMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
            if (currMinutes >= endMinutes) {
              // Move to next day's start time
              currentTime.setDate(currentTime.getDate() + 1);
              currentTime.setHours(start.hours, start.minutes, 0, 0);
            }
            scheduleTimes.push(new Date(currentTime));
            currentTime = getNextScheduleTime(currentTime);
          }

          // Update campaign_messages
          for (let i = 0; i < cmIds.length; i++) {
            await sb.from("campaign_messages")
              .update({ status: "scheduled", scheduled_for: scheduleTimes[i].toISOString() })
              .eq("id", cmIds[i]);
          }

          // Update messages
          for (let i = 0; i < msgIds.length; i++) {
            await sb.from("messages")
              .update({ status: "scheduled", scheduled_for: scheduleTimes[cmIds.length + i].toISOString() })
              .eq("id", msgIds[i]);
          }

          showSchedToast(`Scheduled ${totalCount} messages!`);
          loadScheduledMessages();
        } catch (e) {
          showSchedToast("Error scheduling: " + e.message, true);
        }
      }

      // Auto-Q: Automatically queue APR messages
      async function processAutoQ() {
        if (!autoQEnabled) return;
        if (!isWithinScheduleWindow()) {
          console.log("Auto-Q: Outside schedule window, skipping");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          // Get one APR message to queue
          const [cmRes, msgRes] = await Promise.all([
            sb.from("campaign_messages").select("id").eq("status", "APR").limit(1),
            sb.from("messages").select("id").eq("status", "APR").limit(1)
          ]);

          let queued = false;
          
          if (cmRes.data && cmRes.data.length > 0) {
            await sb.from("campaign_messages")
              .update({ status: "queued" })
              .eq("id", cmRes.data[0].id);
            queued = true;
          } else if (msgRes.data && msgRes.data.length > 0) {
            await sb.from("messages")
              .update({ status: "queued" })
              .eq("id", msgRes.data[0].id);
            queued = true;
          }
          
          if (queued) {
            console.log("Auto-Q: Queued 1 message");
            updateSchedStats();
            loadAprMessages();
          }
        } catch (e) {
          console.error("Auto-Q error:", e);
        }
      }

      function toggleAutoQ() {
        autoQEnabled = document.getElementById("schedAutoQ").checked;
        
        if (autoQEnabled) {
          // Calculate interval with swing
          const swing = SCHED_CONFIG.baseIntervalSec * (SCHED_CONFIG.swingPercent / 100);
          const minInterval = (SCHED_CONFIG.baseIntervalSec - swing) * 1000;
          const maxInterval = (SCHED_CONFIG.baseIntervalSec + swing) * 1000;
          
          // Start Auto-Q interval
          const runAutoQ = () => {
            processAutoQ();
            // Schedule next with random interval
            const nextInterval = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
            autoQInterval = setTimeout(runAutoQ, nextInterval);
          };
          
          showSchedToast("Auto-Q enabled! Messages will queue automatically.");
          processAutoQ(); // Run immediately
          const firstInterval = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
          autoQInterval = setTimeout(runAutoQ, firstInterval);
        } else {
          if (autoQInterval) {
            clearTimeout(autoQInterval);
            autoQInterval = null;
          }
          showSchedToast("Auto-Q disabled");
        }
      }

      async function sendSchedMessageNow() {
        if (!selectedSchedMessage) return;
        
        try {
          const sb = ensureClient();
          const table = selectedSchedMessage.source_table;
          
          // Update status to 'queued' so conductor picks it up immediately
          if (table === "messages") {
            await sb.from("messages")
              .update({ status: "queued", scheduled_for: null })
              .eq("id", selectedSchedMessage.id);
          } else {
            await sb.from("campaign_messages")
              .update({ status: "queued", scheduled_for: null })
              .eq("id", selectedSchedMessage.id);
          }
          
          showSchedToast("Message queued for immediate send!");
          selectedSchedMessage = null;
          loadScheduledMessages();
        } catch (e) {
          showSchedToast("Error: " + e.message, true);
        }
      }

      async function cancelSchedMessage() {
        if (!selectedSchedMessage) return;
        
        try {
          const sb = ensureClient();
          const table = selectedSchedMessage.source_table;
          
          if (table === "messages") {
            await sb.from("messages")
              .update({ status: "cancelled", scheduled_for: null })
              .eq("id", selectedSchedMessage.id);
          } else {
            await sb.from("campaign_messages")
              .update({ status: "cancelled", scheduled_for: null })
              .eq("id", selectedSchedMessage.id);
          }
          
          showSchedToast("Message cancelled");
          selectedSchedMessage = null;
          loadScheduledMessages();
        } catch (e) {
          showSchedToast("Error: " + e.message, true);
        }
      }

      function showSchedToast(message, isError = false) {
        let toast = document.getElementById("schedToast");
        if (!toast) {
          toast = document.createElement("div");
          toast.id = "schedToast";
          toast.style.cssText = "position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000;";
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.background = isError ? "var(--danger)" : "var(--success)";
        toast.style.color = "#fff";
        toast.style.transform = "translateY(0)";
        toast.style.opacity = "1";
        setTimeout(() => {
          toast.style.transform = "translateY(100px)";
          toast.style.opacity = "0";
        }, 3000);
      }

      // ========== MESSAGES TAB FUNCTIONS ==========
      let msgConversations = [];
      let msgCurrentPhone = null;
      let msgFilterMode = "all";
      let msgLiveTimer = null;
      let lastKnownUnreadCount = 0;
      let newMessageCheckInterval = null;

      // Normalize phone number to just last 10 digits (strips +1, parentheses, dashes, spaces)
      function normalizePhone(phone) {
        if (!phone) return "";
        return (phone + "").replace(/\D/g, "").slice(-10);
      }
      
      // Check for new messages and update the Messages tab indicator
      async function checkForNewMessages() {
        try {
          const sb = ensureClient();
          const { count: unreadCount } = await sb
            .from("messages")
            .select("id", { count: "exact" })
            .eq("direction", "inbound")
            .eq("status", "unread");
          
          const messagesTab = document.getElementById("messagesTab");
          if (!messagesTab) return;
          
          // If there are unread messages and we're not on the messages tab, show the pulse
          if (unreadCount > 0 && activeTab !== "messages") {
            messagesTab.classList.add("has-new-messages");
          } else {
            messagesTab.classList.remove("has-new-messages");
          }
          
          // If count increased, there's a new message - could add sound/notification here
          if (unreadCount > lastKnownUnreadCount && lastKnownUnreadCount > 0) {
            console.log(`New message detected! Unread: ${lastKnownUnreadCount} -> ${unreadCount}`);
          }
          
          lastKnownUnreadCount = unreadCount || 0;
        } catch (e) {
          console.error("Error checking for new messages:", e);
        }
      }
      
      // Start periodic checking for new messages
      function startNewMessageChecker() {
        if (newMessageCheckInterval) clearInterval(newMessageCheckInterval);
        checkForNewMessages(); // Check immediately
        newMessageCheckInterval = setInterval(checkForNewMessages, 10000); // Check every 10 seconds
      }

      // Get all possible phone formats for database queries
      function getPhoneVariants(phone) {
        const digits = normalizePhone(phone);
        if (digits.length !== 10) return [phone];
        
        // Return multiple formats that might exist in the database
        return [
          digits,                                           // 6199773020
          `+1${digits}`,                                   // +16199773020
          `1${digits}`,                                    // 16199773020
          `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`, // (619) 977-3020
          `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`,   // 619-977-3020
          `${digits.slice(0,3)}.${digits.slice(3,6)}.${digits.slice(6)}`,   // 619.977.3020
        ];
      }

      // Decode UCS2/UTF-16BE hex payloads to readable text
      function decodeHexUCS2(s) {
        if (!s || typeof s !== "string") return s;
        const compact = s.replace(/\s+/g, "");
        // Must be all hex and even length (at least 4 chars for one code unit)
        if (!/^[0-9a-fA-F]+$/.test(compact)) return s;
        if (compact.length % 4 !== 0 || compact.length < 4) return s;
        try {
          // Parse as UTF-16BE code units
          const codeUnits = [];
          for (let i = 0; i < compact.length; i += 4) {
            const hex = compact.slice(i, i + 4);
            codeUnits.push(parseInt(hex, 16));
          }
          // Convert code units to string (handles surrogate pairs)
          const out = String.fromCharCode(...codeUnits);
          // If result contains mostly printable/emoji chars, accept it
          // Check if it looks like decoded text vs garbage
          const hasReadable = /[\p{L}\p{N}\p{P}\p{S}\p{Emoji}]/u.test(out);
          if (hasReadable) return out;
          return s;
        } catch {
          return s;
        }
      }

      async function loadMessagesTab() {
        updateMsgStats();
        loadMsgConversations();
      }

      async function updateMsgStats() {
        try {
          const sb = ensureClient();
          // Count conversations with inbound messages
          const { data: inboundPhones } = await sb
            .from("messages")
            .select("phone_number")
            .eq("direction", "inbound");
          
          const uniquePhones = new Set((inboundPhones || []).map(m => m.phone_number));
          
          // Count unread
          const { count: unreadCount } = await sb
            .from("messages")
            .select("id", { count: "exact" })
            .eq("direction", "inbound")
            .eq("status", "unread");
          
          // Count inbound today
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const { count: todayCount } = await sb
            .from("messages")
            .select("id", { count: "exact" })
            .eq("direction", "inbound")
            .gte("timestamp", today.toISOString());
          
          document.getElementById("msgStatConvos").textContent = uniquePhones.size;
          document.getElementById("msgStatUnread").textContent = unreadCount || 0;
          document.getElementById("msgStatInbound").textContent = todayCount || 0;
        } catch (e) {
          console.error("Error updating message stats:", e);
        }
      }

      async function loadMsgConversations() {
        try {
          const sb = ensureClient();
          
          // Get all messages, ordered by timestamp desc
          // Exclude campaign statuses by filtering only real message statuses
          const { data: allMsgs, error } = await sb
            .from("messages")
            .select("id, phone_number, content, direction, status, timestamp")
            .in("status", ["sent", "read", "unread", "queued", "failed", "delivered"])
            .order("timestamp", { ascending: false })
            .limit(2000);
          
          if (error) throw error;
          
          // Build conversation map - group by NORMALIZED phone (last 10 digits)
          // This ensures +16199773020 and 6199773020 are treated as the same conversation
          const convoMap = new Map();
          const hasInbound = new Set();
          
          (allMsgs || []).forEach(m => {
            const normalizedPhone = normalizePhone(m.phone_number);
            if (m.direction === "inbound") {
              hasInbound.add(normalizedPhone);
            }
          });
          
          (allMsgs || []).forEach(m => {
            const normalizedPhone = normalizePhone(m.phone_number);
            
            // Only include conversations that have inbound messages
            if (!hasInbound.has(normalizedPhone)) return;
            
            if (!convoMap.has(normalizedPhone)) {
              convoMap.set(normalizedPhone, {
                phone_number: m.phone_number, // Keep original format for display
                normalizedPhone: normalizedPhone,
                lastMessage: m,
                inCount: 0,
                outCount: 0,
                hasUnread: false,
                lastTimestamp: m.timestamp
              });
            }
            const convo = convoMap.get(normalizedPhone);
            if (m.direction === "inbound") {
              convo.inCount++;
              if (m.status === "unread") convo.hasUnread = true;
            } else {
              convo.outCount++;
            }
          });
          
          msgConversations = Array.from(convoMap.values());
          
          // Sort by last message timestamp (most recent first)
          msgConversations.sort((a, b) => new Date(b.lastTimestamp) - new Date(a.lastTimestamp));
          
          // Batch lookup all customers at once (much faster than individual lookups)
          const allPhones = msgConversations.map(c => c.phone_number);
          await batchLookupCustomers(allPhones);
          
          // Now resolve from cache using normalized phone
          msgConversations.forEach(c => {
            const cust = customerPhoneCache.get(c.normalizedPhone);
            c.customerName = cust ? `${cust.first_name || ""} ${cust.last_name || ""}`.trim() || cust.name : null;
            c.customerId = cust?.member_id || cust?.id;
          });
          
          renderMsgConversations();
        } catch (e) {
          console.error("Error loading conversations:", e);
          document.getElementById("msgConvoList").innerHTML = 
            `<div class="muted" style="padding: 20px; text-align: center;">Error loading conversations</div>`;
        }
      }

      // Customer cache to avoid repeated lookups
      const customerPhoneCache = new Map();
      
      async function findCustomerByPhoneQuick(phone) {
        if (!phone) return null;
        
        const digits = (phone + "").replace(/\D/g, "").slice(-10);
        if (digits.length < 10) return null;
        
        // Check cache first
        if (customerPhoneCache.has(digits)) {
          return customerPhoneCache.get(digits);
        }
        
        try {
          const sb = ensureClient();
          
          // Try both 10-digit and 11-digit (with leading 1) formats
          // because customers_blaze stores phones in various formats
          // UPDATED: Check phone column only (phone_number does not exist in customers_blaze)
          let { data } = await sb
            .from("customers_blaze")
            .select("member_id, id, first_name, last_name, name, phone")
            .ilike('phone', `%${digits}%`)
            .limit(1);
          
          if (data && data.length > 0) {
            // Cache by normalized 10-digit phone
            customerPhoneCache.set(digits, data[0]);
            return data[0];
          }
          
          // Cache null result to avoid repeated lookups
          customerPhoneCache.set(digits, null);
          return null;
        } catch (e) {
          console.error("Customer lookup error:", e);
          return null;
        }
      }
      
      // Batch lookup customers for multiple phones at once
      async function batchLookupCustomers(phones) {
        const sb = ensureClient();
        const uncached = [];
        const uncachedSet = new Set();
        
        // Collect uncached phone numbers (normalized to 10 digits)
        phones.forEach(p => {
          const digits = (p + "").replace(/\D/g, "").slice(-10);
          if (digits.length === 10 && !customerPhoneCache.has(digits) && !uncachedSet.has(digits)) {
            uncached.push(digits);
            uncachedSet.add(digits);
          }
        });
        
        if (uncached.length === 0) return;
        
        try {
          // Build query variants: both 10-digit and 11-digit (with leading 1) formats
          // because customers_blaze stores phones in various formats
          // Build query conditions for ilike matching (to handle formatted phone numbers in DB)
          // UPDATED: Check BOTH phone and phone_number columns
          const queryConditions = uncached.map(digits => {
            // Use ilike for partial matching to handle various formats
            return `phone.ilike.%${digits}%`;
          }).join(',');
          
          // Fetch all at once
          const { data, error: fetchError } = await sb
            .from("customers_blaze")
            .select("member_id, id, first_name, last_name, name, phone")
            .or(queryConditions);
          
          if (fetchError) {
            console.error("Batch customer lookup query error:", fetchError.message);
            return;
          }
          
          // Cache results by NORMALIZED 10-digit phone (not database phone)
          const foundNormalized = new Set();
          (data || []).forEach(c => {
            // Check phone field
            const norm = c.phone ? (c.phone + "").replace(/\D/g, "").slice(-10) : "";
            
            if (norm.length === 10) {
              customerPhoneCache.set(norm, c);
              foundNormalized.add(norm);
            }
          });
          
          // Cache null for not found
          uncached.forEach(digits => {
            if (!foundNormalized.has(digits)) {
              customerPhoneCache.set(digits, null);
            }
          });
        } catch (e) {
          console.error("Batch customer lookup error:", e);
        }
      }

      function renderMsgConversations() {
        const container = document.getElementById("msgConvoList");
        const searchQuery = (document.getElementById("msgSearchInput")?.value || "").toLowerCase().trim();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
          const currentNormalized = normalizePhone(msgCurrentPhone);
        
        let filtered = msgConversations.filter(c => {
          // Filter mode
          if (msgFilterMode === "unread" && !c.hasUnread) return false;
          if (msgFilterMode === "today") {
            const msgDate = new Date(c.lastTimestamp);
            if (msgDate < today) return false;
          }
          
          // Search filter
          if (searchQuery) {
            const searchText = `${c.phone_number} ${c.customerName || ""}`.toLowerCase();
            if (!searchText.includes(searchQuery)) return false;
          }
          
          return true;
        });
        
        if (filtered.length === 0) {
          container.innerHTML = `<div class="muted" style="padding: 20px; text-align: center;">No conversations found</div>`;
          return;
        }
        
        container.innerHTML = filtered.map(c => {
          // Use normalized phone for active state check
          const isActive = c.normalizedPhone === currentNormalized || normalizePhone(c.phone_number) === currentNormalized;
          const rawContent = c.lastMessage?.content || "";
          const preview = decodeHexUCS2(rawContent).slice(0, 60);
          const time = formatMsgTime(c.lastMessage?.timestamp);
          const dirBadge = c.lastMessage?.direction === "inbound" 
            ? `<span class="convo-badge inbox">IN</span>` 
            : "";
          const unreadBadge = c.hasUnread 
            ? `<span class="convo-badge unread">NEW</span>` 
            : "";
          
          // Name logic: Big and Bold for Name, Small for Phone
          const nameDisplay = c.customerName || "Unknown Customer";
          const phoneDisplay = c.phone_number;
          
          return `
            <div class="msg-convo-item ${isActive ? "active" : ""}" data-phone="${c.phone_number}">
              <div class="convo-name" style="font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 2px;">${nameDisplay}</div>
              <div class="convo-phone" style="font-size: 11px; color: var(--muted); margin-bottom: 4px; font-family: monospace;">${phoneDisplay}</div>
              <div class="convo-preview">${preview}</div>
              <div class="convo-meta">
                <span class="convo-time">${time}</span>
                <span>${unreadBadge} ${dirBadge}</span>
              </div>
            </div>
          `;
        }).join("");
        
        // Add click handlers
        container.querySelectorAll(".msg-convo-item").forEach(el => {
          el.addEventListener("click", () => {
            const phone = el.dataset.phone;
            selectMsgConversation(phone);
          });
        });
      }

      function formatMsgTime(timestamp) {
        if (!timestamp) return "";
        const d = new Date(timestamp);
        const now = new Date();
        const diffMs = now - d;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return "Just now";
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return d.toLocaleDateString();
      }

      async function selectMsgConversation(phone) {
        // Store normalized phone for consistent matching
        const normalized = normalizePhone(phone);
        msgCurrentPhone = phone;
        renderMsgConversations(); // Update active state
        
        // Update header - find by normalized phone
        const convo = msgConversations.find(c => c.normalizedPhone === normalized || normalizePhone(c.phone_number) === normalized);
        const headerText = convo?.customerName 
          ? `${convo.customerName} <span style="font-weight:normal; color:var(--muted); font-size:0.9em; margin-left:8px;">${phone}</span>` 
          : `<span style="font-weight:700;">Unknown Customer</span> <span style="font-weight:normal; color:var(--muted); font-size:0.9em; margin-left:8px;">${phone}</span>`;
        document.getElementById("msgThreadHeader").innerHTML = headerText;
        
        // Load thread using normalized phone
        await loadMsgThread(phone);
        
        // Load customer card
        await loadMsgCustomerCard(phone, convo?.customerId);
      }

      async function loadMsgThread(phone) {
        const container = document.getElementById("msgThreadContent");
        container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Loading...</div>`;
        
        try {
          const sb = ensureClient();
          
          // Normalize phone for flexible matching
          const digits = normalizePhone(phone);
          const ilikePattern = `%${digits}%`;
          
          // Get ALL messages for this phone using flexible matching
          // Include only real message statuses (not campaign messages)
          const { data: messages, error } = await sb
            .from("messages")
            .select("id, phone_number, content, direction, status, timestamp")
            .ilike("phone_number", ilikePattern)
            .in("status", ["sent", "read", "unread", "queued", "delivered", "failed", "rejected"])
            .order("timestamp", { ascending: true })
            .limit(500);
          
          if (error) throw error;
          
          // Filter to exact phone match (last 10 digits)
          const filtered = (messages || []).filter(m => 
            normalizePhone(m.phone_number) === digits
          );
          
          if (filtered.length === 0) {
            container.innerHTML = `<div class="muted" style="text-align: center; padding: 40px;">No messages</div>`;
            return;
          }
          
          container.innerHTML = filtered.map(m => {
            const isInbound = m.direction === "inbound";
            const bubbleClass = isInbound ? "inbound" : "outbound";
            const time = new Date(m.timestamp).toLocaleString();
            const status = m.status ? `<span class="bubble-status">${m.status.toUpperCase()}</span>` : "";
            const decoded = decodeHexUCS2(m.content || "");
            const content = decoded.replace(/\n/g, "<br>");
            
            return `
              <div class="msg-bubble ${bubbleClass}">
                <div>${content}</div>
                <div class="bubble-time">${time} ${status}</div>
              </div>
            `;
          }).join("");
          
          // Scroll to bottom
          container.scrollTop = container.scrollHeight;
        } catch (e) {
          console.error("Error loading thread:", e);
          container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Error loading messages</div>`;
        }
      }

      async function loadMsgCustomerCard(phone, customerId) {
        const cardEl = document.getElementById("msgCardText");
        const analyticsEl = document.getElementById("msgAnalyticsText");
        cardEl.textContent = "Loading...";
        analyticsEl.textContent = "Loading...";
        
        try {
          const sb = ensureClient();
          let customer = null;
          
          // Strategy 1: Look up by customer_id if provided
          if (customerId) {
            // Try main customers table first
            let r = await sb.from("customers").select("*").eq("member_id", customerId).limit(1);
            customer = r.data?.[0];
            
            // Fallback to customers_blaze
            if (!customer) {
              r = await sb.from("customers_blaze").select("*").eq("member_id", customerId).limit(1);
              customer = r.data?.[0];
            }
          }
          
          if (!customer) {
            // Try phone lookup with multiple strategies
            const digits = normalizePhone(phone);
            
            // Strategy 1: Direct ilike match on phone
            let { data } = await sb
              .from("customers_blaze")
              .select("*")
              .ilike('phone', `%${digits}%`)
              .limit(1);
            customer = data?.[0];
            
            // Strategy 2: Exact 10-digit match on phone
            if (!customer) {
              const last10 = digits.slice(-10);
              const { data: data2 } = await sb
                .from("customers_blaze")
                .select("*")
                .eq('phone', last10)
                .limit(1);
              customer = data2?.[0];
            }
          }
          
          if (!customer) {
            cardEl.textContent = `Unknown Customer\nPhone: ${phone}\n\nNo customer record found in database.`;
            analyticsEl.textContent = "No analytics available.";
            return;
          }
          
          // Use the SAME buildBaseballCard function from Customers/Suggested tab
          const cid = customer.member_id || customer.customer_id || customer.id;
          
          // Fetch transactions
          const { data: txs } = await sb
            .from("transactions_blaze")
            .select("*")
            .eq("customer_id", cid)
            .order("date", { ascending: false })
            .limit(100);
          
          // Fetch transaction items
          const txIds = (txs || []).map(t => t.id || t.transaction_id).filter(Boolean);
          let itemsList = [];
          if (txIds.length > 0) {
            const { data: items } = await sb
              .from("transaction_items_blaze")
              .select("*")
              .in("transaction_id", txIds)
              .limit(5000);
            itemsList = items || [];
          }
          
          // Use the main buildBaseballCard function (same as Customers/Suggested tab)
          const cardText = await buildBaseballCard(customer, txs || [], itemsList);
          cardEl.textContent = cardText;
          
          // Use the main buildAnalyticsText function (same as Customers/Suggested tab)
          const analyticsText = await buildAnalyticsText(customer, txs || [], itemsList);
          analyticsEl.textContent = analyticsText;
          
        } catch (e) {
          console.error("Error loading customer card:", e);
          cardEl.textContent = "Error loading customer info";
          analyticsEl.textContent = "Error loading analytics";
        }
      }

      function calculateAge(dob) {
        if (!dob) return null;
        const d = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - d.getFullYear();
        const m = today.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
        return age;
      }

      async function sendMsgReply() {
        if (!msgCurrentPhone) {
          alert("Select a conversation first.");
          return;
        }
        
        const content = (document.getElementById("msgReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          // Split by [BUBBLE] for multi-part messages
          let bubbles = content.split("[BUBBLE]").map(s => s.trim()).filter(Boolean);
          if (bubbles.length === 0) bubbles = [content];
          
          for (const bubble of bubbles) {
            const { error } = await sb.from("messages").insert({
              phone_number: msgCurrentPhone,
              content: bubble,
              direction: "outbound",
              status: "queued",
              timestamp: new Date().toISOString()
            });
            if (error) throw error;
          }
          
          alert(`Queued ${bubbles.length} message(s). Conductor will send shortly.`);
          document.getElementById("msgReplyText").value = "";
          updateMsgCharCount();
          
          // Reload thread
          await loadMsgThread(msgCurrentPhone);
          await loadMsgConversations();
        } catch (e) {
          console.error("Error sending reply:", e);
          alert("Failed to send: " + e.message);
        }
      }

      // Queue message without sending immediately (status = QUE)
      async function queueMsgReply() {
        if (!msgCurrentPhone) {
          alert("Select a conversation first.");
          return;
        }
        
        const content = (document.getElementById("msgReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          // Split by [BUBBLE] for multi-part messages
          let bubbles = content.split("[BUBBLE]").map(s => s.trim()).filter(Boolean);
          if (bubbles.length === 0) bubbles = [content];
          
          for (const bubble of bubbles) {
            const { error } = await sb.from("messages").insert({
              phone_number: msgCurrentPhone,
              content: bubble,
              direction: "outbound",
              status: "QUE",
              timestamp: new Date().toISOString()
            });
            if (error) throw error;
          }
          
          alert(`Added ${bubbles.length} message(s) to queue (QUE status).`);
          document.getElementById("msgReplyText").value = "";
          updateMsgCharCount();
          
          // Reload thread
          await loadMsgThread(msgCurrentPhone);
          await loadMsgConversations();
        } catch (e) {
          console.error("Error queuing message:", e);
          alert("Failed to queue: " + e.message);
        }
      }

      // Show schedule modal
      function showMsgScheduleModal() {
        const modal = document.getElementById("msgScheduleModal");
        if (modal) {
          modal.style.display = "block";
          // Set default date to today and time to next hour
          const now = new Date();
          const dateInput = document.getElementById("msgScheduleDate");
          const timeInput = document.getElementById("msgScheduleTime");
          if (dateInput) dateInput.value = now.toISOString().split("T")[0];
          if (timeInput) {
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            timeInput.value = now.toTimeString().slice(0, 5);
          }
        }
      }

      // Hide schedule modal
      function hideMsgScheduleModal() {
        const modal = document.getElementById("msgScheduleModal");
        if (modal) modal.style.display = "none";
      }

      // Schedule message for later
      async function scheduleMsgReply() {
        if (!msgCurrentPhone) {
          alert("Select a conversation first.");
          return;
        }
        
        const content = (document.getElementById("msgReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        const dateVal = document.getElementById("msgScheduleDate")?.value;
        const timeVal = document.getElementById("msgScheduleTime")?.value;
        
        if (!dateVal || !timeVal) {
          alert("Please select a date and time.");
          return;
        }
        
        const scheduledFor = new Date(`${dateVal}T${timeVal}`);
        if (scheduledFor <= new Date()) {
          alert("Scheduled time must be in the future.");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          // Split by [BUBBLE] for multi-part messages
          let bubbles = content.split("[BUBBLE]").map(s => s.trim()).filter(Boolean);
          if (bubbles.length === 0) bubbles = [content];
          
          for (const bubble of bubbles) {
            const { error } = await sb.from("messages").insert({
              phone_number: msgCurrentPhone,
              content: bubble,
              direction: "outbound",
              status: "scheduled",
              scheduled_for: scheduledFor.toISOString(),
              timestamp: new Date().toISOString()
            });
            if (error) throw error;
          }
          
          alert(`Scheduled ${bubbles.length} message(s) for ${scheduledFor.toLocaleString()}.`);
          document.getElementById("msgReplyText").value = "";
          updateMsgCharCount();
          hideMsgScheduleModal();
          
          // Reload thread
          await loadMsgThread(msgCurrentPhone);
          await loadMsgConversations();
        } catch (e) {
          console.error("Error scheduling message:", e);
          alert("Failed to schedule: " + e.message);
        }
      }

      // ========== CUSTOMERS TAB SMS FUNCTIONS ==========
      let custCurrentPhone = null;
      let custCurrentCustomerId = null;

      // Load SMS thread for selected customer
      async function loadCustSmsThread(phone, customerName) {
        custCurrentPhone = phone;
        
        // Update header
        document.getElementById("custSmsName").textContent = customerName || "Unknown";
        document.getElementById("custSmsPhone").textContent = phone || "â€”";
        
        const container = document.getElementById("custSmsThread");
        if (!phone) {
          container.innerHTML = '<div class="muted" style="text-align: center; padding: 40px; font-size: 11px;">Select a customer to view messages</div>';
          return;
        }
        
        container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">Loading...</div>';
        
        try {
          const sb = ensureClient();
          const digits = normalizePhone(phone);
          const ilikePattern = `%${digits}%`;
          
          const { data: messages, error } = await sb
            .from("messages")
            .select("id, content, direction, status, timestamp, phone_number")
            .ilike("phone_number", ilikePattern)
            .in("status", ["sent", "read", "unread", "queued", "failed", "delivered", "rejected", "QUE", "scheduled"])
            .order("timestamp", { ascending: true })
            .limit(100);
          
          if (error) throw error;
          
          console.log(`loadCustSmsThread: phone=${phone}, digits=${digits}, found ${messages?.length || 0} messages`);
          
          // Filter to exact phone match
          const filtered = (messages || []).filter(m => normalizePhone(m.phone_number) === digits);
          console.log(`loadCustSmsThread: after filter, ${filtered.length} messages match`);
          
          if (filtered.length === 0) {
            container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px; font-size: 11px;">No messages yet</div>';
            return;
          }
          
          container.innerHTML = filtered.map(m => {
            const isInbound = m.direction === "inbound";
            const bubbleClass = isInbound ? "inbound" : "outbound";
            const time = new Date(m.timestamp).toLocaleString();
            const status = m.status ? `<span class="bubble-status">${m.status.toUpperCase()}</span>` : "";
            const decoded = decodeHexUCS2(m.content || "");
            const content = decoded.replace(/\n/g, "<br>");
            
            return `
              <div class="msg-bubble ${bubbleClass}">
                <div>${content}</div>
                <div class="bubble-time">${time} ${status}</div>
              </div>
            `;
          }).join("");
          
          container.scrollTop = container.scrollHeight;
        } catch (e) {
          console.error("Error loading customer SMS thread:", e);
          container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">Error loading messages</div>';
        }
      }

      // Send SMS from Customers tab
      async function sendCustSmsReply() {
        if (!custCurrentPhone) {
          alert("Select a customer first.");
          return;
        }
        
        const content = (document.getElementById("custSmsReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          let bubbles = content.split("[BUBBLE]").map(s => s.trim()).filter(Boolean);
          if (bubbles.length === 0) bubbles = [content];
          
          for (const bubble of bubbles) {
            const { error } = await sb.from("messages").insert({
              phone_number: custCurrentPhone,
              content: bubble,
              direction: "outbound",
              status: "queued",
              timestamp: new Date().toISOString()
            });
            if (error) throw error;
          }
          
          alert(`Queued ${bubbles.length} message(s). Conductor will send shortly.`);
          document.getElementById("custSmsReplyText").value = "";
          updateCustSmsCharCount();
          
          // Reload thread
          await loadCustSmsThread(custCurrentPhone, document.getElementById("custSmsName")?.textContent);
        } catch (e) {
          console.error("Error sending customer SMS:", e);
          alert("Failed to send: " + e.message);
        }
      }

      // Queue SMS from Customers tab (status = QUE)
      async function queueCustSmsReply() {
        if (!custCurrentPhone) {
          alert("Select a customer first.");
          return;
        }
        
        const content = (document.getElementById("custSmsReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          let bubbles = content.split("[BUBBLE]").map(s => s.trim()).filter(Boolean);
          if (bubbles.length === 0) bubbles = [content];
          
          for (const bubble of bubbles) {
            const { error } = await sb.from("messages").insert({
              phone_number: custCurrentPhone,
              content: bubble,
              direction: "outbound",
              status: "QUE",
              timestamp: new Date().toISOString()
            });
            if (error) throw error;
          }
          
          alert(`Added ${bubbles.length} message(s) to queue (QUE status).`);
          document.getElementById("custSmsReplyText").value = "";
          updateCustSmsCharCount();
          
          await loadCustSmsThread(custCurrentPhone, document.getElementById("custSmsName")?.textContent);
        } catch (e) {
          console.error("Error queuing customer SMS:", e);
          alert("Failed to queue: " + e.message);
        }
      }

      // Show schedule modal for Customers tab
      function showCustSmsScheduleModal() {
        const modal = document.getElementById("custSmsScheduleModal");
        if (modal) {
          modal.style.display = "block";
          const now = new Date();
          const dateInput = document.getElementById("custSmsScheduleDate");
          const timeInput = document.getElementById("custSmsScheduleTime");
          if (dateInput) dateInput.value = now.toISOString().split("T")[0];
          if (timeInput) {
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            timeInput.value = now.toTimeString().slice(0, 5);
          }
        }
      }

      // Hide schedule modal for Customers tab
      function hideCustSmsScheduleModal() {
        const modal = document.getElementById("custSmsScheduleModal");
        if (modal) modal.style.display = "none";
      }

      // Schedule SMS from Customers tab
      async function scheduleCustSmsReply() {
        if (!custCurrentPhone) {
          alert("Select a customer first.");
          return;
        }
        
        const content = (document.getElementById("custSmsReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        const dateVal = document.getElementById("custSmsScheduleDate")?.value;
        const timeVal = document.getElementById("custSmsScheduleTime")?.value;
        
        if (!dateVal || !timeVal) {
          alert("Please select a date and time.");
          return;
        }
        
        const scheduledFor = new Date(`${dateVal}T${timeVal}`);
        if (scheduledFor <= new Date()) {
          alert("Scheduled time must be in the future.");
          return;
        }
        
        try {
          const sb = ensureClient();
          
          let bubbles = content.split("[BUBBLE]").map(s => s.trim()).filter(Boolean);
          if (bubbles.length === 0) bubbles = [content];
          
          for (const bubble of bubbles) {
            const { error } = await sb.from("messages").insert({
              phone_number: custCurrentPhone,
              content: bubble,
              direction: "outbound",
              status: "scheduled",
              scheduled_for: scheduledFor.toISOString(),
              timestamp: new Date().toISOString()
            });
            if (error) throw error;
          }
          
          alert(`Scheduled ${bubbles.length} message(s) for ${scheduledFor.toLocaleString()}.`);
          document.getElementById("custSmsReplyText").value = "";
          updateCustSmsCharCount();
          hideCustSmsScheduleModal();
          
          await loadCustSmsThread(custCurrentPhone, document.getElementById("custSmsName")?.textContent);
        } catch (e) {
          console.error("Error scheduling customer SMS:", e);
          alert("Failed to schedule: " + e.message);
        }
      }

      // Update character count for Customers tab SMS
      function updateCustSmsCharCount() {
        const txt = document.getElementById("custSmsReplyText")?.value || "";
        const el = document.getElementById("custSmsCharCount");
        if (el) {
          el.textContent = `${txt.length} / 160`;
          el.style.color = txt.length > 160 ? "var(--warn)" : "var(--muted)";
        }
      }

      async function markMsgRead() {
        if (!msgCurrentPhone) return;
        
        try {
          const sb = ensureClient();
          
          // Normalize phone for flexible matching
          const digits = normalizePhone(msgCurrentPhone);
          const ilikePattern = `%${digits}%`;
          
          // First get the IDs of messages to update (using flexible matching)
          const { data: toUpdate } = await sb
            .from("messages")
            .select("id, phone_number")
            .ilike("phone_number", ilikePattern)
            .eq("direction", "inbound")
            .eq("status", "unread");
          
          // Filter to exact phone match and update each
          const idsToUpdate = (toUpdate || [])
            .filter(m => normalizePhone(m.phone_number) === digits)
            .map(m => m.id);
          
          if (idsToUpdate.length > 0) {
            const { error } = await sb
              .from("messages")
              .update({ status: "read" })
              .in("id", idsToUpdate);
            
            if (error) throw error;
          }
          
          await loadMsgThread(msgCurrentPhone);
          await loadMsgConversations();
          updateMsgStats();
        } catch (e) {
          console.error("Error marking read:", e);
        }
      }

      function updateMsgCharCount() {
        const txt = document.getElementById("msgReplyText")?.value || "";
        const el = document.getElementById("msgCharCount");
        if (el) {
          el.textContent = `${txt.length} / 160`;
          el.style.color = txt.length > 160 ? "var(--warn)" : "var(--muted)";
        }
      }

      function startMsgLive() {
        stopMsgLive();
        msgLiveTimer = setInterval(() => {
          loadMsgConversations();
          updateMsgStats();
          if (msgCurrentPhone) loadMsgThread(msgCurrentPhone);
        }, 15000);
      }

      function stopMsgLive() {
        if (msgLiveTimer) {
          clearInterval(msgLiveTimer);
          msgLiveTimer = null;
        }
      }

      // ========== ALL MESSAGES TAB FUNCTIONS ==========
      let allmsgsCurrentPhone = null;
      let allmsgsCustomerMap = new Map();

      async function loadAllMsgsTab() {
        const tbody = document.getElementById("allmsgsTableBody");
        tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding: 20px; text-align: center;">Loading...</td></tr>`;
        
        try {
          const sb = ensureClient();
          
          // Get last 50 messages - include all real message statuses (sent, read, unread, queued, delivered, failed)
          // Explicitly include only real message statuses to avoid campaign messages
          const { data: messages, error } = await sb
            .from("messages")
            .select("id, phone_number, content, direction, status, timestamp")
            .in("status", ["sent", "read", "unread", "queued", "delivered", "failed", "rejected"])
            .order("timestamp", { ascending: false })
            .limit(50);
          
          if (error) throw error;
          
          if (!messages || messages.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding: 20px; text-align: center;">No messages found</td></tr>`;
            return;
          }
          
          // Batch resolve customer names for all phones at once
          const phones = [...new Set(messages.map(m => m.phone_number))];
          await batchLookupCustomers(phones);
          
          allmsgsCustomerMap = new Map();
          phones.forEach(phone => {
            const digits = normalizePhone(phone);
            const cust = customerPhoneCache.get(digits);
            if (cust) {
              const name = cust.name || `${cust.first_name || ""} ${cust.last_name || ""}`.trim();
              allmsgsCustomerMap.set(phone, name || "Unknown");
              // Also map by normalized phone for flexible lookup
              allmsgsCustomerMap.set(digits, name || "Unknown");
            }
          });
          
          const currentNormalized = normalizePhone(allmsgsCurrentPhone);
          
          tbody.innerHTML = messages.map(m => {
            const time = new Date(m.timestamp).toLocaleString();
            const normalizedMsgPhone = normalizePhone(m.phone_number);
            const customerName = allmsgsCustomerMap.get(m.phone_number) || allmsgsCustomerMap.get(normalizedMsgPhone) || "Unknown";
            const dirClass = m.direction === "inbound" ? "color: #0ea5e9;" : "color: #22c55e;";
            const dirLabel = m.direction === "inbound" ? "IN" : "OUT";
            const statusColor = m.status === "unread" ? "color: var(--danger);" : 
                               m.status === "sent" ? "color: var(--success);" : 
                               m.status === "queued" ? "color: var(--warn);" : "";
            const decoded = decodeHexUCS2(m.content || "");
            const preview = decoded.slice(0, 100) + (decoded.length > 100 ? "..." : "");
            // Use normalized phone for active state check
            const isActive = normalizedMsgPhone === currentNormalized;
            
            return `
              <tr class="allmsgs-row ${isActive ? "active" : ""}" data-phone="${m.phone_number}" style="border-bottom: 1px solid var(--border); cursor: pointer; ${isActive ? "background: var(--accent); color: var(--bg);" : ""}">
                <td style="padding: 8px 10px; white-space: nowrap; font-size: 11px;">${time}</td>
                <td style="padding: 8px 10px; font-weight: 600;">${m.phone_number}</td>
                <td style="padding: 8px 10px; font-size: 11px; ${isActive ? "" : "color: var(--muted);"}">${customerName}</td>
                <td style="padding: 8px 10px; font-weight: 700; ${isActive ? "" : dirClass}">${dirLabel}</td>
                <td style="padding: 8px 10px; font-size: 11px; ${isActive ? "" : statusColor}">${(m.status || "").toUpperCase()}</td>
                <td style="padding: 8px 10px; font-size: 11px;">${preview}</td>
              </tr>
            `;
          }).join("");
          
          // Add click handlers to rows
          tbody.querySelectorAll(".allmsgs-row").forEach(row => {
            row.addEventListener("click", () => {
              const phone = row.dataset.phone;
              loadAllmsgsConversation(phone);
            });
          });
          
        } catch (e) {
          console.error("Error loading all messages:", e);
          tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding: 20px; text-align: center;">Error loading messages</td></tr>`;
        }
      }

      async function loadAllmsgsConversation(phone) {
        allmsgsCurrentPhone = phone;
        const normalizedPhone = normalizePhone(phone);
        
        // Update header - try both raw and normalized phone for customer lookup
        const customerName = allmsgsCustomerMap.get(phone) || allmsgsCustomerMap.get(normalizedPhone) || "Unknown";
        document.getElementById("allmsgsConvoHeader").textContent = 
          customerName !== "Unknown" ? `${customerName} (${phone})` : phone;
        
        // Highlight active row
        document.querySelectorAll(".allmsgs-row").forEach(row => {
          const isActive = row.dataset.phone === phone;
          row.classList.toggle("active", isActive);
          row.style.background = isActive ? "var(--accent)" : "";
          row.style.color = isActive ? "var(--bg)" : "";
        });
        
        const container = document.getElementById("allmsgsConvoContent");
        container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Loading...</div>`;
        
        try {
          const sb = ensureClient();
          
          // Normalize phone for flexible matching
          const digits = normalizePhone(phone);
          const ilikePattern = `%${digits}%`;
          
          // Get ALL messages for this phone using flexible matching
          // Include only real message statuses (not campaign messages)
          const { data: messages, error } = await sb
            .from("messages")
            .select("id, phone_number, content, direction, status, timestamp")
            .ilike("phone_number", ilikePattern)
            .in("status", ["sent", "read", "unread", "queued", "delivered", "failed", "rejected"])
            .order("timestamp", { ascending: true })
            .limit(500);
          
          if (error) throw error;
          
          // Filter to exact phone match (last 10 digits)
          const filtered = (messages || []).filter(m => 
            normalizePhone(m.phone_number) === digits
          );
          
          if (filtered.length === 0) {
            container.innerHTML = `<div class="muted" style="text-align: center; padding: 40px;">No messages</div>`;
            return;
          }
          
          container.innerHTML = filtered.map(m => {
            const isInbound = m.direction === "inbound";
            const bubbleClass = isInbound ? "inbound" : "outbound";
            const time = new Date(m.timestamp).toLocaleString();
            const status = m.status ? `<span class="bubble-status">${m.status.toUpperCase()}</span>` : "";
            const decoded = decodeHexUCS2(m.content || "");
            const content = decoded.replace(/\n/g, "<br>");
            
            return `
              <div class="msg-bubble ${bubbleClass}">
                <div>${content}</div>
                <div class="bubble-time">${time} ${status}</div>
              </div>
            `;
          }).join("");
          
          // Scroll to bottom
          container.scrollTop = container.scrollHeight;
        } catch (e) {
          console.error("Error loading conversation:", e);
          container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Error loading messages</div>`;
        }
      }

      async function sendAllmsgsReply() {
        if (!allmsgsCurrentPhone) {
          alert("Select a conversation first.");
          return;
        }
        
        const content = (document.getElementById("allmsgsReplyText")?.value || "").trim();
        if (!content) {
          alert("Please enter a message.");
          return;
        }
        
        try {
          const sb = ensureClient();
          const { error } = await sb.from("messages").insert({
            phone_number: allmsgsCurrentPhone,
            content: content,
            direction: "outbound",
            status: "queued",
            timestamp: new Date().toISOString()
          });
          
          if (error) throw error;
          
          alert("Message queued. Conductor will send shortly.");
          document.getElementById("allmsgsReplyText").value = "";
          
          // Reload conversation
          await loadAllmsgsConversation(allmsgsCurrentPhone);
          await loadAllMsgsTab();
        } catch (e) {
          console.error("Error sending reply:", e);
          alert("Failed to send: " + e.message);
        }
      }

      // ========== EVENT LISTENERS ==========
      document.querySelectorAll(".tab").forEach((t) => {
        t.addEventListener("click", () => switchTab(t.dataset.tab));
      });

      document.getElementById("refreshBtn").addEventListener("click", () => {
        if (activeTab === "customers") loadCustomers();
        else if (activeTab === "budtenders") loadBudtenders();
        else loadOverview();
      });

      // Customer search with debounce to avoid too many DB queries
      let searchTimeout = null;
      document
        .getElementById("customerSearch")
        .addEventListener("input", () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadCustomers();
          }, 500); // Wait 500ms after user stops typing
        });

      document
        .getElementById("customerFilter")
        .addEventListener("change", () => {
          loadCustomers();
        });

      document.getElementById("customerSort").addEventListener("change", () => {
        loadCustomers();
      });

      document
        .getElementById("budtenderSearch")
        .addEventListener("input", () => {
          renderBudtenderList(budtendersData);
        });

      document
        .getElementById("budtenderFilter")
        .addEventListener("change", () => {
          renderBudtenderList(budtendersData);
        });

      const budDispEl = document.getElementById(
        "budtenderDispensaryFilter"
      );
      if (budDispEl) {
        budDispEl.addEventListener("change", () => {
          renderBudtenderList(budtendersData);
        });
      }

      document
        .getElementById("budtenderSort")
        .addEventListener("change", () => {
          renderBudtenderList(budtendersData);
        });

      // Budtenders analytics navigation (kept for budtenders tab)
      document
        .querySelectorAll("#budtendersAnalyticsView .analytics-nav-item")
        .forEach((item) => {
          item.addEventListener("click", () => {
            currentBudAnalyticsSection = item.dataset.section || "performance";
            renderBudtenderAnalyticsSection(currentBudAnalyticsSection);
          });
        });

      // Toggle between Budtender Profile and Analytics
      function showBudtenderDetailPane(pane) {
        const profileEl = document.getElementById("budtenderProfileContent");
        const analyticsEl = document.getElementById("budtendersAnalyticsView");
        if (!profileEl || !analyticsEl) return;

        const isProfile = pane === "profile";
        profileEl.style.display = isProfile ? "" : "none";
        analyticsEl.style.display = isProfile ? "none" : "";

        const navItems = document.querySelectorAll(
          "#budtenderDetailNav .analytics-nav-item"
        );
        navItems.forEach((el) =>
          el.classList.toggle("active", el.dataset.bdetail === pane)
        );
      }

      document
        .querySelectorAll("#budtenderDetailNav .analytics-nav-item")
        .forEach((item) => {
          item.addEventListener("click", () => {
            const pane =
              item.dataset.bdetail === "analytics" ? "analytics" : "profile";
            showBudtenderDetailPane(pane);
          });
        });

      // Suggested Messages event listeners
      document.getElementById("sugStatusFilter")?.addEventListener("change", loadSuggestedMessages);
      document.getElementById("sugCampaignFilter")?.addEventListener("change", loadSuggestedMessages);
      document.getElementById("sugSearch")?.addEventListener("input", debounce(loadSuggestedMessages, 300));
      document.getElementById("sugBtnApprove")?.addEventListener("click", approveSugMessage);
      document.getElementById("sugBtnReject")?.addEventListener("click", rejectSugMessage);
      document.getElementById("sugBtnEdit")?.addEventListener("click", toggleSugEdit);
      document.getElementById("sugBtnSkip")?.addEventListener("click", selectNextSugMessage);

      // Scheduled tab event listeners
      document.getElementById("schedBtnScheduleAll")?.addEventListener("click", scheduleAllAprMessages);
      document.getElementById("schedBtnSendNow")?.addEventListener("click", sendSchedMessageNow);
      document.getElementById("schedBtnCancel")?.addEventListener("click", cancelSchedMessage);
      document.getElementById("schedDateFilter")?.addEventListener("change", loadScheduledList);
      document.getElementById("schedAutoQ")?.addEventListener("change", toggleAutoQ);
      
      // Initialize Auto-Q as enabled on page load
      setTimeout(() => {
        const autoQCheckbox = document.getElementById("schedAutoQ");
        if (autoQCheckbox && autoQCheckbox.checked) {
          toggleAutoQ(); // Start Auto-Q if checkbox is checked
        }
      }, 1000);
      
      // Update current time display every second
      setInterval(updateCurrentTimeDisplay, 1000);
      document.getElementById("schedBtnToday")?.addEventListener("click", () => {
        document.getElementById("schedDateFilter").value = new Date().toISOString().split("T")[0];
        loadScheduledList();
      });
      document.getElementById("schedBtnTomorrow")?.addEventListener("click", () => {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById("schedDateFilter").value = tomorrow.toISOString().split("T")[0];
        loadScheduledList();
      });

      // Messages tab event listeners
      document.getElementById("msgSendBtn")?.addEventListener("click", sendMsgReply);
      document.getElementById("msgMarkReadBtn")?.addEventListener("click", markMsgRead);
      document.getElementById("msgQueueBtn")?.addEventListener("click", queueMsgReply);
      document.getElementById("msgScheduleBtn")?.addEventListener("click", showMsgScheduleModal);
      document.getElementById("msgScheduleConfirmBtn")?.addEventListener("click", scheduleMsgReply);
      document.getElementById("msgScheduleCancelBtn")?.addEventListener("click", hideMsgScheduleModal);
      document.getElementById("msgRefreshBtn")?.addEventListener("click", () => {
        loadMsgConversations();
        updateMsgStats();
        if (msgCurrentPhone) loadMsgThread(msgCurrentPhone);
      });
      document.getElementById("msgReplyText")?.addEventListener("input", updateMsgCharCount);
      document.getElementById("msgSearchInput")?.addEventListener("input", () => renderMsgConversations());
      document.getElementById("msgLiveToggle")?.addEventListener("change", (e) => {
        if (e.target.checked) startMsgLive();
        else stopMsgLive();
      });
      
      // Customers tab SMS event listeners
      document.getElementById("custSmsSendBtn")?.addEventListener("click", sendCustSmsReply);
      document.getElementById("custSmsQueueBtn")?.addEventListener("click", queueCustSmsReply);
      document.getElementById("custSmsScheduleBtn")?.addEventListener("click", showCustSmsScheduleModal);
      document.getElementById("custSmsScheduleConfirmBtn")?.addEventListener("click", scheduleCustSmsReply);
      document.getElementById("custSmsScheduleCancelBtn")?.addEventListener("click", hideCustSmsScheduleModal);
      document.getElementById("custSmsReplyText")?.addEventListener("input", updateCustSmsCharCount);
      
      // Message filter buttons
      document.querySelectorAll(".msg-filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".msg-filter-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          msgFilterMode = btn.dataset.filter;
          renderMsgConversations();
        });
      });

      // All Messages tab event listeners
      document.getElementById("allmsgsRefreshBtn")?.addEventListener("click", loadAllMsgsTab);
      document.getElementById("allmsgsSendBtn")?.addEventListener("click", sendAllmsgsReply);

      function debounce(fn, ms) {
        let timeout;
        return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn(...args), ms); };
      }

      // ========== TEAM CHAT FUNCTIONS ==========
      let chatRealtime = null;
      let chatModalOpen = false;
      let lastChatMessageId = null;

      function openChatModal() {
          chatModalOpen = true;
          document.getElementById('chatModal').style.display = 'flex';
          loadChatHistory();
          subscribeToChat();
          
          // Clear pulse when opening
          const chatBtn = document.getElementById('chatBtn');
          if (chatBtn) {
              chatBtn.classList.remove('pulse-red');
          }
          
          // Populate identity dropdown if empty
          const select = document.getElementById('chatIdentity');
          if (select.options.length <= 1) {
              const priorityNames = [
                "Grace", "50", "Cherish", "Jimmy", "Leo", 
                "Jacob", "John", "Lizbeth", "Joaq", "Luis", 
                "Agustin", "Devon", "Stephen", "Aaron"
              ];
              priorityNames.forEach(name => {
                  const opt = document.createElement('option');
                  opt.value = name;
                  opt.textContent = name;
                  select.appendChild(opt);
              });
              
              // Load saved identity
              const savedId = localStorage.getItem('mota_chat_identity');
              if (savedId) select.value = savedId;
          }
      }

      function closeChatModal() {
          chatModalOpen = false;
          document.getElementById('chatModal').style.display = 'none';
          // Don't remove channel - keep listening for pulse notifications
      }

      async function loadChatHistory() {
          const container = document.getElementById('chatMessages');
          const { data, error } = await supabase
              .from('messages')
              .select('*')
              .eq('status', 'chat')
              .order('timestamp', { ascending: true })
              .limit(50);

          if (error) {
              console.error("Chat error:", error);
              container.innerHTML = `<div class="error" style="color: #ef4444; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
              return;
          }

          container.innerHTML = '';
          data.forEach(msg => appendChatMessage(msg));
          
          if (data.length > 0) {
              lastChatMessageId = data[data.length - 1].id;
          }
          
          container.scrollTop = container.scrollHeight;
      }

      function appendChatMessage(msg) {
          const container = document.getElementById('chatMessages');
          const sender = msg.payload?.sender || 'Unknown';
          const time = new Date(msg.timestamp || new Date()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const isProductFeedback = msg.payload?.product_feedback || false;
          
          const msgDiv = document.createElement('div');
          msgDiv.style.marginBottom = '8px';
          msgDiv.style.position = 'relative';
          msgDiv.dataset.messageId = msg.id;
          msgDiv.innerHTML = `
              <div style="font-size: 10px; color: var(--accent); font-weight: 700; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center;">
                  <span>${sender} <span style="color: var(--text-secondary); font-weight: 400;">${time}</span> ${isProductFeedback ? '<span style="color: #f59e0b; font-size: 9px;">ðŸ“ Product Feedback</span>' : ''}</span>
                  <button onclick="deleteChatMessage('${msg.id}')" class="chat-delete-btn" style="display: none; background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 2px 6px; opacity: 0.6; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'" title="Delete message">ðŸ—‘ï¸</button>
              </div>
              <div style="background: #2d3748; padding: 8px 12px; border-radius: 8px; font-size: 13px; line-height: 1.4; color: #e2e8f0;">
                  ${msg.content}
              </div>
          `;
          
          msgDiv.addEventListener('mouseenter', () => {
              const btn = msgDiv.querySelector('.chat-delete-btn');
              if (btn) btn.style.display = 'block';
          });
          msgDiv.addEventListener('mouseleave', () => {
              const btn = msgDiv.querySelector('.chat-delete-btn');
              if (btn) btn.style.display = 'none';
          });
          
          container.appendChild(msgDiv);
          container.scrollTop = container.scrollHeight;
      }
      
      async function deleteChatMessage(messageId) {
          if (!confirm("Delete this message?")) return;
          
          const { error } = await supabase
              .from('messages')
              .delete()
              .eq('id', messageId);
              
          if (error) {
              alert("Failed to delete: " + error.message);
              return;
          }
          
          const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
          if (msgDiv) msgDiv.remove();
      }

      async function sendChatMessage() {
          const input = document.getElementById('chatInput');
          const select = document.getElementById('chatIdentity');
          const productFeedbackCheck = document.getElementById('productFeedbackCheck');
          const content = input.value.trim();
          const sender = select.value;
          const isProductFeedback = productFeedbackCheck ? productFeedbackCheck.checked : false;

          if (!content) return;
          if (!sender) {
              alert("Please select who you are!");
              return;
          }

          localStorage.setItem('mota_chat_identity', sender);

          input.value = '';
          if (productFeedbackCheck) productFeedbackCheck.checked = false;
          
          const { error } = await supabase.from('messages').insert({
              phone_number: 'TEAM',
              direction: 'internal',
              status: 'chat',
              content: content,
              payload: { 
                  sender: sender,
                  product_feedback: isProductFeedback
              }
          });
          
          if (error) {
              alert("Failed to send message: " + error.message);
          }
      }

      function subscribeToChat() {
          if (chatRealtime) return;
          
          chatRealtime = supabase.channel('team-chat')
              .on(
                  'postgres_changes',
                  { event: 'INSERT', schema: 'public', table: 'messages', filter: 'status=eq.chat' },
                  (payload) => {
                      if (chatModalOpen) {
                          appendChatMessage(payload.new);
                          lastChatMessageId = payload.new.id;
                      } else {
                          const chatBtn = document.getElementById('chatBtn');
                          if (chatBtn) {
                              chatBtn.classList.add('pulse-red');
                          }
                      }
                  }
              )
              .subscribe();
      }

      // ========== INITIALIZE ==========
      (function init() {
        initResizablePanels();
        loadColumnWidths();
        switchTab("messages"); // Default to Messages tab as requested
        showBudtenderDetailPane("profile");
        // Subscribe to chat on page load
        subscribeToChat();
      })();
    </script>

    <!-- Team Chat Modal -->
    <div id="chatModal" style="display: none; position: fixed; top: 0; right: 0; bottom: 0; width: 400px; background: #141829; z-index: 2000; border-left: 1px solid #1f2937; box-shadow: -5px 0 25px rgba(0,0,0,0.5); flex-direction: column;">
      <div style="padding: 15px; background: #1a202c; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; color: #10b981;">ðŸ’¬ Team Chat</h3>
        <button onclick="closeChatModal()" style="background: transparent; border: none; color: #9ca3af; font-size: 18px; cursor: pointer;">&times;</button>
      </div>
      
      <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;">
        <div style="text-align: center; color: #6b7280;">Loading history...</div>
      </div>

      <div style="padding: 15px; background: #1a202c; border-top: 1px solid #1f2937;">
        <div style="margin-bottom: 10px;">
          <select id="chatIdentity" style="width: 100%; padding: 8px; background: #0a0e27; border: 1px solid #1f2937; color: #e8eaed; border-radius: 4px; font-size: 12px;">
            <option value="">Select Identity...</option>
          </select>
        </div>
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <input type="checkbox" id="productFeedbackCheck" style="margin: 0; cursor: pointer;">
          <label for="productFeedbackCheck" style="color: #9ca3af; font-size: 12px; cursor: pointer; margin: 0;">Product Feedback</label>
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="chatInput" placeholder="Type a message..." style="flex: 1; padding: 8px; background: #0a0e27; border: 1px solid #1f2937; color: #e8eaed; border-radius: 4px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
          <button onclick="sendChatMessage()" class="btn small" style="background: #10b981; color: #000; font-weight: 600;">Send</button>
        </div>
      </div>
    </div>
  </body>
</html>
