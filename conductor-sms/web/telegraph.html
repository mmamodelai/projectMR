<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MotaMSG</title>
  <meta name="theme-color" content="#0f172a">
  <!-- Inline emoji SVG favicon -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0%' stop-color='%231c2541'/>
              <stop offset='100%' stop-color='%230b1220'/>
            </linearGradient>
          </defs>
          <rect width='100' height='100' rx='18' ry='18' fill='url(%23g)'/>
          <text x='50' y='68' font-size='64' text-anchor='middle'>üì®</text>
        </svg>">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --blue: #3b82f6;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    .container { display: flex; flex-direction: column; height: 100%; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; background: #0b1220; border-bottom: 1px solid #1f2937;
    }
    header h1 { margin: 0; font-size: 16px; font-weight: 700; }
    .kbd { background:#111827; border:1px solid #1f2937; border-radius:4px; padding:2px 6px; color:var(--muted); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .btn {
      background:#1f2937; color:var(--text); border:1px solid #293241;
      padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn.primary { background: var(--blue); border-color: #2563eb; }
    .btn.accent { background: var(--accent); border-color: #16a34a; color:#0b1220; }
    .btn.danger { background: var(--danger); border-color: #b91c1c; }
    .btn.small { padding:6px 8px; font-size: 12px; }
    .switch { display:flex; align-items:center; gap:8px; color:var(--muted); }
    .chip { background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:4px 10px; color:var(--muted); font-size:12px; }
    .tabs { display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid #1f2937; background:#0b1220; }
    .tab { padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--muted); user-select:none; }
    .tab.active { background:#1f2937; color:var(--text); border:1px solid #293241; }
    main { display:flex; gap:10px; padding:10px; height:100%; box-sizing: border-box; }
    .panel { background: var(--panel); border: 1px solid #1f2937; border-radius: 10px; padding:10px; box-sizing: border-box; }
    .left { width: 768px; min-width: 768px; display:flex; flex-direction: column; flex: 0 0 768px; }
    .center { flex: 1 1 auto; display:flex; flex-direction: column; min-height: 0; }
    .right { width: var(--right-width, 32%); min-width: 380px; display:flex; flex-direction:column; flex: 0 0 var(--right-width, 32%); }
    .right.narrow { --right-width: 28%; min-width: 320px; }
    .right.wide { --right-width: 46%; min-width: 420px; }
    .title { font-weight:700; font-size:13px; color:#cbd5e1; margin-bottom:8px; }
    .list { overflow:auto; flex:1; border:1px solid #1f2937; border-radius:8px; }
    .terminal { background:#0b1220; border:1px solid #293241; border-radius:8px; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding:8px 10px; border-bottom:1px solid #1f2937; vertical-align: top; }
    th { position: sticky; top:0; background:#0b1220; color:#cbd5e1; text-align:left; }
    tr:hover td { background:#0f172a; }
    tr.clickable { cursor: pointer; }
    .nowrap { white-space: nowrap; }
    .msg { white-space: normal; line-height: 1.25; word-break: break-word; }
    .muted { color: var(--muted); }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; }
    .pill.inbound { background:#0ea5e9; color:#081018; }
    .pill.outbound { background:#a78bfa; color:#0b1220; }
    .pill.queued { background:#f59e0b; color:#0b1220; }
    .pill.sent { background:#22c55e; color:#081018; }
    .pill.read { background:#64748b; color:#0b1220; }
    .pill.unread { background:#ef4444; color:#081018; }
    .hl { color:#22c55e; font-weight:700; }
    .hstack { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .vstack { display:flex; flex-direction:column; gap:8px; }
    textarea { width:100%; min-height:110px; background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:8px; padding:10px; box-sizing:border-box; resize: vertical; }
    input[type="text"], input[type="password"], input[type="search"] {
      background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:8px; padding:8px 10px;
    }
    .split { display:flex; gap:10px; }
    .split > div { flex:1; }
    .footer { display:flex; justify-content: space-between; align-items:center; padding:8px 0 0; color:var(--muted); font-size:12px; }
    .badge { padding:2px 6px; border-radius:6px; background:#0b1220; border:1px solid #1f2937; }
    .warn { color: var(--warn); }
    .cnt { text-align:center; width: 56px; }
    /* Ensure the thread area can scroll without pushing reply off-screen */
    .threadWrap { flex: 1 1 auto; min-height: 0; }
    .title.with-toggle { display:flex; align-items:center; justify-content: space-between; gap:8px; }
    .toggleBtn {
      background:#0b1220; border:1px solid #1f2937; color:var(--muted);
      border-radius:6px; padding:2px 6px; font-size:12px; cursor:pointer;
    }
    .toggleBtn:hover { filter: brightness(1.08); }
    /* Horizontal collapse for the entire right panel */
    .right.collapsed {
      width: 0 !important;
      min-width: 0 !important;
      flex: 0 0 0 !important;
      padding: 0 !important;
      border: none !important;
    }
    .right.collapsed * { display: none !important; }
  </style>
  <!-- Embedded Supabase credentials (portable, no prompts) -->
  <script>
    const SUPABASE_URL = "https://kiwmwoqrguyrcpjytgte.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0";
    // Optional: IC database (leave blank to skip)
    const SUPABASE_URL_IC = "";
    const SUPABASE_ANON_KEY_IC = "";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- React (for modern card UI) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>MotaMSG <span class="chip">Portable</span></h1>
      <div class="row">
        <span class="chip" id="lastRefresh">Last: ‚Äî</span>
        <label class="switch">
          <input type="checkbox" id="liveToggle">
          <span>Live Mode (15s refresh)</span>
        </label>
        <button class="btn small" id="refreshBtn">Refresh</button>
        <button class="btn small" id="toggleRightBtn" title="Hide/Show right panel">Hide Right Panel</button>
        <button class="btn small" id="rightSizeBtn" title="Toggle right panel width">Right: Default</button>
      </div>
    </header>
    <div class="tabs">
      <div class="tab active" data-tab="reply">‚úâÔ∏è Reply to Messages</div>
      <div class="tab" data-tab="all">üìã All Messages</div>
    </div>
    <main>
      <!-- Left: conversations list -->
      <section class="panel left" id="leftPanel">
        <div class="title">All Messages</div>
        <div class="hstack" style="margin-bottom:8px;">
          <input id="searchInput" type="search" placeholder="Search phone or text..." style="flex:1;">
          <button class="btn small" id="clearSearch">Clear</button>
        </div>
        <div class="hstack" style="margin-bottom:8px;">
          <span class="muted">Quick filters:</span>
          <button class="btn small" id="fltAll">All</button>
          <button class="btn small" id="fltHasIn">Has IN</button>
          <button class="btn small" id="fltUnread">Has Unread</button>
          <label class="switch"><input type="checkbox" id="hideSingleOut"><span>Hide single OUT</span></label>
        </div>
        <div class="list">
          <table id="convTable">
          <thead><tr><th>Contact</th><th class="nowrap">Cnt</th><th class="nowrap">Disp</th><th class="nowrap">Last</th><th>Preview</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer">
          <span id="convCount" class="muted">0 conversations</span>
          <div class="hstack">
            <button class="btn small" id="markReadBtn">Mark Read</button>
            <button class="btn small" id="reloadConvsBtn">Reload</button>
          </div>
        </div>
      </section>
      <!-- Center: conversation + reply OR all messages -->
      <section class="panel center">
        <div id="replyTab">
          <div class="title" id="convHeader">Conversation</div>
          <div class="list threadWrap">
            <table id="threadTable">
              <thead><tr><th class="nowrap">Time</th><th class="nowrap">Dir</th><th>Status</th><th>Message</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="title" id="replyHeader" style="margin-top:10px;">Your Reply</div>
          <div class="vstack">
            <div class="split">
              <div><label class="muted">To (E.164):</label><input type="text" id="replyPhone" placeholder="+16199773020" style="width:100%;"></div>
              <div class="vstack" style="max-width:260px;">
                <label class="muted">Options</label>
                <div class="hstack">
                  <span class="badge">[BUBBLE] split</span>
                  <span class="badge">Queued ‚Üí Conductor sends</span>
                </div>
              </div>
            </div>
            <textarea id="replyText" placeholder="Type your message... Use [BUBBLE] to split into multiple SMS."></textarea>
            <div class="hstack" style="justify-content: space-between;">
              <span id="charCount" class="muted">0 / 160</span>
              <div class="hstack">
                <button class="btn" id="clearReply">Clear</button>
                <button class="btn accent" id="sendNow">SEND IMMEDIATELY</button>
              </div>
            </div>
          </div>
        </div>
        <div id="allTab" style="display:none;">
          <div class="title">All Messages (latest 1000)</div>
          <div class="list" style="height: calc(100% - 28px);">
            <table id="allTable">
              <thead>
              <tr>
                <th class="nowrap">Time</th>
                <th>Phone</th>
                <th class="nowrap">Dir</th>
                <th class="nowrap">Status</th>
                <th>Content</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
      <!-- Right: Baseball Card / Analytics -->
      <section class="panel right">
        <div class="title with-toggle" id="cardHeader">‚öæ Baseball Card <button id="cardToggle" class="toggleBtn" title="Collapse/Expand">‚ñº</button></div>
        <div id="cardBox" class="list terminal" style="flex:1 1 55%; min-height:0; margin-bottom:10px;">
          <div id="cardReactRoot" style="padding:10px;"></div>
          <pre id="cardText" style="display:none; margin:0; padding:10px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; color: var(--text);"></pre>
        </div>
        <div class="title with-toggle" id="analyticsHeader">üìà Visit Analytics <button id="analyticsToggle" class="toggleBtn" title="Collapse/Expand">‚ñº</button></div>
        <div id="analyticsBox" class="list terminal" style="flex:1 1 45%; min-height:0;">
          <pre id="analyticsText" style="margin:0; padding:10px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; color: var(--text);"></pre>
        </div>
      </section>
    </main>
  </div>

  <!-- No config dialog needed when credentials are embedded -->

  <script>
    let supabaseClient = null;
    let activeTab = 'reply';
    let liveTimer = null;
    let conversations = [];   // reduced conversation list
    let inboundSet = new Set();
    let unreadSet = new Set();
    let filterMode = 'all';   // 'all' | 'hasIn' | 'hasUnread'
    let currentPhone = null;
    const contactCache = new Map(); // phone -> {kind, first_name, last_name, dispensary}
    let hideSingleOut = true;
    // audio / inbound notification state
    let audioCtx = null;
    let inboundInit = false;
    let lastInboundSeenTs = 0; // epoch ms of most recent inbound observed

    function ensureClient() {
      if (!supabaseClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false }});
      }
      return supabaseClient;
    }
    let supabaseClientIC = null;
    function ensureClientIC() {
      if (!SUPABASE_URL_IC || !SUPABASE_ANON_KEY_IC) return null;
      if (!supabaseClientIC) {
        supabaseClientIC = window.supabase.createClient(SUPABASE_URL_IC, SUPABASE_ANON_KEY_IC, { auth: { persistSession: false }});
      }
      return supabaseClientIC;
    }

    // Utilities
    function fmtTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch { return iso || ''; }
    }
    // Decode UCS2/UTF-16BE hex payloads to readable text
    function decodeHexUCS2(s) {
      if (!s || typeof s !== 'string') return s;
      const compact = s.replace(/\s+/g, '');
      if (!/^[0-9a-fA-F]+$/.test(compact)) return s;
      if (compact.length % 4 !== 0 || compact.length < 16) return s;
      try {
        const bytes = new Uint8Array(compact.length / 2);
        for (let i = 0; i < compact.length; i += 2) {
          bytes[i/2] = parseInt(compact.slice(i, i+2), 16);
        }
        // UTF-16BE decode
        let out = '';
        for (let i = 0; i < bytes.length; i += 2) {
          const code = (bytes[i] << 8) | bytes[i+1];
          out += String.fromCharCode(code);
        }
        // If mostly printable, accept
        const printable = out.replace(/[\x20-\x7E]/g, '').length;
        if (printable <= out.length * 0.6) return out;
        return s;
      } catch { return s; }
    }
    function normalizePhone(phone) {
      if (!phone) return phone;
      const digits = (''+phone).replace(/\D+/g,'');
      if (digits.length === 11 && digits.startsWith('1')) return '+' + digits;
      if (digits.length === 10) return '+1' + digits;
      if ((''+phone).startsWith('+')) return phone;
      return phone;
    }
    function last10(phone) {
      return (''+phone).replace(/\D+/g,'').slice(-10);
    }
    // Staff (budtenders) local resolver
    const staffMap = new Map(); // key: staff id or employee_id ‚Üí name
    const STAFF_STATIC = {
      // Optional manual overrides, e.g. "abc123":"Devon Calonzo"
    };
    function getSellerName(sellerId) {
      if (!sellerId) return '';
      const k = String(sellerId);
      return staffMap.get(k) || STAFF_STATIC[k] || '';
    }
    async function loadStaffMap() {
      try {
        const sb = ensureClient();
        // Try primary staff table
        let r = await sb.from('staff').select('id,name,employee_id').limit(1000);
        if (r.data && r.data.length) {
          r.data.forEach(row => {
            if (row.id) staffMap.set(String(row.id), row.name || '');
            if (row.employee_id) staffMap.set(String(row.employee_id), row.name || '');
          });
        } else {
          // Fallback: if a budtenders table exists with IDs
          try {
            let rb = await sb.from('budtenders').select('id,first_name,last_name,employee_id').limit(2000);
            if (rb.data) {
              rb.data.forEach(row => {
                const full = `${row.first_name || ''} ${row.last_name || ''}`.trim();
                if (row.id) staffMap.set(String(row.id), full);
                if (row.employee_id) staffMap.set(String(row.employee_id), full);
              });
            }
          } catch {}
        }
      } catch {}
      // Apply static overrides/locals
      Object.entries(STAFF_STATIC).forEach(([k,v]) => staffMap.set(String(k), v));
    }
    function setLastRefresh() {
      const el = document.getElementById('lastRefresh');
      el.textContent = 'Last: ' + new Date().toLocaleTimeString();
    }
    function contactLabel(phone) {
      const c = contactCache.get(phone) || {};
      const kind = c && c.kind ? `‚Ä¢ ${c.kind}` : '';
      const name = (c && (c.first_name || c.last_name)) ? `${c.first_name || ''} ${c.last_name || ''}`.trim() : '';
      const disp = (c && c.dispensary) ? `‚Ä¢ ${c.dispensary}` : '';
      const pieces = [name, kind, disp].filter(Boolean);
      return pieces.length ? pieces.join(' ') : '';
    }
    function updateConversationHeader() {
      const hdr = document.getElementById('convHeader');
      const rph = document.getElementById('replyHeader');
      if (!currentPhone) {
        hdr.textContent = 'Conversation';
        rph.textContent = 'Your Reply';
        return;
      }
      const label = contactLabel(currentPhone);
      hdr.textContent = label ? `Conversation ‚Äî ${label}` : 'Conversation';
      rph.textContent = label ? `Your Reply ‚Äî ${label}` : 'Your Reply';
    }

    // --- Baseball card helpers ---
    async function findCustomerByPhone(phone) {
      const sb = ensureClient();
      const digits = last10(phone);
      try {
        const r = await sb.from('customers_blaze')
          .select('*')
          .or(`phone.ilike.%${digits}%,phone_number.ilike.%${digits}%`)
          .limit(1);
        if (r.data && r.data.length) return r.data[0];
      } catch {}
      // Also try primary CRM table `customers` in this project
      try {
        const rC = await sb.from('customers')
          .select('*')
          .ilike('phone', `%${digits}%`)
          .limit(1);
        if (rC.data && rC.data.length) return rC.data[0];
      } catch {}
      // Wildcard tolerant lookup e.g., matches (619) 368-3370
      try {
        const likePat = `%${digits.split('').join('%')}%`;
        const r2 = await sb.from('customers_blaze')
          .select('*')
          .or(`phone.ilike.${likePat},phone_number.ilike.${likePat}`)
          .limit(1);
        if (r2.data && r2.data.length) return r2.data[0];
      } catch {}
      // Wildcard tolerant on `customers` table as well
      try {
        const likePatC = `%${digits.split('').join('%')}%`;
        const r2C = await sb.from('customers')
          .select('*')
          .ilike('phone', likePatC)
          .limit(1);
        if (r2C.data && r2C.data.length) return r2C.data[0];
      } catch {}
      // Optional IC database
      try {
        const sbIC = ensureClientIC();
        if (sbIC) {
          const rIC = await sbIC.from('customers_blaze')
            .select('*')
            .or(`phone.ilike.%${digits}%,phone_number.ilike.%${digits}%`)
            .limit(1);
          if (rIC.data && rIC.data.length) return rIC.data[0];
          const likePatIC = `%${digits.split('').join('%')}%`;
          const rIC2 = await sbIC.from('customers_blaze')
            .select('*')
            .or(`phone.ilike.${likePatIC},phone_number.ilike.${likePatIC}`)
            .limit(1);
          if (rIC2.data && rIC2.data.length) return rIC2.data[0];
          try {
            const rIC3 = await sbIC.from('customers')
              .select('*')
              .or(`phone.ilike.%${digits}%,phone_number.ilike.%${digits}%`)
              .limit(1);
            if (rIC3.data && rIC3.data.length) return rIC3.data[0];
          } catch {}
        }
      } catch {}
      return null;
    }
    async function fetchTransactionsByCustomerId(customerId) {
      const sb = ensureClient();
      const tables = ['transactions_blaze','transactions'];
      for (const t of tables) {
        try {
          // Try ordering by date, fallback to created_at if needed
          let r = await sb.from(t).select('*').eq('customer_id', customerId).order('date', { ascending:false }).limit(100);
          if (!r.data || r.data.length === 0) {
            r = await sb.from(t).select('*').eq('customer_id', customerId).order('created_at', { ascending:false }).limit(100);
          }
          if (r.data) return { table: t, rows: r.data };
        } catch {}
      }
      return { table: null, rows: [] };
    }
    async function fetchICTransactionsByCustomerId(customerId) {
      const sbIC = ensureClientIC();
      if (!sbIC) return { table: null, rows: [] };
      const tables = ['transactions_blaze','transactions'];
      for (const t of tables) {
        try {
          const r = await sbIC.from(t).select('*').eq('customer_id', customerId).order('date', { ascending:false }).limit(1000);
          if (r.data) return { table: t, rows: r.data };
        } catch {}
      }
      return { table: null, rows: [] };
    }
    async function fetchICItemsByTransactionIds(txIds) {
      const sbIC = ensureClientIC();
      if (!sbIC || !txIds || !txIds.length) return [];
      const tables = ['transaction_items_blaze','transaction_items'];
      for (const t of tables) {
        try {
          const r = await sbIC.from(t).select('*').in('transaction_id', txIds).limit(10000);
          if (r.data) return r.data;
        } catch {}
      }
      return [];
    }
    async function fetchItemsByTransactionIds(txIds) {
      const sb = ensureClient();
      if (!txIds || !txIds.length) return [];
      const tables = ['transaction_items_blaze','transaction_items'];
      for (const t of tables) {
        try {
          const r = await sb.from(t).select('*').in('transaction_id', txIds).limit(10000);
          if (r.data) return r.data;
        } catch {}
      }
      return [];
    }
    function monthKey(d) {
      const dt = new Date(d);
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    }
    function computeMonthlyCounts(txs, lastN=12) {
      const monthsMap = new Map();
      (txs || []).forEach(t => {
        const src = t.date || t.created_at;
        if (!src) return;
        const k = monthKey(src);
        monthsMap.set(k, (monthsMap.get(k) || 0) + 1);
      });
      const keys = Array.from(monthsMap.keys()).sort().slice(-lastN);
      const max = Math.max(1, ...keys.map(k => monthsMap.get(k) || 0));
      return keys.map(k => ({ key: k, count: monthsMap.get(k) || 0, pct: (monthsMap.get(k)||0)/max }));
    }
    function calculateAge(dob) {
      if (!dob) return null;
      try {
        const d = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - d.getFullYear();
        const m = today.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
        return age;
      } catch { return null; }
    }
    function ageGroup(age) {
      if (age == null) return 'Unknown';
      if (age < 21) return 'Under 21';
      if (age <= 25) return '21-25';
      if (age <= 30) return '26-30';
      if (age <= 35) return '31-35';
      if (age <= 45) return '36-45';
      if (age <= 55) return '46-55';
      return '55+';
    }
    function fmtMoney(n) { return (typeof n === 'number' && !isNaN(n)) ? `$${n.toFixed(2)}` : '‚Äî'; }
    function buildVisitAnalyticsText(cust, txs, items) {
      if (!txs || !txs.length) {
        return 'No transactions found.';
      }
      const dates = txs.map(t => t.date).filter(Boolean).map(d => new Date(d)).sort((a,b)=>a-b);
      const first = dates[0];
      const last = dates[dates.length-1];
      const daysActive = first && last ? Math.max(1, Math.floor((last - first) / 86400000)) : 0;
      const totalVisits = txs.length;
      const monthsMap = new Map();
      dates.forEach(d => {
        const k = monthKey(d);
        monthsMap.set(k, (monthsMap.get(k) || 0) + 1);
      });
      const activeMonths = monthsMap.size || 1;
      const avgPerActiveMonth = (totalVisits / activeMonths).toFixed(1);

      // Budtender breakdown
      const byBt = new Map();
      txs.forEach(t => {
        const btName = getSellerName(t.seller_id) || t.seller_name || t.budtender || t.seller || 'Unknown';
        const key = (btName + '') || 'Unknown';
        const arr = byBt.get(key) || [];
        arr.push(t);
        byBt.set(key, arr);
      });

      // Items linkage by transaction id
      const itemsByTx = new Map();
      (items || []).forEach(it => {
        const tid = it.transaction_id || it.tx_id || it.transactionId;
        if (!tid) return;
        const arr = itemsByTx.get(tid) || [];
        arr.push(it);
        itemsByTx.set(tid, arr);
      });

      // Compute per-transaction item counts and MOTA%
      function txItemCount(tid) {
        const arr = itemsByTx.get(tid) || [];
        if (!arr.length) return 0;
        return arr.reduce((a,b)=> a + Number(b.quantity || b.qty || 1), 0);
      }
      function txIsMota(tid) {
        const arr = itemsByTx.get(tid) || [];
        if (!arr.length) return false;
        return arr.some(x => {
          const pn = (x.product_name || x.product || '').toLowerCase();
          const brand = (x.brand || '').toLowerCase();
          return pn.includes('mota') || brand.includes('mota');
        });
      }
      const avgItemsPerTx = (txs.reduce((a,t)=> a + txItemCount(t.id || t.transaction_id), 0) / totalVisits) || 0;
      const motaCount = txs.reduce((a,t)=> a + (txIsMota(t.id || t.transaction_id) ? 1 : 0), 0);
      const motaPct = totalVisits ? Math.round((motaCount/totalVisits) * 100) : 0;

      // Top brands by spend and spending by category; top purchased items
      const brandSpend = new Map();
      const itemSpend = new Map(); // key product_name -> total spend
      const categoryKeywords = {
        'Flower': ['flower', 'bud', 'nug', 'pre-roll', 'pre roll', 'prepack'],
        'Edibles': ['gummy', 'chocolate', 'cookie', 'brownie', 'candy', 'chew'],
        'Concentrates': ['wax', 'shatter', 'crumble', 'hash', 'live resin', 'rosin'],
        'Vapes': ['vape', 'cartridge', 'cart', 'disposable', 'pod'],
        'Topicals': ['cream', 'lotion', 'salve', 'balm', 'ointment'],
        'Tinctures': ['tincture', 'drop', 'sublingual']
      };
      const categorySpend = Object.fromEntries(Object.keys(categoryKeywords).map(k => [k, 0]));
      (items || []).forEach(it => {
        const price = Number(it.total_price ?? it.price ?? 0) || 0;
        const brand = (it.brand || '').trim() || 'Unknown';
        const name = (it.product_name || it.product || 'Unknown').trim();
        brandSpend.set(brand, (brandSpend.get(brand) || 0) + price);
        itemSpend.set(name, (itemSpend.get(name) || 0) + price);
        const lower = (it.category || it.product_name || '').toString().toLowerCase();
        for (const [cat, kws] of Object.entries(categoryKeywords)) {
          if (kws.some(kw => lower.includes(kw))) {
            categorySpend[cat] += price;
            break;
          }
        }
      });
      const topBrands = Array.from(brandSpend.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3)
        .map(([b,val]) => `${b}  $${val.toFixed(2)}`).join('\\n');
      const topItems = Array.from(itemSpend.entries()).sort((a,b)=>b[1]-a[1]).slice(0,7)
        .map(([n,val]) => `   $${val.toFixed(2)} ‚Ä¢ ${n}`).join('\\n');
      const catLines = Object.entries(categorySpend)
        .sort((a,b)=>b[1]-a[1])
        .map(([c,val]) => `${c.padEnd(12,' ')} $${val.toFixed(2)}`)
        .join('\\n');

      // Monthly histogram (last 12 months)
      const monthsSorted = Array.from(monthsMap.keys()).sort().slice(-12);
      const monthLines = monthsSorted.map(k => {
        const cnt = monthsMap.get(k);
        const bars = '‚ñà'.repeat(Math.min(12, Math.round((cnt / Math.max(...Array.from(monthsMap.values()))) * 12 || 0)));
        return `${k} | ${String(cnt).padStart(2,' ')} ${bars}`;
      }).join('\\n');

      // Budtender lines
      const btLines = Array.from(byBt.entries())
        .sort((a,b)=> b[1].length - a[1].length)
        .slice(0, 10)
        .map(([k,arr]) => `${(k || 'Unknown').toString().slice(0,24).padEnd(24,' ')}  ${String(arr.length).padStart(3,' ')} / ${String(totalVisits).padEnd(3,' ')}  ${(Math.round(arr.length/totalVisits*100)+'%').padStart(4,' ')}`)
        .join('\\n');

      return [
`OVERVIEW
Total Visits : ${totalVisits}
Days Active  : ${daysActive}
Avg Visits/M : ${avgPerActiveMonth}
First Visit  : ${first ? first.toISOString().slice(0,10) : '‚Äî'}
Last Visit   : ${last ? last.toISOString().slice(0,10) : '‚Äî'}
`,
`MONTHLY (last 12)
${monthLines || '‚Äî'}
`,
`BUDTENDER BREAKDOWN (top 10)
Budtender                Visits / Total  %
${btLines || '‚Äî'}
`,
`SPENDING BY CATEGORY
${catLines || '‚Äî'}
`,
`TOP BRANDS (by spend)
${topBrands || '‚Äî'}
`,
`ITEMS SUMMARY
Avg Items/Tx : ${avgItemsPerTx.toFixed(1)}
MOTA % Tx    : ${motaPct}%
Top Purchases:
${topItems || '‚Äî'}
`
      ].join('\\n');
    }
    async function loadBaseballCardByPhone(phone) {
      const el = document.getElementById('cardText');
      const hdr = document.getElementById('cardHeader');
      const anl = document.getElementById('analyticsText');
      const anlh = document.getElementById('analyticsHeader');
      const reactRootEl = document.getElementById('cardReactRoot');
      if (!el || !reactRootEl) return;
      reactRootEl.innerHTML = '<div style="color: var(--muted);">Loading‚Ä¶</div>';
      if (anl) anl.textContent = 'Loading‚Ä¶';
      const sb = ensureClient();
      const identity = await resolveContact(sb, phone);
      const name = (identity.first_name || identity.last_name) ? `${identity.first_name || ''} ${identity.last_name || ''}`.trim() : 'Unknown';
      const role = identity.kind || 'NONE';
      const disp = identity.dispensary || '‚Äî';
      hdr.textContent = '‚öæ Baseball Card';

      const cust = await findCustomerByPhone(phone);
      let header =
`Contact     : ${name}  (${role}${disp ? ' ‚Ä¢ ' + disp : ''})
Phone       : ${phone}
${cust ? `Member ID   : ${cust.member_id ?? cust.customer_id ?? cust.id ?? ''}` : 'Customer    : not found'}
`;
      let metricsBlock = '';
      let visitsBlock = '';

      if (cust && (cust.member_id || cust.customer_id || cust.id)) {
        const cid = cust.member_id ?? cust.customer_id ?? cust.id;
        const preferIC = !!ensureClientIC();
        const { rows: txs } = preferIC ? await fetchICTransactionsByCustomerId(cid) : await fetchTransactionsByCustomerId(cid);
        if (txs && txs.length) {
          const totalVisits = txs.length;
          const totals = txs.map(t => Number(t.total_amount ?? t.total ?? t.subtotal ?? 0)).filter(n => !isNaN(n));
          const totalRevenue = totals.reduce((a,b)=>a+b,0);
          const avgTicket = totalVisits ? (totalRevenue/totalVisits) : 0;
          const lastDate = txs[0]?.date ? new Date(txs[0].date) : (txs[0]?.created_at ? new Date(txs[0].created_at) : null);
          const daysSince = lastDate ? Math.floor((Date.now() - lastDate.getTime())/86400000) : '‚Äî';
          metricsBlock = `${totalVisits}|${totalRevenue.toFixed(2)}|${avgTicket.toFixed(2)}|${lastDate ? (lastDate.toLocaleString() + ' (' + daysSince + 'd ago)') : '‚Äî'}`;
          // Deep analytics for React card
          const txIds = txs.map(t => t.id || t.transaction_id).filter(Boolean);
          const itemsAll = preferIC ? await fetchICItemsByTransactionIds(txIds) : await fetchItemsByTransactionIds(txIds);
          const itemsByTx = new Map();
          (itemsAll || []).forEach(it => {
            const tid = it.transaction_id || it.tx_id || it.transactionId;
            if (!tid) return;
            const arr = itemsByTx.get(tid) || [];
            arr.push(it);
            itemsByTx.set(tid, arr);
          });
          // Average items per transaction by quantity
          const totalQty = txs.reduce((acc, t) => {
            const tid = t.id || t.transaction_id;
            const arr = itemsByTx.get(tid) || [];
            const q = arr.reduce((a,b)=> a + Number(b.quantity || b.qty || 1), 0);
            return acc + q;
          }, 0);
          const avgItemsPerTx = totalVisits ? (totalQty / totalVisits) : 0;
          // Category / brand / item stats
          const categoryKeywords = {
            'Flower': ['flower','bud','nug','pre-roll','pre roll','prepack'],
            'Edibles': ['gummy','chocolate','cookie','brownie','candy','chew'],
            'Concentrates': ['wax','shatter','crumble','hash','live resin','rosin'],
            'Vapes': ['vape','cartridge','cart','disposable','pod'],
            'Topicals': ['cream','lotion','salve','balm','ointment'],
            'Tinctures': ['tincture','drop','sublingual']
          };
          const categorySpend = Object.fromEntries(Object.keys(categoryKeywords).map(k => [k, {amount:0, count:0}]));
          const brandStats = new Map(); // brand -> {amount,count}
          const itemStats = new Map();  // name -> {amount,count,brand}
          (itemsAll || []).forEach(it => {
            const price = Number(it.total_price ?? it.price ?? 0) || 0;
            const brand = (it.brand || '').trim() || 'Unknown';
            const name = (it.product_name || it.product || 'Unknown').trim();
            const bs = brandStats.get(brand) || {amount:0,count:0};
            bs.amount += price; bs.count += 1; brandStats.set(brand, bs);
            const is = itemStats.get(name) || {amount:0,count:0,brand};
            is.amount += price; is.count += 1; is.brand = brand; itemStats.set(name, is);
            const lower = (it.category || it.product_name || '').toString().toLowerCase();
            for (const [cat, kws] of Object.entries(categoryKeywords)) {
              if (kws.some(kw => lower.includes(kw))) { categorySpend[cat].amount += price; categorySpend[cat].count += 1; break; }
            }
          });
          const topBrandsArr = Array.from(brandStats.entries()).sort((a,b)=>b[1].amount-a[1].amount).slice(0,5)
            .map(([name, v]) => ({name, amount:v.amount, count:v.count}));
          const topItemsArr = Array.from(itemStats.entries()).sort((a,b)=>b[1].amount-a[1].amount).slice(0,7)
            .map(([name, v]) => ({name, amount:v.amount, count:v.count, brand:v.brand}));
          // MOTA % per transaction (by spend)
          function motaPctForTx(tid) {
            const arr = itemsByTx.get(tid) || [];
            if (!arr.length) return 0;
            let total = 0, mota = 0;
            arr.forEach(x => {
              const val = Number(x.total_price ?? x.price ?? 0) || 0;
              total += val;
              const brand = (x.brand || '').toLowerCase();
              if (brand.includes('mota')) mota += val;
            });
            return total > 0 ? Math.round((mota/total)*100) : 0;
          }
          const recentArray = txs.slice(0,5).map(t => {
            const dsrc = t.date || t.created_at;
            const d = dsrc ? new Date(dsrc).toLocaleString() : '';
            const amt = Number(t.total_amount ?? t.total ?? 0);
            const seller = getSellerName(t.seller_id) || t.seller_name || '';
            const tid = t.id || t.transaction_id;
            return { when: d, amount: isNaN(amt)?null:amt, seller, mota: motaPctForTx(tid) };
          });
          visitsBlock = recentArray;
          // Visit Analytics (IC preferred)
          if (anl) {
            try {
              anl.textContent = buildVisitAnalyticsText(cust, txs, itemsAll);
              if (anlh) anlh.textContent = 'üìà Visit Analytics';
              const analyticsBox = document.getElementById('analyticsBox');
              if (analyticsBox) analyticsBox.style.display = 'none';
              // Render modern React card
              try {
                const monthly = computeMonthlyCounts(txs, 12);
                const root = ReactDOM.createRoot(reactRootEl);
                const ModernCard = ({ customer, metrics, monthlyData, last5, extras }) => {
                  const [visits, lifetime, avg, lastv] = (metrics||'||||').split('|');
                  const age = calculateAge(customer?.date_of_birth);
                  const vip = customer?.vip_status || '‚Äî';
                  const recency = (()=>{
                    const m = lastv && lastv.match(/\((\d+)d/);
                    const days = m ? parseInt(m[1],10) : null;
                    if (days==null) return '';
                    if (days <= 30) return 'üü¢ Active';
                    if (days <= 90) return 'üü° Recent';
                    return 'üî¥ Inactive';
                  })();
                  return React.createElement('div', {style:{display:'grid',gap:'10px'}},
                    React.createElement('div', {style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'10px'}},
                      React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                        React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Profile'),
                        React.createElement('div', null, `${customer?.name || 'Unknown'}`),
                        React.createElement('div', {className:'muted'}, `${age!=null? age+' yrs ‚Ä¢ ' + ageGroup(age) + ' ‚Ä¢ ' : ''}${customer?.is_medical ? 'Medical' : 'Recreational'}`),
                        React.createElement('div', {style:{marginTop:'6px'}}, `VIP: ${vip}`),
                        React.createElement('div', {className:'muted'}, recency || '')
                      ),
                      React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                        React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Key Stats'),
                        React.createElement('div', null, `Visits: ${visits||'‚Äî'}`),
                        React.createElement('div', null, `Lifetime: $${lifetime||'‚Äî'}`),
                        React.createElement('div', null, `Avg Ticket: $${avg||'‚Äî'}`),
                        React.createElement('div', {className:'muted'}, `Last Visit: ${lastv||'‚Äî'}`),
                        React.createElement('div', {className:'muted'}, `Visits/Month: ${extras?.visitsPerMonth ?? '‚Äî'}`)
                      ),
                    ),
                    React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                      React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Visits (last 12 months)'),
                      React.createElement('div', {style:{display:'grid',gridTemplateColumns:'repeat(12,1fr)',gap:'6px',alignItems:'end'}},
                        monthlyData.map((m,idx)=>React.createElement('div',{key:idx,style:{height:'80px',display:'flex',flexDirection:'column',justifyContent:'flex-end',alignItems:'center'}},
                          React.createElement('div',{style:{width:'100%',height:`${Math.max(4,Math.round(m.pct*70))}px`,background:'#22c55e',borderRadius:'4px'}}),
                          React.createElement('div',{style:{fontSize:'10px',color:'var(--muted)'}}, m.key.slice(2))
                        ))
                      )
                    ),
                    React.createElement('div', {style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'10px'}},
                      React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                        React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Purchase Habits'),
                        React.createElement('div', null, `Items/Transaction: ${extras?.avgItemsPerTx?.toFixed(1) ?? '‚Äî'}`),
                      ),
                      React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                        React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Contact'),
                        React.createElement('div', null, `Phone: ${customer?.phone || '‚Äî'}`),
                        React.createElement('div', null, `Email: ${customer?.email || '‚Äî'}`),
                        React.createElement('div', {className:'muted'}, `SMS: ${customer?.text_opt_in ? 'Yes' : 'No'}   Email: ${customer?.email_opt_in ? 'Yes' : 'No'}`),
                      ),
                    ),
                    React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                      React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Spending by Category'),
                      React.createElement('div', {style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px'}},
                        (extras?.categoryRows || []).map((r,idx)=>React.createElement('div',{key:idx},
                          `${r.name.padEnd(10,' ')} $${r.amount.toFixed(2)} (${r.count} items)`
                        ))
                      )
                    ),
                    React.createElement('div', {style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'10px'}},
                      React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                        React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Top 5 Brands by Spend'),
                        React.createElement('ol', {style:{margin:'0 0 0 18px'}},
                          (extras?.topBrands || []).map((b,idx)=>React.createElement('li',{key:idx},
                            `${b.name}  $${b.amount.toFixed(2)} (${b.count})`
                          ))
                        )
                      ),
                      React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                        React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Top 7 Purchased Items'),
                        React.createElement('ol', {style:{margin:'0 0 0 18px'}},
                          (extras?.topItems || []).map((it,idx)=>React.createElement('li',{key:idx,style:{marginBottom:'4px'}},
                            React.createElement('div', null, `${it.name} (${it.brand})`),
                            React.createElement('div', {className:'muted'}, `$${it.amount.toFixed(2)} ‚Ä¢ ${it.count} purchases`)
                          ))
                        )
                      )
                    ),
                    React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                      React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Recent Visits'),
                      React.createElement('ul', {style:{margin:0,paddingLeft:'16px'}},
                        (last5||[]).slice(0,5).map((v,idx)=>React.createElement('li',{key:idx,style:{marginBottom:'4px'}},
                          `${v.when || '‚Äî'}  ${v.amount!=null? '$'+v.amount.toFixed(2):''}  ${v.seller||''}  ${v.mota!=null? v.mota+'% MOTA':''}`
                        ))
                      )
                    ),
                    React.createElement('div', {className:'panel', style:{padding:'8px',border:'1px solid #1f2937',borderRadius:'8px',background:'#0b1220'}},
                      React.createElement('div', {className:'title', style:{marginBottom:'6px'}}, 'Timeline'),
                      React.createElement('div', null, `Member Since: ${customer?.date_joined ? String(customer.date_joined).slice(0,10) : '‚Äî'}`),
                      React.createElement('div', null, `Last Visit: ${lastDate ? lastDate.toISOString().slice(0,10) : '‚Äî'}`),
                    )
                  );
                };
                root.render(React.createElement(ModernCard, {
                  customer: cust,
                  metrics: metricsBlock,
                  monthlyData: monthly,
                  last5: recentArray,
                  extras: {
                    visitsPerMonth: (()=>{
                      const months = new Set((txs||[]).map(t=> monthKey(t.date || t.created_at)));
                      const n = months.size || 1;
                      return (totalVisits / n).toFixed(1);
                    })(),
                    avgItemsPerTx,
                    categoryRows: Object.entries(categorySpend).sort((a,b)=>b[1].amount - a[1].amount).map(([name,v])=>({name, amount:v.amount, count:v.count})),
                    topBrands: topBrandsArr,
                    topItems: topItemsArr
                  }
                }));
              } catch(e) {
                // Fallback silently if React render fails
              }
            } catch {
              anl.textContent = 'No analytics available.';
            }
          }
        }
      }
      // Fallback: message-based activity if transactions not available
      if (!metricsBlock) {
        try {
          const m = await sb.from('messages').select('direction,timestamp').eq('phone_number', phone).order('timestamp', { ascending:false }).limit(200);
          const msgs = m.data || [];
          const inCnt = msgs.filter(x=>x.direction==='inbound').length;
          const outCnt = msgs.filter(x=>x.direction==='outbound').length;
          const lastTs = msgs[0]?.timestamp ? new Date(msgs[0].timestamp) : null;
          const days = lastTs ? Math.floor((Date.now() - lastTs.getTime())/86400000) : '‚Äî';
          metricsBlock =
` 
Msgs In/Out : ${inCnt} / ${outCnt}
Last Msg    : ${ lastTs ? (lastTs.toLocaleString() + ' (' + days + 'd ago)') : '‚Äî'}
`;
        } catch {}
      }
      el.textContent = header + metricsBlock + visitsBlock;
    }
    // --- Audio helpers for incoming message beep ---
    function ensureAudio() {
      if (!audioCtx) {
        try {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (Ctx) {
            audioCtx = new Ctx();
          }
        } catch (e) {
          // likely blocked until first user gesture
        }
      }
    }
    function beep() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.value = 0.03;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => {
        try {
          gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
        } catch {}
      }, 80);
      setTimeout(() => {
        try { osc.stop(); } catch {}
        try { osc.disconnect(); } catch {}
        try { gain.disconnect(); } catch {}
      }, 220);
    }

    // Tabs
    function switchTab(tab) {
      activeTab = tab;
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      document.getElementById('replyTab').style.display = (tab === 'reply') ? '' : 'none';
      document.getElementById('allTab').style.display = (tab === 'all') ? '' : 'none';
      // Trigger load for the visible tab
      if (tab === 'reply') {
        loadConversations();
        if (currentPhone) loadThread(currentPhone);
      } else {
        loadAllMessages();
      }
    }

    // Data loading
    async function resolveContact(sb, phone) {
      if (contactCache.has(phone)) return contactCache.get(phone);
      const digits = last10(phone);
      // Budtender match by phone like %digits%
      try {
        let r = await sb.from('budtenders')
          .select('first_name,last_name,dispensary_name,phone')
          .ilike('phone', `%${digits}%`)
          .limit(1);
        if (r.data && r.data.length) {
          const b = r.data[0];
          const obj = {
            kind: 'BT',
            first_name: b.first_name || '',
            last_name: b.last_name || '',
            dispensary: b.dispensary_name || 'Unknown'
          };
          contactCache.set(phone, obj);
          return obj;
        }
      } catch {}
      // Customer match
      try {
        let r2 = await sb.from('customers_blaze')
          .select('first_name,last_name,name,phone,phone_number')
          .or(`phone.ilike.%${digits}%,phone_number.ilike.%${digits}%`)
          .limit(1);
        if (r2.data && r2.data.length) {
          const c = r2.data[0];
          const obj = {
            kind: 'CUST',
            first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
            last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
            dispensary: 'Customer'
          };
          contactCache.set(phone, obj);
          return obj;
        }
      } catch {}
      // Try primary CRM `customers` table in this project
      try {
        let rc = await sb.from('customers')
          .select('first_name,last_name,name,phone')
          .ilike('phone', `%${digits}%`)
          .limit(1);
        if (rc.data && rc.data.length) {
          const c = rc.data[0];
          const obj = {
            kind: 'CUST',
            first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
            last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
            dispensary: 'Customer'
          };
          contactCache.set(phone, obj);
          return obj;
        }
      } catch {}
      // Fallback 2: wildcard pattern that tolerates punctuation in phone e.g. (619) 555-1234
      try {
        const likePat = `%${digits.split('').join('%')}%`; // e.g. %6%1%9%‚Ä¶%
        const r3 = await sb.from('customers_blaze')
          .select('first_name,last_name,name,phone,phone_number')
          .or(`phone.ilike.${likePat},phone_number.ilike.${likePat}`)
          .limit(1);
        if (r3.data && r3.data.length) {
          const c = r3.data[0];
          const obj = {
            kind: 'CUST',
            first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
            last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
            dispensary: 'Customer'
          };
          contactCache.set(phone, obj);
          return obj;
        }
      } catch {}
      // Wildcard tolerant against `customers`
      try {
        const likePatC = `%${digits.split('').join('%')}%`;
        const r3c = await sb.from('customers')
          .select('first_name,last_name,name,phone')
          .ilike('phone', likePatC)
          .limit(1);
        if (r3c.data && r3c.data.length) {
          const c = r3c.data[0];
          const obj = {
            kind: 'CUST',
            first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
            last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
            dispensary: 'Customer'
          };
          contactCache.set(phone, obj);
          return obj;
        }
      } catch {}
      // Fallback 3: check optional IC database
      try {
        const sbIC = ensureClientIC();
        if (sbIC) {
          // direct simple match
          const rIC = await sbIC.from('customers_blaze')
            .select('first_name,last_name,name,phone,phone_number')
            .or(`phone.ilike.%${digits}%,phone_number.ilike.%${digits}%`)
            .limit(1);
          if (rIC.data && rIC.data.length) {
            const c = rIC.data[0];
            const obj = {
              kind: 'CUST',
              first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
              last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
              dispensary: 'Customer'
            };
            contactCache.set(phone, obj);
            return obj;
          }
          // wildcard tolerant
          const likePatIC = `%${digits.split('').join('%')}%`;
          const rIC2 = await sbIC.from('customers_blaze')
            .select('first_name,last_name,name,phone,phone_number')
            .or(`phone.ilike.${likePatIC},phone_number.ilike.${likePatIC}`)
            .limit(1);
          if (rIC2.data && rIC2.data.length) {
            const c = rIC2.data[0];
            const obj = {
              kind: 'CUST',
              first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
              last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
              dispensary: 'Customer'
            };
            contactCache.set(phone, obj);
            return obj;
          }
          // Optional additional table name
          try {
            const rIC3 = await sbIC.from('customers')
              .select('first_name,last_name,name,phone,phone_number')
              .or(`phone.ilike.%${digits}%,phone_number.ilike.%${digits}%`)
              .limit(1);
            if (rIC3.data && rIC3.data.length) {
              const c = rIC3.data[0];
              const obj = {
                kind: 'CUST',
                first_name: (c.first_name || (c.name || '').split(' ')[0] || '').trim(),
                last_name: (c.last_name || (c.name || '').split(' ').slice(1).join(' ') || '').trim(),
                dispensary: 'Customer'
              };
              contactCache.set(phone, obj);
              return obj;
            }
          } catch {}
        }
      } catch {}
      const obj = { kind: 'NONE', first_name: '', last_name: '', dispensary: 'no match' };
      contactCache.set(phone, obj);
      return obj;
    }

    async function loadConversations() {
      try {
        const sb = ensureClient();
        // Fetch latest 1000 messages and reduce to conversation heads
        const { data, error } = await sb
          .from('messages')
          .select('id,phone_number,content,direction,status,timestamp')
          .order('timestamp', { ascending: false })
          .limit(1000);
        if (error) throw error;
        // determine latest inbound timestamp for notification
        let maxInboundTs = 0;
        (data || []).forEach(m => {
          if (m.direction === 'inbound') {
            const t = Date.parse(m.timestamp) || 0;
            if (t > maxInboundTs) maxInboundTs = t;
          }
        });
        // Build helper sets for quick filters
        const [inRes, unRes] = await Promise.all([
          sb.from('messages').select('phone_number').eq('direction','inbound').order('timestamp', { ascending:false }).limit(1000),
          sb.from('messages').select('phone_number').eq('direction','inbound').eq('status','unread').order('timestamp', { ascending:false }).limit(1000),
        ]);
        inboundSet = new Set((inRes.data || []).map(x => x.phone_number));
        unreadSet = new Set((unRes.data || []).map(x => x.phone_number));
        const map = new Map(); // phone -> summary
        (data || []).forEach(m => {
          const phone = m.phone_number;
          const preview = decodeHexUCS2(m.content || '');
          if (!map.has(phone)) {
            map.set(phone, {
              ...m,
              content: preview,
              hasIn: inboundSet.has(phone),
              hasUnread: unreadSet.has(phone),
              inCount: 0,
              outCount: 0
            });
          }
          const obj = map.get(phone);
          if (m.direction === 'inbound') obj.inCount++;
          else obj.outCount++;
        });
        conversations = Array.from(map.values());
        // Resolve contacts (best-effort)
        await Promise.all(conversations.map(c => resolveContact(sb, c.phone_number)));
        renderConversations(conversations);
        setLastRefresh();
        // fire audio notification on new inbound (skip first baseline)
        if (maxInboundTs > 0) {
          if (!inboundInit) {
            inboundInit = true;
            lastInboundSeenTs = maxInboundTs;
          } else if (maxInboundTs > lastInboundSeenTs) {
            lastInboundSeenTs = maxInboundTs;
            beep();
          }
        }
        updateConversationHeader();
      } catch (e) {
        console.error(e);
        alert('Failed to load conversations: ' + e.message);
      }
    }
    function renderConversations(list) {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      const tbody = document.querySelector('#convTable tbody');
      tbody.innerHTML = '';
      let shown = 0;
      list.forEach(item => {
        // Filter mode
        if (filterMode === 'hasIn' && !item.hasIn) return;
        if (filterMode === 'hasUnread' && !item.hasUnread) return;
        if (hideSingleOut && item.inCount === 0 && item.outCount === 1) return;
        const text = (item.phone_number + ' ' + (item.content || '')).toLowerCase();
        if (q && !text.includes(q)) return;
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => {
          currentPhone = item.phone_number;
          document.getElementById('replyPhone').value = normalizePhone(currentPhone);
          loadThread(currentPhone);
          updateConversationHeader();
        loadBaseballCardByPhone(currentPhone);
        });
        const inBadge = item.hasIn ? '<span class="pill inbound">IN</span>' : '';
        const unreadBadge = item.hasUnread ? '<span class="pill unread">UNREAD</span>' : '';
        const dirPill = (item.direction === 'inbound') ? '<span class="pill inbound">IN</span>' : '<span class="pill outbound">OUT</span>';
        const contact = contactCache.get(item.phone_number) || {kind:'',first_name:'',last_name:'',dispensary:''};
        const name = (contact.first_name || contact.last_name) ? `${contact.first_name} ${contact.last_name}`.trim() : 'Unknown';
        const role = contact.kind === 'BT' ? '<span class="pill outbound">BT</span>' :
                     contact.kind === 'CUST' ? '<span class="pill sent">CUST</span>' :
                     '<span class="pill read">NO MATCH</span>';
        const total = (item.inCount || 0) + (item.outCount || 0);
        tr.innerHTML = `
          <td class="nowrap"><strong>${item.phone_number}</strong><div class="muted">${name} ${role}</div></td>
          <td class="nowrap cnt"><span class="pill read">${total}</span></td>
          <td class="nowrap">${contact.dispensary || '‚Äî'}</td>
          <td class="nowrap">${fmtTime(item.timestamp)}<div class="muted" style="margin-top:2px;">${dirPill} ${inBadge} ${unreadBadge}</div></td>
          <td>${(item.content || '').replace(/\s+/g,' ').slice(0,80)}</td>
        `;
        tbody.appendChild(tr);
        shown++;
      });
      document.getElementById('convCount').textContent = shown + ' conversations';
    }

    async function loadThread(phone) {
      try {
        const sb = ensureClient();
        const { data, error } = await sb
          .from('messages')
          .select('id,content,direction,status,timestamp')
          .eq('phone_number', phone)
          .order('timestamp', { ascending: true })
          .limit(500);
        if (error) throw error;
        const tbody = document.querySelector('#threadTable tbody');
        tbody.innerHTML = '';
        (data || []).forEach(m => {
          const pillDir = (m.direction === 'inbound') ? 'inbound' : 'outbound';
          const pillStatus = (m.status || '').toLowerCase();
          const pill = `<span class="pill ${pillDir}">${m.direction.toUpperCase()}</span>`;
          const sp = pillStatus ? `<span class="pill ${pillStatus}">${(m.status || '').toUpperCase()}</span>` : '';
          const tr = document.createElement('tr');
          const compact = decodeHexUCS2(m.content || '').replace(/\r\n/g,'\n').replace(/\n{2,}/g,'\n').trim().replace(/\n/g,'<br>');
          tr.innerHTML = `
            <td class="nowrap">${fmtTime(m.timestamp)}</td>
            <td class="nowrap">${pill}</td>
            <td class="nowrap">${sp}</td>
            <td class="msg">${compact}</td>
          `;
          tbody.appendChild(tr);
        });
        setLastRefresh();
      } catch (e) {
        console.error(e);
        alert('Failed to load thread: ' + e.message);
      }
    }

    async function loadAllMessages() {
      try {
        const sb = ensureClient();
        const { data, error } = await sb
          .from('messages')
          .select('phone_number,content,direction,status,timestamp')
          .order('timestamp', { ascending: false })
          .limit(1000);
        if (error) throw error;
        let maxInboundTs = 0;
        (data || []).forEach(m => {
          if (m.direction === 'inbound') {
            const t = Date.parse(m.timestamp) || 0;
            if (t > maxInboundTs) maxInboundTs = t;
          }
        });
        const tbody = document.querySelector('#allTable tbody');
        tbody.innerHTML = '';
        (data || []).forEach(m => {
          const pillDir = (m.direction === 'inbound') ? 'inbound' : 'outbound';
          const pillStatus = (m.status || '').toLowerCase();
          const tr = document.createElement('tr');
          tr.classList.add('clickable');
          tr.addEventListener('click', () => {
            currentPhone = m.phone_number;
            document.getElementById('replyPhone').value = normalizePhone(currentPhone);
            switchTab('reply');
            loadThread(currentPhone);
            updateConversationHeader();
            loadBaseballCardByPhone(currentPhone);
          });
          const compact = decodeHexUCS2(m.content || '').replace(/\r\n/g,'\n').replace(/\n{2,}/g,'\n').trim().replace(/\n/g,'<br>');
          tr.innerHTML = `
            <td class="nowrap">${fmtTime(m.timestamp)}</td>
            <td class="nowrap">${m.phone_number}</td>
            <td class="nowrap"><span class="pill ${pillDir}">${m.direction.toUpperCase()}</span></td>
            <td class="nowrap"><span class="pill ${pillStatus}">${(m.status || '').toUpperCase()}</span></td>
            <td class="msg">${compact}</td>
          `;
          tbody.appendChild(tr);
        });
        setLastRefresh();
        if (maxInboundTs > 0) {
          if (!inboundInit) {
            inboundInit = true;
            lastInboundSeenTs = maxInboundTs;
          } else if (maxInboundTs > lastInboundSeenTs) {
            lastInboundSeenTs = maxInboundTs;
            beep();
          }
        }
      } catch (e) {
        console.error(e);
        alert('Failed to load messages: ' + e.message);
      }
    }

    // Actions
    async function markRead() {
      if (!currentPhone) {
        alert('Select a conversation first.');
        return;
      }
      if (!confirm('Mark all inbound unread messages for this phone as read?')) return;
      try {
        const sb = ensureClient();
        const { error } = await sb
          .from('messages')
          .update({ status: 'read' })
          .eq('phone_number', currentPhone)
          .eq('direction', 'inbound')
          .eq('status', 'unread');
        if (error) throw error;
        await loadThread(currentPhone);
        await loadConversations();
        alert('Marked as read.');
      } catch (e) {
        console.error(e);
        alert('Failed to mark read: ' + e.message);
      }
    }

    function updateCharCount() {
      const txt = document.getElementById('replyText').value || '';
      document.getElementById('charCount').textContent = `${txt.length} / 160`;
    }

    async function sendNow() {
      let phone = (document.getElementById('replyPhone').value || '').trim();
      const content = (document.getElementById('replyText').value || '').trim();
      if (!phone || !content) { alert('Phone and message are required.'); return; }
      phone = normalizePhone(phone);
      try {
        const sb = ensureClient();
        // Split by [BUBBLE]
        let bubbles = content.split('[BUBBLE]').map(s => s.trim()).filter(Boolean);
        if (bubbles.length === 0) bubbles = [content];
        for (const b of bubbles) {
          const { error } = await sb
            .from('messages')
            .insert({
              phone_number: phone,
              content: b,
              direction: 'outbound',
              status: 'queued',
              timestamp: new Date().toISOString(),
            });
          if (error) throw error;
        }
        alert(`Queued ${bubbles.length} SMS bubble(s). Conductor will send shortly.`);
        document.getElementById('replyText').value = '';
        updateCharCount();
        await loadThread(phone);
        await loadConversations();
      } catch (e) {
        console.error(e);
        alert('Failed to queue: ' + e.message);
      }
    }

    // Live mode
    function startLive() {
      stopLive();
      liveTimer = setInterval(() => {
        if (activeTab === 'reply') {
          loadConversations();
          if (currentPhone) loadThread(currentPhone);
        } else {
          loadAllMessages();
        }
      }, 15000);
    }
    function stopLive() {
      if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
    }

    // Events
    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => switchTab(t.dataset.tab));
    });
    // Collapsible sections (Baseball Card / Analytics)
    let cardCollapsed = false;
    let analyticsCollapsed = false;
    function setCollapsed(elBoxId, btnId, collapsed) {
      const box = document.getElementById(elBoxId);
      const btn = document.getElementById(btnId);
      if (!box || !btn) return;
      if (collapsed) {
        box.style.display = 'none';
        btn.textContent = '‚ñ∂';
      } else {
        box.style.display = '';
        btn.textContent = '‚ñº';
      }
    }
    const cardBtn = document.getElementById('cardToggle');
    if (cardBtn) {
      cardBtn.addEventListener('click', () => {
        cardCollapsed = !cardCollapsed;
        setCollapsed('cardBox', 'cardToggle', cardCollapsed);
      });
    }
    const analyticsBtn = document.getElementById('analyticsToggle');
    if (analyticsBtn) {
      analyticsBtn.addEventListener('click', () => {
        analyticsCollapsed = !analyticsCollapsed;
        setCollapsed('analyticsBox', 'analyticsToggle', analyticsCollapsed);
      });
    }
    // Horizontal collapse for entire right column
    const rightPanel = document.querySelector('.right');
    const toggleRightBtn = document.getElementById('toggleRightBtn');
    if (toggleRightBtn && rightPanel) {
      toggleRightBtn.addEventListener('click', () => {
        const isCollapsed = rightPanel.classList.toggle('collapsed');
        toggleRightBtn.textContent = isCollapsed ? 'Show Right Panel' : 'Hide Right Panel';
      });
    }
    // Toggle right width size
    const rightSizeBtn = document.getElementById('rightSizeBtn');
    if (rightSizeBtn && rightPanel) {
      let sizeMode = 'default'; // default | narrow | wide
      const applySize = () => {
        rightPanel.classList.remove('narrow','wide');
        if (sizeMode === 'narrow') {
          rightPanel.classList.add('narrow');
          rightSizeBtn.textContent = 'Right: Narrow';
        } else if (sizeMode === 'wide') {
          rightPanel.classList.add('wide');
          rightSizeBtn.textContent = 'Right: Wide';
        } else {
          rightSizeBtn.textContent = 'Right: Default';
        }
      };
      rightSizeBtn.addEventListener('click', () => {
        sizeMode = (sizeMode === 'default') ? 'narrow' : (sizeMode === 'narrow') ? 'wide' : 'default';
        applySize();
      });
      applySize();
    }
    document.getElementById('reloadConvsBtn').addEventListener('click', loadConversations);
    document.getElementById('refreshBtn').addEventListener('click', () => {
      if (activeTab === 'reply') {
        loadConversations();
        if (currentPhone) loadThread(currentPhone);
      } else {
        loadAllMessages();
      }
    });
    document.getElementById('markReadBtn').addEventListener('click', markRead);
    document.getElementById('sendNow').addEventListener('click', sendNow);
    document.getElementById('clearReply').addEventListener('click', () => {
      document.getElementById('replyText').value = '';
      updateCharCount();
    });
    document.getElementById('replyText').addEventListener('input', updateCharCount);
    document.getElementById('clearSearch').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      renderConversations(conversations);
    });
    document.getElementById('searchInput').addEventListener('input', () => renderConversations(conversations));
    document.getElementById('liveToggle').addEventListener('change', (e) => {
      if (e.target.checked) startLive(); else stopLive();
    });
    // Quick filters
    document.getElementById('fltAll').addEventListener('click', () => { filterMode='all'; renderConversations(conversations); });
    document.getElementById('fltHasIn').addEventListener('click', () => { filterMode='hasIn'; renderConversations(conversations); });
    document.getElementById('fltUnread').addEventListener('click', () => { filterMode='hasUnread'; renderConversations(conversations); });
    document.getElementById('hideSingleOut').addEventListener('change', (e) => { hideSingleOut = e.target.checked; renderConversations(conversations); });
    // Keyboard hotkeys: a = all, i = has in, u = has unread
    window.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) || '';
      if (tag === 'INPUT' || tag === 'TEXTAREA') return;
      if (e.key === 'a' || e.key === 'A') { filterMode='all'; renderConversations(conversations); }
      if (e.key === 'i' || e.key === 'I') { filterMode='hasIn'; renderConversations(conversations); }
      if (e.key === 'u' || e.key === 'U') { filterMode='hasUnread'; renderConversations(conversations); }
    });

    // Startup
    (function init() {
      // default tab
      switchTab('reply');
      // start live refresh by default
      const lt = document.getElementById('liveToggle');
      if (lt) { lt.checked = true; }
      startLive();
      // prime audio after first user gesture
      window.addEventListener('click', ensureAudio, { once: true });
      // preload staff map for seller name resolution
      loadStaffMap();
    })();
  </script>
</body>
</html>


