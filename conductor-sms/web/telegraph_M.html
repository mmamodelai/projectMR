<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Telegraph Mobile (Prototype)</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0%' stop-color='%231c2541'/>
              <stop offset='100%' stop-color='%230b1220'/>
            </linearGradient>
          </defs>
          <rect width='100' height='100' rx='18' ry='18' fill='url(%23g)'/>
          <text x='50' y='68' font-size='64' text-anchor='middle'>ðŸ“¨</text>
        </svg>">
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --blue:#3b82f6; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family: -apple-system, Segoe UI, Roboto, Arial; }
    header { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0b1220; border-bottom:1px solid #1f2937; }
    header h1 { margin:0; font-size:16px; }
    .btn { background:#1f2937; border:1px solid #293241; color:var(--text); padding:8px 12px; border-radius:10px; font-weight:600; }
    .btn.primary { background: var(--blue); border-color:#2563eb; }
    .screen { height: calc(100% - 52px); }
    #listView, #threadView { display: none; height:100%; }
    .show { display:block; }
    .panel { height:100%; display:flex; flex-direction:column; padding:10px; }
    .title { font-weight:700; font-size:14px; margin-bottom:8px; }
    input[type="search"] { width:100%; background:#0b1220; border:1px solid #1f2937; border-radius:10px; color:var(--text); padding:10px; }
    .row { display:flex; gap:8px; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; }
    .in { background:#0ea5e9; color:#081018; }
    .unread { background:#ef4444; color:#081018; }
    .list { overflow:auto; flex:1; border:1px solid #1f2937; border-radius:10px; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td { padding:10px; border-bottom:1px solid #1f2937; }
    th { position:sticky; top:0; background:#0b1220; }
    textarea { width:100%; min-height:120px; background:#0b1220; border:1px solid #1f2937; border-radius:10px; color:var(--text); padding:10px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .muted { color: var(--muted); }
  </style>
  <script src="telegraph_mobile_config.js"></script>
  <script>
    // Embed defaults so mobile never prompts
    window.TELEGRAPH_SUPABASE = window.TELEGRAPH_SUPABASE || {
      url: "https://kiwmwoqrguyrcpjytgte.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpd213b3FyZ3V5cmNwanl0Z3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDUwNTEsImV4cCI6MjA3NTQyMTA1MX0.3YhobdFv0ZV6PzExcr88l-zNN3vZeEsM_Du9kVEmdV0"
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Telegraph Mobile</h1>
    <div></div>
  </header>
  <div class="screen">
    <div id="err" style="display:none;background:#7f1d1d;color:#fff;padding:8px 12px;">Error</div>
    <!-- List view -->
    <section id="listView" class="panel show">
      <div class="topbar">
        <div class="title">All Messages</div>
        <label class="row"><input type="checkbox" id="hideOut" checked> <span class="muted">Hide single OUT</span></label>
      </div>
      <div class="row" style="margin-bottom:8px;">
        <input id="q" type="search" placeholder="Search phone or text...">
        <button id="fltA" class="btn">All</button>
        <button id="fltI" class="btn">Has IN</button>
        <button id="fltU" class="btn">Unread</button>
      </div>
      <div class="list">
        <table id="tbl">
          <thead><tr><th>Contact</th><th>Last</th><th>Disp</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <!-- Thread view -->
    <section id="threadView" class="panel">
      <div class="topbar">
        <button id="backBtn" class="btn">â—€ Back</button>
        <div class="title" id="thTitle">Conversation</div>
      </div>
      <div class="list" style="height:45%;">
        <table id="thread">
          <thead><tr><th>Time</th><th>Dir</th><th>Status</th><th>Message</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="title" id="thReply">Your Reply</div>
      <input id="to" type="text" placeholder="+16199773020" class="muted" style="background:#0b1220;border:1px solid #1f2937;border-radius:10px;color:var(--text);padding:8px;margin-bottom:8px;">
      <textarea id="msg" placeholder="Type your message... Use [BUBBLE] to split into multiple SMS."></textarea>
      <div class="row" style="justify-content: flex-end; margin-top:8px;">
        <button id="send" class="btn" style="background:var(--accent); border-color:#16a34a; color:#081018;">SEND</button>
      </div>
    </section>
  </div>
  <script>
    // Shared bits from desktop pared down
    let sb=null;
    function client(){
      const u = window.TELEGRAPH_SUPABASE && window.TELEGRAPH_SUPABASE.url;
      const k = window.TELEGRAPH_SUPABASE && window.TELEGRAPH_SUPABASE.key;
      if (!sb) sb = window.supabase.createClient(u, k, { auth: { persistSession: false }});
      return sb;
    }
    function hexDecode(s){ if(!s||typeof s!=='string') return s; const c=s.replace(/\s+/g,''); if(!/^[0-9a-fA-F]+$/.test(c)||c.length%4||c.length<16) return s; try{ const b=new Uint8Array(c.length/2); for(let i=0;i<c.length;i+=2)b[i/2]=parseInt(c.slice(i,i+2),16); let out=''; for(let i=0;i<b.length;i+=2){ out+=String.fromCharCode((b[i]<<8)|b[i+1]); } return out; }catch{return s;} }
    const cache = new Map();
    function last10(p){ return (''+p).replace(/\D+/g,'').slice(-10); }
    async function resolve(phone){
      if(cache.has(phone)) return cache.get(phone);
      try{
        const d=await client().from('budtenders').select('first_name,last_name,dispensary_name,phone').ilike('phone', `%${last10(phone)}%`).limit(1);
        if(d.data&&d.data.length){ const b=d.data[0]; const r={kind:'BT',first:b.first_name||'',last:b.last_name||'',disp:b.dispensary_name||'Unknown'}; cache.set(phone,r); return r; }
      }catch{}
      try{
        const c=await client().from('customers_blaze').select('first_name,last_name,name,phone,phone_number').or(`phone.ilike.%${last10(phone)}%,phone_number.ilike.%${last10(phone)}%`).limit(1);
        if(c.data&&c.data.length){ const x=c.data[0]; const r={kind:'CUST',first:(x.first_name||(x.name||'').split(' ')[0]||'').trim(),last:(x.last_name||(x.name||'').split(' ').slice(1).join(' ')||'').trim(),disp:'Customer'}; cache.set(phone,r); return r; }
      }catch{}
      const r={kind:'NONE',first:'',last:'',disp:'no match'}; cache.set(phone,r); return r;
    }
    let rows=[], filter='all', hideOut=true, current=null;
    async function loadList(){
      const c=client();
      const m = await c.from('messages').select('phone_number,content,direction,status,timestamp').order('timestamp',{ascending:false}).limit(1000);
      const inSet = new Set((await c.from('messages').select('phone_number').eq('direction','inbound').limit(1000)).data?.map(x=>x.phone_number)||[]);
      const unSet = new Set((await c.from('messages').select('phone_number').eq('direction','inbound').eq('status','unread').limit(1000)).data?.map(x=>x.phone_number)||[]);
      const map=new Map();
      (m.data||[]).forEach(it=>{
        const phone=it.phone_number;
        const text=hexDecode(it.content||'');
        if(!map.has(phone)) map.set(phone,{...it,content:text,inCount:0,outCount:0,hasIn:inSet.has(phone),hasUnread:unSet.has(phone)});
        const obj=map.get(phone);
        if(it.direction==='inbound') obj.inCount++; else obj.outCount++;
      });
      rows=Array.from(map.values());
      await Promise.all(rows.map(r=>resolve(r.phone_number)));
      renderList();
    }
    function renderList(){
      const q=(document.getElementById('q').value||'').toLowerCase();
      const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
      rows.forEach(r=>{
        if(filter==='hasIn'&&!r.hasIn) return;
        if(filter==='unread'&&!r.hasUnread) return;
        if(hideOut&&r.inCount===0&&r.outCount===1) return;
        const c=cache.get(r.phone_number)||{};
        const name = (c.first||c.last) ? `${c.first||''} ${c.last||''}`.trim() : 'Unknown';
        const row=document.createElement('tr'); row.style.cursor='pointer';
        if(q && !(r.phone_number+name+(c.disp||'')+(r.content||'')).toLowerCase().includes(q)) return;
        row.addEventListener('click', ()=>openThread(r.phone_number));
        row.innerHTML = `<td><strong>${r.phone_number}</strong><div class="muted">${name} â€¢ ${c.kind||''}</div></td><td>${new Date(r.timestamp).toLocaleString()}<div>${r.hasIn?'<span class="pill in">IN</span>':''} ${r.hasUnread?'<span class="pill unread">UNREAD</span>':''}</div></td><td>${c.disp||'â€”'}</td>`;
        tb.appendChild(row);
      });
    }
    async function openThread(phone){
      current=phone;
      document.getElementById('listView').classList.remove('show');
      document.getElementById('threadView').classList.add('show');
      document.getElementById('to').value = phone;
      const c=cache.get(phone)||{};
      const title = (c.first||c.last) ? `${c.first||''} ${c.last||''}`.trim() : '';
      document.getElementById('thTitle').textContent = title ? `Conversation â€” ${title} â€¢ ${c.kind||''} â€¢ ${c.disp||''}` : 'Conversation';
      document.getElementById('thReply').textContent = title ? `Your Reply â€” ${title}` : 'Your Reply';
      const m = await client().from('messages').select('content,direction,status,timestamp').eq('phone_number', phone).order('timestamp',{ascending:true}).limit(500);
      const tb=document.querySelector('#thread tbody'); tb.innerHTML='';
      (m.data||[]).forEach(x=>{
        const tr=document.createElement('tr');
        const msg = hexDecode(x.content||'').replace(/\n/g,'<br>');
        tr.innerHTML = `<td>${new Date(x.timestamp).toLocaleString()}</td><td>${x.direction.toUpperCase()}</td><td>${(x.status||'').toUpperCase()}</td><td>${msg}</td>`;
        tb.appendChild(tr);
      });
    }
    async function send(){
      const phone=document.getElementById('to').value.trim(); const content=document.getElementById('msg').value.trim();
      if(!phone||!content) return alert('Phone and message required');
      let parts=content.split('[BUBBLE]').map(s=>s.trim()).filter(Boolean); if(parts.length===0) parts=[content];
      for(const b of parts){
        const {error}=await client().from('messages').insert({phone_number:phone,content:b,direction:'outbound',status:'queued',timestamp:new Date().toISOString()}); if(error) return alert(error.message);
      }
      alert(`Queued ${parts.length} message(s).`);
      document.getElementById('msg').value='';
      openThread(phone);
    }
    // Events
    document.getElementById('backBtn').onclick=()=>{ document.getElementById('threadView').classList.remove('show'); document.getElementById('listView').classList.add('show'); };
    document.getElementById('send').onclick=send;
    document.getElementById('fltA').onclick=()=>{ filter='all'; renderList(); };
    document.getElementById('fltI').onclick=()=>{ filter='hasIn'; renderList(); };
    document.getElementById('fltU').onclick=()=>{ filter='unread'; renderList(); };
    document.getElementById('hideOut').onchange=(e)=>{ hideOut=e.target.checked; renderList(); };
    document.getElementById('q').oninput=renderList;
    // Init
    (async function(){
      try{
        await loadList();
      }catch(e){
        const el=document.getElementById('err');
        if(el){ el.textContent = 'Load error: '+ (e && e.message ? e.message : e); el.style.display='block'; }
        else { alert(e && e.message ? e.message : e); }
      }
    })();
  </script>
</body>
</html>


